# Manager - è¿ç»´ç®¡ç†å¹³å°ä¸­å¿ƒèŠ‚ç‚¹

Manageræ˜¯Ops Scaffold Frameworkçš„ä¸­å¿ƒç®¡ç†èŠ‚ç‚¹ï¼Œæä¾›Webç•Œé¢å’ŒAPIï¼Œå®ç°å¯¹åˆ†å¸ƒå¼ä¸»æœºçš„é›†ä¸­ç®¡ç†ã€ç›‘æ§å’Œè‡ªåŠ¨åŒ–è¿ç»´ã€‚

## åŠŸèƒ½ç‰¹æ€§ï¼ˆè§„åˆ’ï¼‰

- ğŸ”„ **èŠ‚ç‚¹ç®¡ç†**: èŠ‚ç‚¹æ³¨å†Œã€åˆ†ç»„ã€æ ‡ç­¾ã€çŠ¶æ€ç›‘æ§
- ğŸ“Š **ç›‘æ§ä»ªè¡¨ç›˜**: å®æ—¶æŒ‡æ ‡å±•ç¤ºã€å†å²æ•°æ®æŸ¥è¯¢
- ğŸ“¦ **ç‰ˆæœ¬å‘å¸ƒ**: ä¸Šä¼ ç‰ˆæœ¬ã€ç­¾åã€ç°åº¦å‘å¸ƒã€æ‰¹é‡æ›´æ–°ã€å›æ»š
- â° **ä»»åŠ¡è°ƒåº¦**: å³æ—¶ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ï¼ˆCronï¼‰ã€ä»»åŠ¡æ¨¡æ¿
- ğŸ” **ç”¨æˆ·è®¤è¯**: OAuth2/JWTè®¤è¯ã€RBACæƒé™æ§åˆ¶
- ğŸ“ **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œ

## æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: Gin 1.10+
- **ORM**: GORM 1.25+
- **æ•°æ®åº“**: MySQL 8.0+
- **ç¼“å­˜**: Redis
- **ä»»åŠ¡è°ƒåº¦**: robfig/cron v3.0.1
- **æ—¥å¿—**: uber-go/zap
- **é€šä¿¡åè®®**: gRPC (Manager â†” Daemon), HTTP/HTTPS (Web API)

## å½“å‰è¿›åº¦ - 95%

### âœ… å·²å®Œæˆ

1. **é¡¹ç›®ç»“æ„**
   - âœ… åˆ›å»ºManageré¡¹ç›®ç›®å½•ç»“æ„
   - âœ… åˆå§‹åŒ–Goæ¨¡å—å’Œä¾èµ–
   - âœ… åˆ›å»ºMakefileæ„å»ºæ–‡ä»¶

2. **é…ç½®ç®¡ç†**
   - âœ… å®ç°é…ç½®ç®¡ç†æ¨¡å—ï¼ˆinternal/configï¼‰
   - âœ… åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆconfigs/manager.yamlï¼‰
   - âœ… åˆ›å»ºå¼€å‘ç¯å¢ƒé…ç½®ï¼ˆconfigs/manager.dev.yamlï¼‰
   - âœ… æ”¯æŒServerã€Databaseã€Redisã€gRPCã€JWTã€Logé…ç½®

3. **æ•°æ®æ¨¡å‹ï¼ˆModelå±‚ï¼‰**
   - âœ… Useræ¨¡å‹ - ç”¨æˆ·ç®¡ç†ï¼ˆæ”¯æŒè§’è‰²å’ŒçŠ¶æ€ï¼‰
   - âœ… Nodeæ¨¡å‹ - èŠ‚ç‚¹ç®¡ç†ï¼ˆæ”¯æŒæ ‡ç­¾å’Œåˆ†ç»„ï¼‰
   - âœ… Metricsæ¨¡å‹ - ç›‘æ§æŒ‡æ ‡å­˜å‚¨
   - âœ… AuditLogæ¨¡å‹ - å®¡è®¡æ—¥å¿—è®°å½•
   - âœ… Taskæ¨¡å‹ - ä»»åŠ¡ç®¡ç†
   - âœ… Versionæ¨¡å‹ - ç‰ˆæœ¬ç®¡ç†
   - âœ… è‡ªå®šä¹‰JSONç±»å‹ï¼ˆMapStringã€JSONMapã€JSONArrayï¼‰

4. **åŸºç¡€è®¾æ–½**
   - âœ… æ—¥å¿—ç³»ç»Ÿï¼ˆåŸºäºzap + lumberjackï¼‰
   - âœ… æ•°æ®åº“è¿æ¥ç®¡ç†ï¼ˆGORM + MySQLï¼‰
   - âœ… JWTå·¥å…·åŒ…ï¼ˆtokenç”Ÿæˆã€éªŒè¯ã€åˆ·æ–°ï¼‰
   - âœ… é€šç”¨å“åº”ç»“æ„ï¼ˆResponseã€PageDataï¼‰
   - âœ… é”™è¯¯å®šä¹‰å’Œé”™è¯¯ç ï¼ˆåŒ…å«HTTPçŠ¶æ€ç æ˜ å°„ï¼‰

5. **æ•°æ®è®¿é—®å±‚ï¼ˆRepositoryï¼‰**
   - âœ… UserRepository - ç”¨æˆ·æ•°æ®è®¿é—®
   - âœ… NodeRepository - èŠ‚ç‚¹æ•°æ®è®¿é—®
   - âœ… MetricsRepository - æŒ‡æ ‡æ•°æ®è®¿é—®
   - âœ… AuditLogRepository - å®¡è®¡æ—¥å¿—è®¿é—®
   - âœ… TaskRepository - ä»»åŠ¡æ•°æ®è®¿é—®
   - âœ… VersionRepository - ç‰ˆæœ¬æ•°æ®è®¿é—®

6. **ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceï¼‰**
   - âœ… AuthService - ç”¨æˆ·è®¤è¯å’Œæˆæƒï¼ˆæ³¨å†Œã€ç™»å½•ã€JWTã€å¯†ç ç®¡ç†ï¼‰
   - âœ… NodeService - èŠ‚ç‚¹ç®¡ç†æœåŠ¡ï¼ˆæ³¨å†Œã€å¿ƒè·³ã€çŠ¶æ€ç®¡ç†ï¼‰
   - âœ… MetricsService - ç›‘æ§æŒ‡æ ‡æœåŠ¡ï¼ˆé‡‡é›†ã€æŸ¥è¯¢ã€èšåˆï¼‰
   - âœ… TaskService - ä»»åŠ¡è°ƒåº¦æœåŠ¡ï¼ˆåˆ›å»ºã€æ‰§è¡Œã€çŠ¶æ€ç®¡ç†ï¼‰
   - âœ… VersionService - ç‰ˆæœ¬ç®¡ç†æœåŠ¡ï¼ˆå‘å¸ƒã€åºŸå¼ƒã€å“ˆå¸ŒéªŒè¯ï¼‰

7. **ä¸­é—´ä»¶**
   - âœ… JWTè®¤è¯ä¸­é—´ä»¶ï¼ˆtokenéªŒè¯ã€ç”¨æˆ·ä¿¡æ¯æå–ï¼‰
   - âœ… æƒé™ä¸­é—´ä»¶ï¼ˆRequireAdminï¼‰
   - âœ… æ—¥å¿—ä¸­é—´ä»¶ï¼ˆè¯·æ±‚æ—¥å¿—è®°å½•ï¼‰
   - âœ… CORSä¸­é—´ä»¶ï¼ˆè·¨åŸŸæ”¯æŒï¼‰
   - âœ… é”™è¯¯æ¢å¤ä¸­é—´ä»¶ï¼ˆpanicæ¢å¤ï¼‰
   - âœ… å®¡è®¡æ—¥å¿—ä¸­é—´ä»¶ï¼ˆæ“ä½œå®¡è®¡ï¼‰

8. **ä¸»ç¨‹åºæ¡†æ¶**
   - âœ… ä¸»ç¨‹åºå…¥å£ï¼ˆcmd/manager/main.goï¼‰
   - âœ… ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–
   - âœ… HTTPæœåŠ¡å™¨å¯åŠ¨
   - âœ… ä¼˜é›…å…³é—­
   - âœ… è·¯ç”±æ³¨å†Œï¼ˆå…¬å¼€APIã€è®¤è¯APIã€ç®¡ç†å‘˜APIï¼‰

9. **HTTPå¤„ç†å±‚ï¼ˆHandlerï¼‰**
   - âœ… AuthHandler - ç™»å½•ã€æ³¨å†Œã€ä¸ªäººä¿¡æ¯ã€å¯†ç ç®¡ç†ã€ç”¨æˆ·ç®¡ç†
   - âœ… NodeHandler - èŠ‚ç‚¹åˆ—è¡¨ã€è¯¦æƒ…ã€åˆ é™¤ã€ç»Ÿè®¡
   - âœ… Helperå·¥å…· - å‚æ•°è§£æè¾…åŠ©å‡½æ•°

10. **gRPCæœåŠ¡**
   - âœ… Protobufå®šä¹‰ï¼ˆmanager.protoï¼‰
   - âœ… èŠ‚ç‚¹æ³¨å†ŒæœåŠ¡ï¼ˆRegisterNodeï¼‰
   - âœ… å¿ƒè·³æ¥æ”¶æœåŠ¡ï¼ˆHeartbeatï¼‰
   - âœ… æŒ‡æ ‡ä¸ŠæŠ¥æœåŠ¡ï¼ˆReportMetricsï¼‰
   - âœ… gRPCæœåŠ¡å™¨å¯åŠ¨å’Œä¼˜é›…å…³é—­

### ğŸ”„ è¿›è¡Œä¸­

æ— 

### ğŸ“‹ å¾…å®ç°

1. **HTTPå¤„ç†å±‚ï¼ˆHandler - æ‰©å±•ï¼‰**
   - â³ MetricsHandler - æŒ‡æ ‡æŸ¥è¯¢ã€èšåˆç»Ÿè®¡
   - â³ TaskHandler - ä»»åŠ¡åˆ›å»ºã€æ‰§è¡Œã€æŸ¥è¯¢
   - â³ VersionHandler - ç‰ˆæœ¬ä¸Šä¼ ã€å‘å¸ƒã€ä¸‹è½½

2. **å…¶ä»–**
   - â³ æ•°æ®åº“è¿ç§»è„šæœ¬
   - â³ å•å…ƒæµ‹è¯•
   - â³ APIæ–‡æ¡£ï¼ˆSwaggerï¼‰

## é¡¹ç›®ç»“æ„

```
manager/
â”œâ”€â”€ cmd/manager/          # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/           # âœ… é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ model/            # âœ… æ•°æ®æ¨¡å‹ï¼ˆ6ä¸ªæ¨¡å‹ï¼‰
â”‚   â”œâ”€â”€ repository/       # â³ æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ service/          # â³ ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ handler/          # â³ HTTPå¤„ç†å™¨
â”‚   â”œâ”€â”€ middleware/       # â³ ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ grpc/             # â³ gRPCæœåŠ¡
â”‚   â””â”€â”€ logger/           # â³ æ—¥å¿—æ¨¡å—
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ jwt/              # â³ JWTå·¥å…·
â”‚   â”œâ”€â”€ utils/            # â³ é€šç”¨å·¥å…·
â”‚   â””â”€â”€ errors/           # â³ é”™è¯¯å®šä¹‰
â”œâ”€â”€ configs/              # âœ… é…ç½®æ–‡ä»¶
â”œâ”€â”€ migrations/           # â³ æ•°æ®åº“è¿ç§»
â”œâ”€â”€ scripts/              # â³ è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ go.mod                # âœ… Goæ¨¡å—
â”œâ”€â”€ Makefile              # âœ… æ„å»ºæ–‡ä»¶
â””â”€â”€ README.md             # âœ… è¯´æ˜æ–‡æ¡£
```

## é…ç½®è¯´æ˜

### å¼€å‘ç¯å¢ƒé…ç½®

é…ç½®æ–‡ä»¶ï¼š`configs/manager.dev.yaml`

```yaml
server:
  host: 127.0.0.1
  port: 8080
  mode: debug

database:
  dsn: "root:root@tcp(127.0.0.1:3306)/ops_manager_dev?..."

grpc:
  port: 9090
  tls:
    enabled: false  # å¼€å‘ç¯å¢ƒå…³é—­TLS
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

é…ç½®æ–‡ä»¶ï¼š`configs/manager.yaml`

```yaml
server:
  host: 0.0.0.0
  port: 8080
  mode: release

database:
  dsn: "root:password@tcp(localhost:3306)/ops_manager?..."

grpc:
  port: 9090
  tls:
    enabled: true
    cert_file: /etc/manager/certs/server.crt
    key_file: /etc/manager/certs/server.key
```

## æ•°æ®åº“æ¨¡å‹

### Userï¼ˆç”¨æˆ·ï¼‰
- ç”¨æˆ·å/å¯†ç è®¤è¯
- è§’è‰²ï¼ˆadmin/userï¼‰
- çŠ¶æ€ï¼ˆactive/disabledï¼‰
- ç™»å½•è®°å½•

### Nodeï¼ˆèŠ‚ç‚¹ï¼‰
- èŠ‚ç‚¹IDï¼ˆUUIDï¼‰
- ä¸»æœºä¿¡æ¯ï¼ˆhostnameã€IPã€OSã€æ¶æ„ï¼‰
- æ ‡ç­¾ï¼ˆç”¨äºåˆ†ç»„å’Œç­›é€‰ï¼‰
- çŠ¶æ€ï¼ˆonline/offlineï¼‰
- ç‰ˆæœ¬ä¿¡æ¯ï¼ˆdaemonã€agentï¼‰

### Metricsï¼ˆç›‘æ§æŒ‡æ ‡ï¼‰
- èŠ‚ç‚¹ID
- æŒ‡æ ‡ç±»å‹ï¼ˆcpuã€memoryã€diskã€networkï¼‰
- é‡‡é›†æ—¶é—´
- æŒ‡æ ‡æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰

### Taskï¼ˆä»»åŠ¡ï¼‰
- ä»»åŠ¡åç§°å’Œæè¿°
- ä»»åŠ¡ç±»å‹ï¼ˆscriptã€file_uploadã€service_controlï¼‰
- ç›®æ ‡èŠ‚ç‚¹åˆ—è¡¨
- æ‰§è¡ŒçŠ¶æ€ï¼ˆpendingã€runningã€completedã€failedï¼‰
- æ‰§è¡Œç»“æœ

### Versionï¼ˆç‰ˆæœ¬ï¼‰
- ç»„ä»¶ç±»å‹ï¼ˆagentã€daemonï¼‰
- ç‰ˆæœ¬å·
- æ–‡ä»¶ä¿¡æ¯ï¼ˆURLã€å¤§å°ã€å“ˆå¸Œã€ç­¾åï¼‰
- å‘å¸ƒçŠ¶æ€ï¼ˆdraftã€testingã€releasedã€deprecatedï¼‰

### AuditLogï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
- æ“ä½œç”¨æˆ·
- æ“ä½œç±»å‹å’Œèµ„æº
- è¯·æ±‚ä¿¡æ¯ï¼ˆmethodã€pathã€IPï¼‰
- æ“ä½œç»“æœï¼ˆstatusã€messageã€detailsï¼‰

## å¼€å‘æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- Go 1.21+
- MySQL 8.0+
- Redisï¼ˆå¯é€‰ï¼Œç”¨äºç¼“å­˜ï¼‰

### æ„å»º

```bash
cd manager

# ä¸‹è½½ä¾èµ–
make deps

# æ„å»º
make build
```

### è¿è¡Œï¼ˆè®¡åˆ’ï¼‰

```bash
# å¼€å‘ç¯å¢ƒ
make run-dev

# ç”Ÿäº§ç¯å¢ƒ
make run
```

## APIæ¥å£è¯´æ˜

### å…¬å¼€APIï¼ˆæ— éœ€è®¤è¯ï¼‰

#### ç”¨æˆ·è®¤è¯
- `POST /api/v1/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/v1/auth/login` - ç”¨æˆ·ç™»å½•

### éœ€è¦è®¤è¯çš„API

#### ç”¨æˆ·ç›¸å…³
- `GET /api/v1/auth/profile` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `POST /api/v1/auth/change-password` - ä¿®æ”¹å¯†ç 

#### èŠ‚ç‚¹ç›¸å…³
- `GET /api/v1/nodes` - è·å–èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µã€çŠ¶æ€ç­›é€‰ï¼‰
- `GET /api/v1/nodes/:id` - è·å–èŠ‚ç‚¹è¯¦æƒ…
- `GET /api/v1/nodes/statistics` - è·å–èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯

### ç®¡ç†å‘˜APIï¼ˆéœ€è¦adminè§’è‰²ï¼‰

#### ç”¨æˆ·ç®¡ç†
- `GET /api/v1/admin/users` - è·å–ç”¨æˆ·åˆ—è¡¨
- `POST /api/v1/admin/users/:id/disable` - ç¦ç”¨ç”¨æˆ·
- `POST /api/v1/admin/users/:id/enable` - å¯ç”¨ç”¨æˆ·

#### èŠ‚ç‚¹ç®¡ç†
- `DELETE /api/v1/admin/nodes/:id` - åˆ é™¤èŠ‚ç‚¹

### å¥åº·æ£€æŸ¥
- `GET /health` - å¥åº·æ£€æŸ¥

## gRPCæœåŠ¡è¯´æ˜

### Manager gRPCæœåŠ¡ç«¯ï¼ˆç›‘å¬ç«¯å£ï¼š9090ï¼‰

Manageræä¾›ä»¥ä¸‹gRPCæœåŠ¡ä¾›Daemonè°ƒç”¨ï¼š

#### 1. RegisterNode - èŠ‚ç‚¹æ³¨å†Œ
Daemonå¯åŠ¨æ—¶è°ƒç”¨æ­¤æ¥å£å‘Manageræ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ã€‚

**è¯·æ±‚å‚æ•°ï¼š**
- node_id: èŠ‚ç‚¹å”¯ä¸€ID
- hostname: ä¸»æœºå
- ip: IPåœ°å€
- os: æ“ä½œç³»ç»Ÿ
- arch: CPUæ¶æ„
- labels: èŠ‚ç‚¹æ ‡ç­¾
- daemon_version: Daemonç‰ˆæœ¬
- agent_version: Agentç‰ˆæœ¬

**å“åº”ï¼š**
- success: æ˜¯å¦æˆåŠŸ
- message: å“åº”æ¶ˆæ¯

#### 2. Heartbeat - å¿ƒè·³ä¸ŠæŠ¥
Daemonå®šæœŸè°ƒç”¨æ­¤æ¥å£ä¸ŠæŠ¥å¿ƒè·³ï¼Œç»´æŒåœ¨çº¿çŠ¶æ€ã€‚

**è¯·æ±‚å‚æ•°ï¼š**
- node_id: èŠ‚ç‚¹ID
- timestamp: æ—¶é—´æˆ³

**å“åº”ï¼š**
- success: æ˜¯å¦æˆåŠŸ
- message: å“åº”æ¶ˆæ¯

#### 3. ReportMetrics - æŒ‡æ ‡ä¸ŠæŠ¥
Daemonå®šæœŸè°ƒç”¨æ­¤æ¥å£ä¸ŠæŠ¥ç³»ç»Ÿèµ„æºæŒ‡æ ‡ã€‚

**è¯·æ±‚å‚æ•°ï¼š**
- node_id: èŠ‚ç‚¹ID
- metrics: æŒ‡æ ‡æ•°æ®åˆ—è¡¨
  - type: æŒ‡æ ‡ç±»å‹ï¼ˆcpu/memory/disk/networkï¼‰
  - timestamp: é‡‡é›†æ—¶é—´æˆ³
  - values: æŒ‡æ ‡å€¼ï¼ˆé”®å€¼å¯¹ï¼‰

**å“åº”ï¼š**
- success: æ˜¯å¦æˆåŠŸ
- message: å“åº”æ¶ˆæ¯

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å®Œæˆå…¶ä»–Handler**
   - MetricsHandler - æŒ‡æ ‡æŸ¥è¯¢å’Œèšåˆ
   - TaskHandler - ä»»åŠ¡ç®¡ç†
   - VersionHandler - ç‰ˆæœ¬ç®¡ç†

2. **æµ‹è¯•å’Œä¼˜åŒ–**
   - ç¼–å†™å•å…ƒæµ‹è¯•
   - æ€§èƒ½ä¼˜åŒ–
   - æ·»åŠ APIæ–‡æ¡£ï¼ˆSwaggerï¼‰

3. **é›†æˆæµ‹è¯•**
   - Manager + Daemoné€šä¿¡æµ‹è¯•
   - å®Œæ•´çš„å·¥ä½œæµæµ‹è¯•

## License

Apache License 2.0

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Request!
