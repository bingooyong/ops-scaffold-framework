---
globs: *.go
description: Go backend coding standards and conventions for Manager and Daemon modules
---
# Go Backend Coding Standards

## Module Structure

This project uses **multi-module structure** with independent `go.mod` files:

- **Manager module**: `manager/go.mod` (module: `github.com/bingooyong/ops-scaffold-framework/manager`, Go 1.24.0)
- **Daemon module**: `daemon/go.mod` (module: `github.com/bingooyong/ops-scaffold-framework/daemon`, Go 1.24.0)

## Architecture Pattern

### Manager Backend (Layered Architecture)

```
Handler Layer → Service Layer → Repository Layer → Model Layer
```

**Directory structure**:
- `internal/handler/` - HTTP handlers (Gin)
- `internal/service/` - Business logic
- `internal/repository/` - Data access (GORM)
- `internal/model/` - Data models
- `internal/middleware/` - Middleware (JWT auth, CORS, audit, etc.)
- `internal/grpc/` - gRPC server implementation
- `pkg/` - Public packages (response, errors, utils)

### Daemon (Multi-Agent Management Architecture)

**Core modules**:
- `internal/collector/` - System resource collectors (CPU, memory, disk, network)
- `internal/agent/` - **Multi-Agent management** (Registry, MultiManager, Instance, HealthChecker, Heartbeat)
  - `registry.go` - AgentRegistry: Centralized agent instance registry
  - `multi_manager.go` - MultiAgentManager: Orchestrates multiple agent instances
  - `instance.go` - AgentInstance: Manages single agent process lifecycle
  - `health.go` - HealthChecker: Per-agent health monitoring
  - `heartbeat.go` - HeartbeatReceiver: Agent heartbeat handling
- `internal/comm/` - Communication layer (gRPC client to Manager)
- `internal/daemon/` - Core daemon logic
- `internal/config/` - Configuration management (supports agents array)
- `internal/grpc/` - gRPC server implementation
- `internal/logger/` - Logging

## Coding Standards

### Error Handling

- Use structured errors from `pkg/errors/errors.go`
- Error codes follow convention:
  - `0`: Success
  - `1xxx`: Client errors (parameters, authentication, permissions)
  - `2xxx`: Business errors (nodes, tasks)
  - `3xxx`: Version management errors
  - `5xxx`: Server internal errors

### Response Format

All HTTP responses must use unified format from `pkg/response/response.go`:

```go
{
  "code": 0,
  "message": "success",
  "data": {},
  "timestamp": "2025-12-01T10:00:00Z"
}
```

### Logging

- Use `zap` structured logging
- Log levels: DEBUG, INFO, WARN, ERROR
- Include context fields: request_id, user_id, node_id, etc.

### Configuration

- Use YAML format in `configs/` directory
- Load with Viper
- Priority: Command line > Environment variables > Config file > Defaults

### Testing

- Unit tests: `*_test.go` files alongside source
- Integration tests: `test/integration/` directory
- Use `testify` framework
- Coverage targets:
  - Service layer: > 80%
  - Repository layer: > 70%
  - Handler layer: > 70%

## Key Design Patterns

### Multi-Agent Management (Daemon)

**Architecture**: AgentRegistry + MultiAgentManager + AgentInstance

**AgentRegistry**:
- Centralized registry for all agent instances on a host
- Concurrent-safe with `sync.RWMutex`
- Methods: `Register()`, `Get()`, `Unregister()`, `List()`, `ListByType()`, `Exists()`, `Count()`

**AgentInfo**: Metadata for each agent
- ID, Type (filebeat/telegraf/node_exporter/custom), Name
- BinaryPath, ConfigFile, WorkDir, SocketPath
- PID, Status (stopped/starting/running/stopping/restarting/failed)
- RestartCount, LastRestart, CreatedAt, UpdatedAt

**MultiAgentManager**:
- Manages multiple agent instances using AgentRegistry
- Batch operations: `StartAll()`, `StopAll()`, `RestartAll()`
- Single agent operations: `StartAgent(id)`, `StopAgent(id)`, `RestartAgent(id)`
- Loads agents from YAML `agents:` array configuration

**AgentInstance**:
- Manages single agent process lifecycle
- Type-aware startup args generation (filebeat uses `-c`, node_exporter uses `--web.listen-address`)
- Independent work directories and log files per agent

**Configuration**:
- `agents:` array in `daemon.yaml` with per-agent config
- `agent_defaults:` for global defaults (health_check, restart policy)
- Backward compatible with legacy single-agent `agent:` config

### Process Isolation

- **Third-party agents run as independent processes**, not as Daemon subprocess
- Daemon exit does not affect running agents
- Agent exceptions trigger Daemon auto-restart with exponential backoff strategy
- Each agent has isolated work directory, config file, socket path (if applicable)

### Version Update Security

All update packages must pass:
1. Source verification (Manager IP whitelist/certificate)
2. Signature verification (RSA-2048/ECDSA)
3. Integrity check (SHA-256 hash)
4. Version check (new version > current version)

### Graceful Shutdown

- Handle SIGTERM/SIGINT signals
- Wait for current tasks to complete (30s timeout)
- Save state to local storage
- **Note**: Do not stop Agent process on Daemon shutdown

## gRPC Communication

- Use TLS 1.3 with mTLS bidirectional authentication
- Manager ↔ Daemon: gRPC over TLS
- Proto definitions in `pkg/proto/` directory
- Generate code: `make proto` or `protoc` commands

## Database (Manager)

- Use GORM with MySQL 8.0+
- Auto-migrate on startup
- Connection pool: MaxOpen=100, MaxIdle=10
- Use transactions for multi-step operations

**Key Tables**:
- `nodes`: Node metadata (node_id, hostname, ip, status)
- `agents`: Agent registry (node_id, agent_id, type, version, status, config, pid, last_heartbeat)
  - Unique index: `idx_node_agent` on (node_id, agent_id)
- `metrics`: Time-series metrics data (partitioned by date)
- `versions`: Version metadata for updates
- `tasks`: Task definitions and execution records
- `users`: User accounts (bcrypt password hashing)
- `audit_logs`: Audit trail for operations

## Security

- JWT authentication for HTTP API
- mTLS for gRPC communication
- Request signature (HMAC-SHA256) for Agent API
- IP whitelist support
- Sensitive data encryption in configs
- Log sanitization
