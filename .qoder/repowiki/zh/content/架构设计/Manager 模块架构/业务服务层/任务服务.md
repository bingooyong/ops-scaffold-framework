# 任务服务

<cite>
**本文档引用的文件**
- [task.go](file://manager/internal/service/task.go)
- [task.go](file://manager/internal/model/task.go)
- [task.go](file://manager/internal/repository/task.go)
- [设计文档_03_Manager模块.md](file://docs/设计文档_03_Manager模块.md)
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md)
</cite>

## 目录
1. [简介](#简介)
2. [任务服务架构](#任务服务架构)
3. [核心组件分析](#核心组件分析)
4. [任务生命周期管理](#任务生命周期管理)
5. [定时任务调度](#定时任务调度)
6. [任务执行引擎集成](#任务执行引擎集成)
7. [错误处理与重试机制](#错误处理与重试机制)
8. [性能考虑](#性能考虑)
9. [故障排除指南](#故障排除指南)
10. [结论](#结论)

## 简介
任务服务是运维工具框架的核心组件，负责管理即时任务执行、定时任务（Cron）和任务模板。该服务提供了创建、执行、调度和监控任务的完整功能，支持多种任务类型，并与任务执行引擎紧密集成。通过任务服务，用户可以定义和执行脚本、文件传输、服务控制等操作，同时支持任务超时、重试和失败通知等高级功能。

**Section sources**
- [设计文档_03_Manager模块.md](file://docs/设计文档_03_Manager模块.md)

## 任务服务架构
任务服务采用分层架构设计，包含服务层、存储层和模型层。服务层提供任务管理的业务逻辑，存储层负责数据持久化，模型层定义数据结构。这种分层设计确保了代码的可维护性和可扩展性。

```mermaid
graph TD
A[API Handler] --> B[TaskService]
B --> C[TaskRepository]
C --> D[数据库]
B --> E[NodeRepository]
B --> F[AuditLogRepository]
G[任务执行引擎] --> B
```

**Diagram sources**
- [task.go](file://manager/internal/service/task.go)
- [task.go](file://manager/internal/repository/task.go)

**Section sources**
- [task.go](file://manager/internal/service/task.go)
- [task.go](file://manager/internal/repository/task.go)

## 核心组件分析
任务服务的核心组件包括任务创建、执行、调度和查询功能。这些组件协同工作，提供完整的任务管理能力。

### 任务创建与验证
任务创建是任务服务的入口点，负责验证任务参数并将其持久化到数据库。创建任务时，服务会验证目标节点是否存在，并确保任务配置的完整性。

```mermaid
flowchart TD
Start([创建任务]) --> ValidateInput["验证输入参数"]
ValidateInput --> InputValid{"参数有效?"}
InputValid --> |否| ReturnError["返回错误响应"]
InputValid --> |是| CheckNodes["检查目标节点"]
CheckNodes --> NodesExist{"节点存在?"}
NodesExist --> |否| ReturnError
NodesExist --> |是| CreateTask["创建任务记录"]
CreateTask --> SaveToDB["保存到数据库"]
SaveToDB --> End([任务创建成功])
ReturnError --> End
```

**Diagram sources**
- [task.go](file://manager/internal/service/task.go#L68-L90)

**Section sources**
- [task.go](file://manager/internal/service/task.go#L68-L90)

### 任务执行流程
任务执行流程涉及多个步骤，包括状态检查、状态更新和实际执行。服务确保只有处于适当状态的任务才能被执行，并在执行过程中更新任务状态。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant TaskService as "任务服务"
participant TaskRepo as "任务存储库"
participant Executor as "执行引擎"
Client->>TaskService : ExecuteTask(taskID)
TaskService->>TaskRepo : GetByID(taskID)
TaskRepo-->>TaskService : 返回任务
TaskService->>TaskService : 检查任务状态
TaskService->>TaskRepo : UpdateStatus(running)
TaskRepo-->>TaskService : 更新成功
TaskService->>Executor : 调用执行引擎
Executor-->>TaskService : 执行结果
TaskService->>TaskRepo : UpdateResult(结果, 状态)
TaskRepo-->>TaskService : 更新成功
TaskService-->>Client : 执行完成
```

**Diagram sources**
- [task.go](file://manager/internal/service/task.go#L169-L213)

**Section sources**
- [task.go](file://manager/internal/service/task.go#L169-L213)

## 任务生命周期管理
任务服务管理任务从创建到完成的完整生命周期，包括各种状态转换和相应的业务逻辑。

### 任务状态机
任务状态机定义了任务在不同状态之间的转换规则，确保任务状态的正确性和一致性。

```mermaid
stateDiagram-v2
[*] --> Pending
Pending --> Running : 执行
Running --> Completed : 成功完成
Running --> Failed : 执行失败
Running --> Timeout : 超时
Running --> Cancelled : 取消
Pending --> Cancelled : 取消
state "Pending" as Pending
state "Running" as Running
state "Completed" as Completed
state "Failed" as Failed
state "Timeout" as Timeout
state "Cancelled" as Cancelled
```

**Diagram sources**
- [task.go](file://manager/internal/model/task.go#L28-L30)
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md#L472-L504)

**Section sources**
- [task.go](file://manager/internal/model/task.go#L28-L30)
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md#L472-L504)

### 任务查询与统计
任务服务提供多种查询方法，支持按状态、创建者和时间范围检索任务，同时提供任务统计信息。

```mermaid
classDiagram
class TaskService {
+Create(ctx, task) error
+GetByID(ctx, id) (*Task, error)
+Update(ctx, task) error
+Delete(ctx, id) error
+List(ctx, page, pageSize) ([]*Task, int64, error)
+ListByStatus(ctx, status, page, pageSize) ([]*Task, int64, error)
+ListByCreator(ctx, creatorID, page, pageSize) ([]*Task, int64, error)
+Execute(ctx, taskID) error
+Cancel(ctx, taskID) error
+UpdateStatus(ctx, taskID, status) error
+UpdateResult(ctx, taskID, result, status) error
+GetPendingTasks(ctx) ([]*Task, error)
+GetRunningTasks(ctx) ([]*Task, error)
+GetStatistics(ctx) (map[string]int64, error)
}
class TaskRepository {
+Create(ctx, task) error
+GetByID(ctx, id) (*Task, error)
+Update(ctx, task) error
+Delete(ctx, id) error
+List(ctx, page, pageSize) ([]*Task, int64, error)
+ListByStatus(ctx, status, page, pageSize) ([]*Task, int64, error)
+ListByCreator(ctx, creatorID, page, pageSize) ([]*Task, int64, error)
+UpdateStatus(ctx, id, status) error
+UpdateResult(ctx, id, result, status) error
+GetPendingTasks(ctx) ([]*Task, error)
+GetRunningTasks(ctx) ([]*Task, error)
+CountByStatus(ctx) (map[string]int64, error)
}
TaskService --> TaskRepository : "使用"
```

**Diagram sources**
- [task.go](file://manager/internal/service/task.go)
- [task.go](file://manager/internal/repository/task.go)

**Section sources**
- [task.go](file://manager/internal/service/task.go)
- [task.go](file://manager/internal/repository/task.go)

## 定时任务调度
定时任务调度功能允许用户创建基于Cron表达式的周期性任务，服务会根据预定的时间表自动执行这些任务。

### 定时任务调度流程
定时任务调度流程包括任务检索、时间计算和执行触发，确保任务在正确的时间点被执行。

```mermaid
sequenceDiagram
participant Scheduler as "调度器"
participant TaskService as "任务服务"
participant TaskRepo as "任务存储库"
participant Executor as "执行引擎"
Scheduler->>TaskService : 获取定时任务
TaskService->>TaskRepo : GetScheduledTasks()
TaskRepo-->>TaskService : 返回定时任务列表
TaskService-->>Scheduler : 返回任务列表
loop 每个定时任务
Scheduler->>Scheduler : 解析Cron表达式
Scheduler->>Scheduler : 计算下次执行时间
Scheduler->>Scheduler : 检查是否到达执行时间
alt 到达执行时间
Scheduler->>TaskService : ExecuteTask(taskID)
TaskService->>Executor : 触发任务执行
Executor-->>TaskService : 执行结果
TaskService-->>Scheduler : 执行完成
end
end
```

**Diagram sources**
- [设计文档_03_Manager模块.md](file://docs/设计文档_03_Manager模块.md#L526-L545)

**Section sources**
- [设计文档_03_Manager模块.md](file://docs/设计文档_03_Manager模块.md#L526-L545)

## 任务执行引擎集成
任务服务与任务执行引擎紧密集成，通过gRPC或HTTP调用将任务分发到目标节点执行。

### 执行引擎集成架构
执行引擎集成架构展示了任务服务如何与Agent通信，将任务分发到目标节点并收集执行结果。

```mermaid
graph TD
A[任务服务] --> |gRPC| B[Agent]
B --> C[WorkerPool]
C --> D[Executor]
D --> E[脚本执行器]
D --> F[文件传输执行器]
D --> G[服务控制执行器]
C --> H[结果通道]
H --> I[结果处理器]
I --> J[更新任务状态]
J --> A
```

**Diagram sources**
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md#L419-L517)

**Section sources**
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md#L419-L517)

## 错误处理与重试机制
任务服务实现了完善的错误处理和重试机制，确保任务的可靠执行。

### 任务失败处理流程
当任务执行失败时，服务会根据配置的重试策略决定是否重试，并在达到最大重试次数后标记任务为失败。

```mermaid
flowchart TD
Start([任务执行]) --> Execute["执行任务"]
Execute --> Success{"执行成功?"}
Success --> |是| UpdateStatus["更新状态为完成"]
Success --> |否| CheckRetry["检查重试次数"]
CheckRetry --> HasRetry{"还有重试机会?"}
HasRetry --> |是| WaitInterval["等待重试间隔"]
WaitInterval --> Execute
HasRetry --> |否| UpdateFailed["更新状态为失败"]
UpdateStatus --> End([任务完成])
UpdateFailed --> End
```

**Diagram sources**
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md#L491-L500)

**Section sources**
- [设计文档_02_Agent模块.md](file://docs/设计文档_02_Agent模块.md#L491-L500)

## 性能考虑
任务服务在设计时考虑了性能因素，通过合理的数据库索引、缓存策略和并发控制来确保高并发场景下的性能表现。

**Section sources**
- [设计文档_03_Manager模块.md](file://docs/设计文档_03_Manager模块.md#L526-L545)

## 故障排除指南
当任务服务出现问题时，可以按照以下步骤进行排查：

1. 检查任务状态是否正确
2. 验证目标节点是否在线
3. 检查数据库连接是否正常
4. 查看日志文件中的错误信息
5. 验证Cron表达式是否正确

**Section sources**
- [task.go](file://manager/internal/service/task.go)
- [task.go](file://manager/internal/repository/task.go)

## 结论
任务服务为运维工具框架提供了强大的任务管理能力，支持即时任务执行、定时任务调度和任务模板管理。通过清晰的分层架构和完善的错误处理机制，服务确保了任务的可靠执行。未来可以考虑增加任务依赖、工作流编排等高级功能，进一步提升任务管理的灵活性和效率。