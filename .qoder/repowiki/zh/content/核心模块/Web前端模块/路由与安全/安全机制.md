# 安全机制

<cite>
**本文档引用的文件**
- [authStore.ts](file://web/src/stores/authStore.ts)
- [ProtectedRoute.tsx](file://web/src/router/ProtectedRoute.tsx)
- [useAuth.ts](file://web/src/hooks/useAuth.ts)
- [interceptors.ts](file://web/src/api/interceptors.ts)
- [auth.ts](file://web/src/api/auth.ts)
- [client.ts](file://web/src/api/client.ts)
- [storage.ts](file://web/src/utils/storage.ts)
- [user.ts](file://web/src/types/user.ts)
- [api.ts](file://web/src/types/api.ts)
- [Login/index.tsx](file://web/src/pages/Login/index.tsx)
- [jwt.go](file://manager/pkg/jwt/jwt.go)
- [auth.go](file://manager/internal/middleware/auth.go)
- [auth.go](file://manager/internal/handler/auth.go)
- [auth.go](file://manager/internal/service/auth.go)
</cite>

## 目录
1. [简介](#简介)
2. [认证状态管理](#认证状态管理)
3. [路由守卫机制](#路由守卫机制)
4. [登录流程](#登录流程)
5. [SSR/SSG状态同步](#ssrssg状态同步)
6. [错误处理机制](#错误处理机制)
7. [安全最佳实践](#安全最佳实践)

## 简介
本系统采用基于JWT的认证体系，实现了完整的用户认证和权限控制流程。前端使用Zustand进行状态管理，通过React Router实现路由守卫，确保受保护资源的安全访问。后端使用Gin框架和JWT库实现认证中间件，对API请求进行身份验证和权限检查。

## 认证状态管理
系统使用Zustand库创建`useAuthStore`状态管理器，集中管理用户的认证状态。该状态管理器包含用户信息、JWT令牌和认证状态等关键数据。

```mermaid
classDiagram
class AuthState {
+user : User | null
+token : string | null
+isAuthenticated : boolean
+_hasHydrated : boolean
+setAuth(user : User, token : string) : void
+clearAuth() : void
+updateUser(user : User) : void
+setHasHydrated(state : boolean) : void
}
class User {
+id : number
+username : string
+email : string
+role : UserRole
+status : UserStatus
+created_at : string
+updated_at : string
+last_login_at? : string
}
AuthState --> User : "包含"
```

**图表来源**
- [authStore.ts](file://web/src/stores/authStore.ts#L10-L21)
- [user.ts](file://web/src/types/user.ts#L5-L14)

**章节来源**
- [authStore.ts](file://web/src/stores/authStore.ts#L1-L84)

## 路由守卫机制
`ProtectedRoute`组件通过`useAuthStore`钩子读取`isAuthenticated`状态，实现路由守卫功能，阻止未授权用户访问受保护资源。

```mermaid
sequenceDiagram
participant Browser as "浏览器"
participant ProtectedRoute as "ProtectedRoute组件"
participant AuthStore as "useAuthStore"
Browser->>ProtectedRoute : 访问受保护路由
ProtectedRoute->>AuthStore : 读取_isHydrated状态
alt 状态未恢复完成
AuthStore-->>ProtectedRoute : _isHydrated = false
ProtectedRoute-->>Browser : 显示加载动画
else 状态已恢复
AuthStore-->>ProtectedRoute : _isHydrated = true
ProtectedRoute->>AuthStore : 读取isAuthenticated状态
alt 已认证
AuthStore-->>ProtectedRoute : isAuthenticated = true
ProtectedRoute-->>Browser : 渲染受保护内容
else 未认证
AuthStore-->>ProtectedRoute : isAuthenticated = false
ProtectedRoute-->>Browser : 重定向到登录页
end
end
```

**图表来源**
- [ProtectedRoute.tsx](file://web/src/router/ProtectedRoute.tsx#L13-L37)
- [authStore.ts](file://web/src/stores/authStore.ts#L14-L15)

**章节来源**
- [ProtectedRoute.tsx](file://web/src/router/ProtectedRoute.tsx#L1-L38)

## 登录流程
登录流程包括表单验证、用户凭证提交、JWT令牌获取与本地存储等步骤，确保用户安全登录系统。

```mermaid
flowchart TD
Start([登录页面]) --> ValidateForm["验证表单输入"]
ValidateForm --> InputValid{"输入有效?"}
InputValid --> |否| ShowError["显示错误信息"]
InputValid --> |是| SubmitCredentials["提交凭证到API"]
SubmitCredentials --> API["/api/v1/auth/login"]
API --> Backend["后端验证"]
Backend --> TokenValid{"凭证有效?"}
TokenValid --> |否| ReturnError["返回错误"]
TokenValid --> |是| GenerateToken["生成JWT令牌"]
GenerateToken --> ReturnToken["返回令牌和用户信息"]
ReturnToken --> UpdateStore["更新useAuthStore状态"]
UpdateStore --> StoreToken["存储令牌到localStorage"]
StoreToken --> Redirect["重定向到仪表板"]
ShowError --> End([等待用户修正])
ReturnError --> ShowError
Redirect --> End
```

**图表来源**
- [Login/index.tsx](file://web/src/pages/Login/index.tsx#L21-L110)
- [useAuth.ts](file://web/src/hooks/useAuth.ts#L17-L23)
- [auth.ts](file://web/src/api/auth.ts#L19-L21)
- [authStore.ts](file://web/src/stores/authStore.ts#L31-L40)

**章节来源**
- [Login/index.tsx](file://web/src/pages/Login/index.tsx#L1-L110)
- [useAuth.ts](file://web/src/hooks/useAuth.ts#L1-L73)

## SSR/SSG状态同步
`_hasHydrated`状态确保在SSR/SSG场景下的状态同步一致性，防止水合不匹配问题。

```mermaid
sequenceDiagram
participant Server as "服务器"
participant Client as "客户端"
participant Storage as "localStorage"
Server->>Client : 服务端渲染初始HTML
Client->>Storage : 尝试从localStorage恢复状态
Storage-->>Client : 返回存储的认证数据
Client->>Client : 执行onRehydrateStorage回调
Client->>Client : 根据恢复数据设置isAuthenticated
Client->>Client : 设置_hasHydrated = true
Client->>Client : 完成水合过程
Client->>Client : 渲染最终UI
```

**图表来源**
- [authStore.ts](file://web/src/stores/authStore.ts#L70-L80)
- [ProtectedRoute.tsx](file://web/src/router/ProtectedRoute.tsx#L17-L29)

**章节来源**
- [authStore.ts](file://web/src/stores/authStore.ts#L70-L80)

## 错误处理机制
系统提供完善的错误处理机制，展示登录失败时的错误提示与重试逻辑。

```mermaid
flowchart TD
LoginAttempt([用户尝试登录]) --> APIRequest["发送登录请求"]
APIRequest --> APIResponse{"API响应?"}
APIResponse --> |成功| ProcessSuccess["处理成功响应"]
APIResponse --> |失败| ProcessError["处理错误响应"]
ProcessSuccess --> UpdateState["更新认证状态"]
UpdateState --> Redirect["重定向到仪表板"]
ProcessError --> CheckErrorType{"错误类型?"}
CheckErrorType --> |网络错误| ShowNetworkError["显示网络连接错误"]
CheckErrorType --> |认证错误| ShowAuthError["显示认证失败错误"]
CheckErrorType --> |其他错误| ShowGenericError["显示通用错误"]
ShowNetworkError --> RetryOption["提供重试选项"]
ShowAuthError --> RetryOption
ShowGenericError --> RetryOption
RetryOption --> End([用户决定是否重试])
Redirect --> End
```

**图表来源**
- [Login/index.tsx](file://web/src/pages/Login/index.tsx#L37-L39)
- [interceptors.ts](file://web/src/api/interceptors.ts#L55-L90)
- [api.ts](file://web/src/types/api.ts#L28-L41)

**章节来源**
- [Login/index.tsx](file://web/src/pages/Login/index.tsx#L24-L40)
- [interceptors.ts](file://web/src/api/interceptors.ts#L1-L95)

## 安全最佳实践
系统实施了多项安全最佳实践，包括令牌过期处理、自动登出机制和XSS防护措施。

```mermaid
flowchart TD
subgraph "前端安全机制"
A["请求拦截器"] --> B["添加Bearer Token"]
C["响应拦截器"] --> D["检查401/403状态"]
D --> E["自动登出并重定向"]
F["localStorage存储"] --> G["避免敏感信息明文存储"]
end
subgraph "后端安全机制"
H["JWT认证中间件"] --> I["验证Token签名"]
J["Token解析"] --> K["检查过期时间"]
L["权限检查"] --> M["验证用户角色"]
N["审计日志"] --> O["记录所有API调用"]
end
A --> H
C --> J
F --> H
N --> P["数据库"]
```

**图表来源**
- [interceptors.ts](file://web/src/api/interceptors.ts#L14-L90)
- [auth.go](file://manager/internal/middleware/auth.go#L13-L50)
- [jwt.go](file://manager/pkg/jwt/jwt.go#L63-L88)
- [audit.go](file://manager/internal/middleware/audit.go#L13-L49)

**章节来源**
- [interceptors.ts](file://web/src/api/interceptors.ts#L1-L95)
- [auth.go](file://manager/internal/middleware/auth.go#L1-L60)
- [jwt.go](file://manager/pkg/jwt/jwt.go#L1-L139)