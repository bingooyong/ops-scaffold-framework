# 认证接口

<cite>
**本文档引用文件**  
- [Manager_API.md](file://docs/api/Manager_API.md)
- [auth.go](file://manager/internal/handler/auth.go)
- [jwt.go](file://manager/pkg/jwt/jwt.go)
- [auth.ts](file://web/src/api/auth.ts)
- [auth.go](file://manager/internal/middleware/auth.go)
- [auth.go](file://manager/internal/service/auth.go)
- [user.go](file://manager/internal/model/user.go)
- [response.go](file://manager/pkg/response/response.go)
- [errors.go](file://manager/pkg/errors/errors.go)
- [manager.yaml](file://manager/configs/manager.yaml)
- [helper.go](file://manager/internal/handler/helper.go)
- [user.ts](file://web/src/types/user.ts)
</cite>

## 目录
1. [认证机制](#认证机制)
2. [响应格式](#响应格式)
3. [错误码](#错误码)
4. [API 接口](#api-接口)
   - [用户注册](#用户注册)
   - [用户登录](#用户登录)
   - [获取用户信息](#获取用户信息)
   - [修改密码](#修改密码)
5. [JWT Token 机制](#jwt-token-机制)
6. [前端调用示例](#前端调用示例)

## 认证机制

系统使用 JWT (JSON Web Token) 进行身份验证。

### 认证流程

1. 用户通过 `/api/v1/auth/login` 接口登录，获取 JWT Token
2. 后续请求在 HTTP Header 中携带 Token:
   ```
   Authorization: Bearer <token>
   ```
3. Token 有效期为配置文件中指定的时间（默认 24 小时）
4. Token 过期后需要重新登录

### 权限级别

- **普通用户 (user)**: 可以查看节点信息、执行任务
- **管理员 (admin)**: 拥有所有权限，包括用户管理、节点删除等

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#1-认证)
- [auth.go](file://manager/internal/middleware/auth.go#L12-L49)

## 响应格式

所有 API 接口统一返回以下格式的 JSON 响应:

### 成功响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 具体数据
  },
  "timestamp": "2025-12-03T10:00:00Z"
}
```

### 错误响应

```json
{
  "code": 1001,
  "message": "invalid parameter",
  "details": "username is required",
  "timestamp": "2025-12-03T10:00:00Z"
}
```

### 分页数据响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      // 数据列表
    ],
    "page_info": {
      "page": 1,
      "page_size": 20,
      "total": 100,
      "total_pages": 5
    }
  },
  "timestamp": "2025-12-03T10:00:00Z"
}
```

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#2-响应格式)
- [response.go](file://manager/pkg/response/response.go#L11-L31)

## 错误码

| 错误码 | 说明 | HTTP 状态码 |
|--------|------|-------------|
| 0 | 成功 | 200 |
| 1001 | 无效的参数 | 400 |
| 1002 | 认证失败 | 401 |
| 1003 | 无权限 | 403 |
| 1004 | 资源不存在 | 404 |
| 1007 | Token 无效 | 401 |
| 1008 | Token 已过期 | 401 |
| 1009 | 用户名或密码错误 | 401 |
| 2007 | 用户不存在 | 404 |
| 2008 | 用户已禁用 | 403 |
| 2009 | 用户已存在 | 409 |
| 5001 | 服务器内部错误 | 500 |
| 5002 | 数据库错误 | 500 |

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#3-错误码)
- [errors.go](file://manager/pkg/errors/errors.go#L8-L131)

## API 接口

### 用户注册

**接口**: `POST /api/v1/auth/register`

**描述**: 注册新用户

**权限**: 无需认证

**请求头**:
```
Content-Type: application/json
```

**请求体**:
```json
{
  "username": "testuser",
  "password": "password123",
  "email": "test@example.com"
}
```

**请求参数说明**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名，3-20个字符 |
| password | string | 是 | 密码，至少6个字符 |
| email | string | 是 | 邮箱地址 |

**成功响应** (201):
```json
{
  "code": 0,
  "message": "user registered successfully",
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "role": "user",
      "status": "active",
      "created_at": "2025-12-03T10:00:00Z"
    }
  },
  "timestamp": "2025-12-03T10:00:00Z"
}
```

**错误响应**:
- 400: 参数错误
- 409: 用户已存在 (错误码 2009)
- 500: 服务器内部错误

**curl 调用示例**:
```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123",
    "email": "test@example.com"
  }'
```

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#411-用户注册)
- [auth.go](file://manager/internal/handler/auth.go#L45-L69)
- [auth.go](file://manager/internal/service/auth.go#L66-L114)

### 用户登录

**接口**: `POST /api/v1/auth/login`

**描述**: 用户登录获取 JWT Token

**权限**: 无需认证

**请求头**:
```
Content-Type: application/json
```

**请求体**:
```json
{
  "username": "testuser",
  "password": "password123"
}
```

**请求参数说明**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**成功响应** (200):
```json
{
  "code": 0,
  "message": "login successful",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "role": "user",
      "status": "active"
    }
  },
  "timestamp": "2025-12-03T10:00:00Z"
}
```

**错误响应**:
- 401: 用户名或密码错误 (错误码 1009)
- 403: 用户已被禁用 (错误码 2008)
- 500: 服务器内部错误

**curl 调用示例**:
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123"
  }'
```

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#412-用户登录)
- [auth.go](file://manager/internal/handler/auth.go#L71-L96)
- [auth.go](file://manager/internal/service/auth.go#L116-L153)

### 获取用户信息

**接口**: `GET /api/v1/auth/profile`

**描述**: 获取当前登录用户的个人信息

**权限**: 需要认证

**请求头**:
```
Authorization: Bearer <token>
```

**成功响应** (200):
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "role": "user",
      "status": "active",
      "created_at": "2025-12-03T10:00:00Z",
      "updated_at": "2025-12-03T10:00:00Z",
      "last_login_at": "2025-12-03T10:00:00Z",
      "last_login_ip": "192.168.1.100"
    }
  },
  "timestamp": "2025-12-03T10:00:00Z"
}
```

**错误响应**:
- 401: Token 无效或已过期
- 500: 服务器内部错误

**curl 调用示例**:
```bash
curl -X GET http://localhost:8080/api/v1/auth/profile \
  -H "Authorization: Bearer <token>"
```

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#413-获取当前用户信息)
- [auth.go](file://manager/internal/handler/auth.go#L98-L122)
- [auth.go](file://manager/internal/service/auth.go#L226-L237)

### 修改密码

**接口**: `POST /api/v1/auth/change-password`

**描述**: 修改当前用户密码

**权限**: 需要认证

**请求头**:
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体**:
```json
{
  "old_password": "password123",
  "new_password": "newpassword456"
}
```

**请求参数说明**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| old_password | string | 是 | 原密码 |
| new_password | string | 是 | 新密码，至少6个字符 |

**成功响应** (200):
```json
{
  "code": 0,
  "message": "password changed successfully",
  "data": null,
  "timestamp": "2025-12-03T10:00:00Z"
}
```

**错误响应**:
- 400: 参数错误
- 401: 原密码错误或 Token 无效
- 500: 服务器内部错误

**curl 调用示例**:
```bash
curl -X POST http://localhost:8080/api/v1/auth/change-password \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "old_password": "password123",
    "new_password": "newpassword456"
  }'
```

**Section sources**
- [Manager_API.md](file://docs/api/Manager_API.md#414-修改密码)
- [auth.go](file://manager/internal/handler/auth.go#L124-L150)
- [auth.go](file://manager/internal/service/auth.go#L171-L204)

## JWT Token 机制

### 生成机制

JWT Token 由 `pkg/jwt/jwt.go` 中的 `Manager` 结构体生成，包含以下声明:

- `user_id`: 用户ID
- `username`: 用户名
- `role`: 用户角色
- 标准声明: `iss` (签发者), `iat` (签发时间), `exp` (过期时间), `nbf` (生效时间)

### 有效期管理

根据配置文件 `manager/configs/manager.yaml` 中的设置:

```yaml
jwt:
  secret: "your-secret-key-change-this-in-production"
  expire_time: 24h
  issuer: "ops-manager"
```

- **有效期**: 24小时
- **签发者**: ops-manager
- **密钥**: 用于签名的密钥，生产环境需要修改

Token 过期后，客户端需要重新登录获取新 Token。

### 权限级别控制

权限控制通过 JWT Token 中的 `role` 字段实现:

- `role: "user"`: 普通用户，只能访问基本功能
- `role: "admin"`: 管理员，拥有所有权限

在中间件 `middleware/auth.go` 中通过 `RequireAdmin()` 函数检查管理员权限:

```go
func RequireAdmin() gin.HandlerFunc {
	return func(c *gin.Context) {
		role, exists := c.Get("role")
		if !exists {
			response.Error(c, errors.ErrUnauthorizedMsg)
			c.Abort()
			return
		}

		if role != "admin" {
			response.Error(c, errors.ErrForbiddenMsg)
			c.Abort()
			return
		}

		c.Next()
	}
}
```

**Section sources**
- [jwt.go](file://manager/pkg/jwt/jwt.go#L19-L140)
- [manager.yaml](file://manager/configs/manager.yaml#L38-L43)
- [auth.go](file://manager/internal/middleware/auth.go#L52-L69)

## 前端调用示例

### TypeScript 前端调用

基于 `web/src/api/auth.ts` 文件中的实现:

```typescript
/**
 * 用户登录
 */
export function login(data: LoginRequest): Promise<APIResponse<LoginResponse>> {
  return client.post('/api/v1/auth/login', data).then((res) => res.data);
}

/**
 * 用户注册
 */
export function register(data: RegisterRequest): Promise<APIResponse<RegisterResponse>> {
  return client.post('/api/v1/auth/register', data).then((res) => res.data);
}

/**
 * 获取用户资料
 */
export function getProfile(): Promise<APIResponse<{ user: User }>> {
  return client.get('/api/v1/auth/profile').then((res) => res.data);
}

/**
 * 修改密码
 */
export function changePassword(data: ChangePasswordRequest): Promise<APIResponse> {
  return client.post('/api/v1/auth/change-password', data).then((res) => res.data);
}
```

### 使用示例

```typescript
// 用户登录
const loginData = {
  username: 'testuser',
  password: 'password123'
};

login(loginData)
  .then(response => {
    if (response.code === 0) {
      const { token, user } = response.data;
      // 存储Token
      localStorage.setItem('token', token);
      console.log('登录成功:', user);
    } else {
      console.error('登录失败:', response.message);
    }
  })
  .catch(error => {
    console.error('请求失败:', error);
  });

// 获取用户信息
getProfile()
  .then(response => {
    if (response.code === 0) {
      const { user } = response.data;
      console.log('用户信息:', user);
    } else {
      console.error('获取用户信息失败:', response.message);
    }
  });

// 修改密码
const passwordData = {
  old_password: 'oldpassword',
  new_password: 'newpassword123'
};

changePassword(passwordData)
  .then(response => {
    if (response.code === 0) {
      console.log('密码修改成功');
    } else {
      console.error('密码修改失败:', response.message);
    }
  });
```

**Section sources**
- [auth.ts](file://web/src/api/auth.ts#L1-L43)
- [user.ts](file://web/src/types/user.ts#L1-L52)