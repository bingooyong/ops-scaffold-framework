# 开发与测试

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [QUICKSTART.md](file://QUICKSTART.md)
- [agent/Makefile](file://agent/Makefile)
- [daemon/Makefile](file://daemon/Makefile)
- [manager/Makefile](file://manager/Makefile)
- [web/TESTING.md](file://web/TESTING.md)
- [web/vitest.config.ts](file://web/vitest.config.ts)
- [web/package.json](file://web/package.json)
- [test/integration/README.md](file://test/integration/README.md)
- [test/integration/start_test_env.sh](file://test/integration/start_test_env.sh)
- [test/integration/cleanup_test_env.sh](file://test/integration/cleanup_test_env.sh)
- [test/integration/verify_test_env.sh](file://test/integration/verify_test_env.sh)
- [daemon/test/run_integration_tests.sh](file://daemon/test/run_integration_tests.sh)
- [manager/test/run_tests.sh](file://manager/test/run_tests.sh)
- [web/src/test/setup.ts](file://web/src/test/setup.ts)
- [daemon/.golangci.yml](file://daemon/.golangci.yml)
</cite>

## 目录

1. [开发环境搭建](#开发环境搭建)
2. [构建与运行](#构建与运行)
3. [测试策略](#测试策略)
4. [代码质量要求](#代码质量要求)
5. [调试技巧](#调试技巧)
6. [代码提交规范](#代码提交规范)
7. [CI/CD流水线](#cicd流水线)

## 开发环境搭建

本项目包含Go和Node.js两种技术栈，需要分别配置开发环境。

### Go环境配置

根据项目要求，需要安装Go 1.21+版本。项目包含三个Go模块：`agent`、`daemon`和`manager`，每个模块都有独立的`go.mod`文件。

Go模块的依赖管理通过`go mod`命令完成。每个模块的Makefile中都提供了`deps`目标来下载和整理依赖：

```makefile
deps:
	@echo "Installing dependencies..."
	@go mod download
	@go mod tidy
```

**Section sources**
- [QUICKSTART.md](file://QUICKSTART.md#L7-L8)
- [agent/Makefile](file://agent/Makefile#L32-L37)
- [daemon/Makefile](file://daemon/Makefile#L74-L78)
- [manager/Makefile](file://manager/Makefile#L75-L79)

### Node.js环境配置

前端项目位于`web`目录，需要Node.js 18+版本。通过npm安装依赖：

```bash
cd web
npm install
```

如果遇到依赖冲突，可以使用`--legacy-peer-deps`参数：

```bash
npm install --legacy-peer-deps
```

前端项目的依赖在`package.json`中定义，包括React、Vitest、MUI等库。

**Section sources**
- [QUICKSTART.md](file://QUICKSTART.md#L8-L9)
- [web/package.json](file://web/package.json#L1-L57)

## 构建与运行

项目使用Makefile作为构建工具，每个主要模块都有自己的Makefile。

### Agent模块构建

Agent模块的Makefile提供了以下主要目标：

- `build`: 构建agent二进制文件
- `run`: 运行agent（使用默认配置）
- `test`: 运行测试
- `lint`: 运行代码检查
- `install`: 安装到系统

```bash
cd agent
make build
make run
```

**Section sources**
- [agent/Makefile](file://agent/Makefile#L1-L93)

### Daemon模块构建

Daemon模块的Makefile功能更丰富，包括版本信息注入、覆盖率测试和Docker构建：

- `build`: 构建daemon二进制文件
- `test-coverage`: 运行测试并生成覆盖率报告
- `proto`: 生成protobuf代码
- `docker-build`: 构建Docker镜像

```bash
cd daemon
make build
make test-coverage
```

**Section sources**
- [daemon/Makefile](file://daemon/Makefile#L1-L121)

### Manager模块构建

Manager模块的Makefile与Daemon类似，但增加了数据库迁移功能：

- `migrate-up`: 运行数据库迁移
- `migrate-down`: 回滚数据库迁移
- `migrate-create`: 创建新的迁移文件

```bash
cd manager
make run-dev  # 以开发模式运行
make migrate-up  # 运行数据库迁移
```

**Section sources**
- [manager/Makefile](file://manager/Makefile#L1-L128)

## 测试策略

项目采用测试金字塔策略，包含单元测试、集成测试和端到端测试。

### 测试金字塔

项目遵循测试金字塔原则，从底层到高层依次为：

1. **单元测试**：测试单个函数或方法
2. **集成测试**：测试模块间的交互
3. **端到端测试**：测试完整的业务流程

这种分层测试策略确保了代码质量和系统稳定性。

**Section sources**
- [web/TESTING.md](file://web/TESTING.md#L1-L129)
- [test/integration/README.md](file://test/integration/README.md#L1-L140)

### 单元测试

#### Go单元测试

Go代码使用标准的`testing`包进行单元测试。通过`go test`命令运行测试：

```bash
# 运行所有测试
go test -v ./...

# 运行测试并检查竞态条件
go test -v -race ./...

# 运行测试并生成覆盖率报告
go test -v -coverprofile=coverage.out ./...
```

每个Go模块的Makefile中都包含了`test`目标，通常会启用竞态检测和超时设置。

**Section sources**
- [agent/Makefile](file://agent/Makefile#L21-L25)
- [daemon/Makefile](file://daemon/Makefile#L42-L45)
- [manager/Makefile](file://manager/Makefile#L42-L45)

#### TypeScript单元测试

前端代码使用Vitest进行单元测试。测试脚本定义在`package.json`中：

```json
"scripts": {
  "test": "vitest",
  "test:ui": "vitest --ui",
  "test:coverage": "vitest --coverage"
}
```

Vitest配置文件`vitest.config.ts`中定义了测试环境、设置文件和覆盖率配置。

```typescript
export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
    },
  },
});
```

**Section sources**
- [web/TESTING.md](file://web/TESTING.md#L22-L34)
- [web/package.json](file://web/package.json#L11-L13)
- [web/vitest.config.ts](file://web/vitest.config.ts#L1-L34)

### 集成测试

集成测试位于`test/integration/`目录下，模拟端到端场景。

#### 完整系统集成测试

`test/integration/`目录包含完整的系统集成测试环境，可以启动所有服务进行集成测试：

- `start_test_env.sh`: 启动测试环境
- `cleanup_test_env.sh`: 清理测试环境
- `verify_test_env.sh`: 验证测试环境

```bash
cd test/integration
./start_test_env.sh  # 启动测试环境
./verify_test_env.sh  # 验证环境
./cleanup_test_env.sh  # 清理环境
```

该测试环境会启动：
- Manager服务（HTTP: 8080, gRPC: 9090）
- Daemon服务（gRPC: 9091）
- 3个测试Agent实例（HTTP: 8081, 8082, 8083）

**Section sources**
- [test/integration/README.md](file://test/integration/README.md#L1-L140)
- [test/integration/start_test_env.sh](file://test/integration/start_test_env.sh#L1-L366)
- [test/integration/cleanup_test_env.sh](file://test/integration/cleanup_test_env.sh#L1-L143)
- [test/integration/verify_test_env.sh](file://test/integration/verify_test_env.sh#L1-L222)

#### 模块集成测试

各模块也有自己的集成测试脚本：

- `daemon/test/run_integration_tests.sh`: 运行Daemon的集成测试
- `manager/test/run_tests.sh`: 运行Manager的集成测试

这些脚本支持通过参数控制测试范围：

```bash
# 运行Daemon的gRPC和端到端测试
./daemon/test/run_integration_tests.sh -grpc -e2e

# 运行Manager的Agent API和gRPC测试
./manager/test/run_tests.sh -agent -grpc
```

**Section sources**
- [daemon/test/run_integration_tests.sh](file://daemon/test/run_integration_tests.sh#L1-L91)
- [manager/test/run_tests.sh](file://manager/test/run_tests.sh#L1-L166)

### 端到端测试

端到端测试使用构建标签`e2e`来区分，避免与普通测试冲突。运行端到端测试需要设置环境变量：

```bash
GOLANG_PROTOBUF_REGISTRATION_CONFLICT=warn go test -v -tags=e2e ./test/integration/...
```

前端的端到端测试可以通过Vitest UI进行交互式测试：

```bash
npm run test:ui
```

**Section sources**
- [daemon/test/run_integration_tests.sh](file://daemon/test/run_integration_tests.sh#L55-L64)
- [manager/test/run_tests.sh](file://manager/test/run_tests.sh#L109-L121)

## 代码质量要求

项目有严格的代码质量要求，确保代码的可维护性和稳定性。

### 静态代码检查

Go代码使用`golangci-lint`进行静态检查。每个Go模块的Makefile中都提供了`lint`目标：

```makefile
lint:
	@echo "Running linter..."
	@golangci-lint run
```

`daemon`和`manager`模块的`.golangci.yml`配置文件定义了详细的检查规则。

**Section sources**
- [agent/Makefile](file://agent/Makefile#L43-L47)
- [daemon/Makefile](file://daemon/Makefile#L52-L55)
- [manager/Makefile](file://manager/Makefile#L52-L55)
- [daemon/.golangci.yml](file://daemon/.golangci.yml)

### 单元测试覆盖率

项目要求单元测试覆盖率超过70%。通过`go test`的`-cover`参数生成覆盖率报告：

```bash
go test -coverprofile=coverage.out ./...
go tool cover -func=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

`daemon`和`manager`模块的Makefile中提供了`test-coverage`目标来生成覆盖率报告。

**Section sources**
- [daemon/Makefile](file://daemon/Makefile#L46-L51)
- [manager/Makefile](file://manager/Makefile#L46-L51)

### 前端测试覆盖率目标

前端项目有更详细的覆盖率目标：

- API客户端: > 80%
- 组件: > 70%
- Hooks: > 80%
- Utils: > 90%

这些目标在`web/TESTING.md`中有明确说明。

**Section sources**
- [web/TESTING.md](file://web/TESTING.md#L117-L123)

## 调试技巧

### 日志调试

各服务的日志保存在`test/integration/logs/`目录下：

- `logs/manager.log`: Manager服务日志
- `logs/daemon.log`: Daemon服务日志
- `logs/agent-*.log`: Agent服务日志

可以通过`tail`命令实时查看日志：

```bash
tail -f test/integration/logs/manager.log
```

**Section sources**
- [test/integration/README.md](file://test/integration/README.md#L70-L71)

### 环境验证

使用`verify_test_env.sh`脚本验证测试环境的健康状态：

```bash
./test/integration/verify_test_env.sh
```

该脚本会检查所有服务的进程状态、端口监听和HTTP健康检查端点，并生成验证报告。

**Section sources**
- [test/integration/verify_test_env.sh](file://test/integration/verify_test_env.sh#L1-L222)

### 浏览器开发者工具

前端开发时，可以使用浏览器开发者工具（F12）查看网络请求、控制台输出和性能分析。

**Section sources**
- [QUICKSTART.md](file://QUICKSTART.md#L183-L184)

## 代码提交规范

### 提交前检查

在提交代码前，应确保通过所有检查：

```bash
# 运行所有检查
make all  # 对于Go模块
npm run lint  # 对于前端模块
```

`make all`通常会执行`lint`、`test`和`build`。

**Section sources**
- [daemon/Makefile](file://daemon/Makefile#L24)
- [manager/Makefile](file://manager/Makefile#L24)

### 测试覆盖率

确保新增代码有足够的测试覆盖，特别是核心业务逻辑。

**Section sources**
- [web/TESTING.md](file://web/TESTING.md#L117-L123)

## CI/CD流水线

### 预期行为

CI/CD流水线应执行以下步骤：

1. 安装依赖
2. 运行静态检查
3. 运行单元测试
4. 生成覆盖率报告
5. 构建二进制文件或包
6. 运行集成测试

### 测试执行

CI/CD中应运行所有类型的测试：

```bash
# Go模块
make test-coverage

# 前端模块
npm run test:coverage
```

### 覆盖率报告

生成的覆盖率报告应上传到代码质量平台，确保覆盖率达标。

**Section sources**
- [daemon/Makefile](file://daemon/Makefile#L46-L51)
- [manager/Makefile](file://manager/Makefile#L46-L51)
- [web/package.json](file://web/package.json#L13)