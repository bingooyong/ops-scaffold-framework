# 运维工具框架代码生成计划

**项目名称：** Ops Scaffold Framework
**文档版本：** 1.0
**创建日期：** 2025-12-02
**文档状态：** 进行中

---

## 目录

1. [计划概述](#1-计划概述)
2. [开发原则](#2-开发原则)
3. [技术栈与工具](#3-技术栈与工具)
4. [第一阶段：Daemon 模块开发](#4-第一阶段daemon-模块开发)
5. [第二阶段：Agent 模块开发](#5-第二阶段agent-模块开发)
6. [第三阶段：Manager 后端模块开发](#6-第三阶段manager-后端模块开发)
7. [第四阶段：Web 前端模块开发](#7-第四阶段web-前端模块开发)
8. [第五阶段：集成测试](#8-第五阶段集成测试)
9. [验收标准](#9-验收标准)

---

## 1. 计划概述

### 1.1 开发目标

构建一个轻量级、高可用的分布式运维管理平台，包含三个核心组件：
- **Daemon**：运行在被管主机上的守护进程，负责资源采集、Agent 管理和版本更新
- **Agent**：运行在被管主机上的任务执行进程，提供 HTTP API 接口
- **Manager**：中心管理节点，提供 Web 界面和 API 服务

### 1.2 开发顺序

```
Phase 1: Daemon 模块 (独立运行+自测试) →
Phase 2: Agent 模块 (独立运行+自测试) →
Phase 3: Manager 后端模块 (与 Daemon/Agent 集成) →
Phase 4: Web 前端模块 (基于 Manager API) →
Phase 5: 集成测试
```

### 1.3 里程碑

| 阶段 | 里程碑 | 预估时间 | 验收标准 |
|------|--------|----------|----------|
| Phase 1 | Daemon 模块完成 | 3 周 | 独立运行、资源采集、Agent 管理、自测试通过 |
| Phase 2 | Agent 模块完成 | 2 周 | 独立运行、任务执行、API 可用、自测试通过 |
| Phase 3 | Manager 后端完成 | 3 周 | 后端完成、与 Daemon/Agent 通信、自测试通过 |
| Phase 4 | Web 前端完成 | 2 周 | 前端界面完成、API对接、功能验收通过 |
| Phase 5 | 集成测试完成 | 1 周 | 端到端测试通过、性能指标达标 |

---

## 2. 开发原则

### 2.1 代码质量原则

1. **测试驱动开发 (TDD)**：先写测试，再写实现
2. **单元测试覆盖率**：核心模块 > 80%，总体 > 70%
3. **代码规范**：遵循 Go 官方编码规范，使用 `golangci-lint` 检查
4. **文档同步**：代码注释完整，API 文档自动生成

### 2.2 模块独立性原则

1. **独立运行**：每个模块可单独编译、运行、测试
2. **Mock 依赖**：使用 Mock 模拟未完成的依赖模块
3. **配置隔离**：每个模块有独立的配置文件
4. **数据隔离**：Manager 使用数据库，Daemon/Agent 使用本地文件

### 2.3 安全优先原则

1. **通信加密**：所有网络通信使用 TLS
2. **输入验证**：严格验证所有外部输入
3. **最小权限**：进程以最小权限运行
4. **安全审计**：记录所有敏感操作

---

## 3. 技术栈与工具

### 3.1 开发环境

| 工具 | 版本 | 用途 |
|------|------|------|
| Go | 1.21+ | 主要编程语言 |
| MySQL | 8.0+ | Manager 数据存储 |
| Redis | 7.0+ | Manager 缓存 |
| Git | 2.x | 版本控制 |
| Make | - | 构建工具 |

### 3.2 Go 依赖库

```go
// 核心依赖
github.com/gin-gonic/gin                 v1.10.1  // Web 框架 (Manager)
gorm.io/gorm                             v1.31.0  // ORM (Manager)
gorm.io/driver/mysql                     v1.31.0  // MySQL 驱动
github.com/go-redis/redis/v8             v8.11.5  // Redis 客户端
google.golang.org/grpc                   v1.59.0  // gRPC
google.golang.org/protobuf               v1.31.0  // Protobuf

// 工具库
github.com/shirou/gopsutil/v3            v3.23.0  // 系统资源采集
github.com/robfig/cron/v3                v3.0.1   // 定时任务
go.uber.org/zap                          v1.26.0  // 日志
github.com/spf13/viper                   v1.18.0  // 配置管理
github.com/google/uuid                   v1.5.0   // UUID 生成

// 测试库
github.com/stretchr/testify              v1.8.4   // 测试断言
github.com/golang/mock                   v1.6.0   // Mock 生成
```

### 3.3 开发工具

```bash
# 代码质量工具
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# Mock 生成工具
go install github.com/golang/mock/mockgen@latest

# Protobuf 工具
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# 测试覆盖率工具
go install github.com/axw/gocov/gocov@latest
go install github.com/matm/gocov-html@latest
```

---

## 4. 第一阶段：Daemon 模块开发

### 4.1 模块概述

**功能定位**：运行在被管主机的守护进程，负责资源采集、Agent 进程管理和版本更新。

**关键指标**：
- CPU 占用 < 1% (空闲时)
- 内存占用 < 30MB
- 资源采集间隔：60 秒
- Agent 健康检查间隔：30 秒

### 4.2 目录结构

```
daemon/
├── cmd/
│   └── daemon/
│       └── main.go                    # 入口文件
├── internal/
│   ├── config/
│   │   ├── config.go                  # 配置结构定义
│   │   └── loader.go                  # 配置加载
│   ├── collector/
│   │   ├── collector.go               # 采集器接口
│   │   ├── manager.go                 # 采集器管理
│   │   ├── cpu.go                     # CPU 采集器
│   │   ├── memory.go                  # 内存采集器
│   │   ├── disk.go                    # 磁盘采集器
│   │   └── network.go                 # 网络采集器
│   ├── agent/
│   │   ├── manager.go                 # Agent 进程管理
│   │   ├── health.go                  # 健康检查
│   │   └── heartbeat.go               # 心跳接收
│   ├── updater/
│   │   ├── updater.go                 # 更新管理器
│   │   ├── downloader.go              # 下载器
│   │   ├── verifier.go                # 验证器
│   │   └── backuper.go                # 备份器
│   ├── comm/
│   │   ├── grpc_client.go             # gRPC 客户端 (连接 Manager)
│   │   └── socket_server.go           # Socket 服务端 (监听 Agent)
│   └── daemon/
│       ├── daemon.go                  # Daemon 主逻辑
│       └── signal.go                  # 信号处理
├── pkg/
│   ├── proto/
│   │   ├── daemon.proto               # Protobuf 定义
│   │   └── daemon.pb.go               # 生成的 Go 代码
│   └── types/
│       └── types.go                   # 公共类型定义
├── configs/
│   ├── daemon.yaml                    # 配置文件模板
│   └── daemon.example.yaml            # 配置文件示例
├── scripts/
│   ├── install.sh                     # 安装脚本
│   └── systemd/
│       └── daemon.service             # systemd 服务文件
├── test/
│   ├── integration/                   # 集成测试
│   └── testdata/                      # 测试数据
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

### 4.3 开发任务分解

#### 4.3.1 Week 1: 基础框架搭建

**任务列表**：

1. **项目初始化** (Day 1)
   - [ ] 创建目录结构
   - [ ] 初始化 Go Module：`go mod init daemon`
   - [ ] 编写 Makefile (build, test, lint, clean 目标)
   - [ ] 配置 golangci-lint (.golangci.yml)
   - [ ] 编写 README.md

2. **配置管理** (Day 1-2)
   - [ ] 定义配置结构 (`internal/config/config.go`)
   - [ ] 实现配置加载器 (支持 YAML 文件)
   - [ ] 实现环境变量覆盖
   - [ ] 编写单元测试
   - [ ] 创建配置示例文件

3. **日志系统** (Day 2)
   - [ ] 集成 zap 日志库
   - [ ] 实现日志轮转
   - [ ] 支持不同日志级别
   - [ ] 编写日志工具函数

4. **主程序框架** (Day 3)
   - [ ] 实现 main.go 入口
   - [ ] 实现 Daemon 结构体
   - [ ] 实现启动流程
   - [ ] 实现优雅退出 (信号处理)
   - [ ] 编写集成测试

5. **单元测试** (Day 4)
   - [ ] 配置加载测试
   - [ ] 日志系统测试
   - [ ] 启动/退出流程测试
   - [ ] 确保测试覆盖率 > 80%

**验收标准**：
```bash
# 可以编译运行
make build
./bin/daemon -config configs/daemon.yaml

# 单元测试通过
make test
# 覆盖率 > 80%

# 代码检查通过
make lint
```

#### 4.3.2 Week 2: 资源采集模块

**任务列表**：

1. **采集器接口设计** (Day 1)
   - [ ] 定义 Collector 接口
   - [ ] 定义 Metrics 数据结构
   - [ ] 实现 CollectorManager

2. **CPU 采集器** (Day 2)
   - [ ] 使用 gopsutil 采集 CPU 信息
   - [ ] 实现 CPU 使用率计算
   - [ ] 采集多核心信息
   - [ ] 编写单元测试

3. **内存采集器** (Day 2)
   - [ ] 采集内存总量、已用、可用
   - [ ] 采集 Swap 信息
   - [ ] 采集 Cache/Buffer
   - [ ] 编写单元测试

4. **磁盘采集器** (Day 3)
   - [ ] 采集磁盘使用率
   - [ ] 采集各挂载点信息
   - [ ] 采集磁盘 IO 统计
   - [ ] 支持配置监控的挂载点
   - [ ] 编写单元测试

5. **网络采集器** (Day 3)
   - [ ] 采集网络流量统计
   - [ ] 采集各网卡信息
   - [ ] 采集错误/丢包统计
   - [ ] 支持配置监控的网卡
   - [ ] 编写单元测试

6. **采集器管理** (Day 4)
   - [ ] 实现定时采集调度
   - [ ] 实现采集结果缓存
   - [ ] 实现采集器并发控制
   - [ ] 编写集成测试

7. **性能测试** (Day 5)
   - [ ] 测试采集性能 (< 500ms)
   - [ ] 测试资源占用 (CPU < 1%, 内存 < 30MB)
   - [ ] 压力测试
   - [ ] 性能优化

**验收标准**：
```bash
# 运行 Daemon，查看采集日志
./bin/daemon -config configs/daemon.yaml

# 单元测试通过
make test-collector

# 性能指标达标
# - 单次采集 < 500ms
# - CPU 占用 < 1%
# - 内存占用 < 30MB
```

#### 4.3.3 Week 3: Agent 管理模块

**任务列表**：

1. **进程管理** (Day 1-2)
   - [ ] 实现 ProcessManager
   - [ ] 实现 Agent 启动 (独立进程)
   - [ ] 实现 Agent 停止 (优雅退出)
   - [ ] 实现 Agent 重启
   - [ ] 实现退避重启策略
   - [ ] 编写单元测试

2. **健康检查** (Day 2-3)
   - [ ] 实现 HealthChecker
   - [ ] 实现进程存活检测
   - [ ] 实现心跳超时检测
   - [ ] 实现资源超限检测
   - [ ] 编写单元测试

3. **心跳接收** (Day 3)
   - [ ] 实现 Unix Socket 服务器
   - [ ] 实现心跳数据接收
   - [ ] 实现心跳数据解析
   - [ ] 编写单元测试

4. **Mock Agent** (Day 4)
   - [ ] 编写 Mock Agent 程序 (用于测试)
   - [ ] Mock Agent 发送心跳
   - [ ] Mock Agent 模拟崩溃
   - [ ] Mock Agent 模拟资源超限

5. **集成测试** (Day 5)
   - [ ] 测试 Agent 自动启动
   - [ ] 测试 Agent 崩溃重启
   - [ ] 测试 Agent 资源超限重启
   - [ ] 测试 Daemon 退出后 Agent 继续运行
   - [ ] 测试重启退避策略

**验收标准**：
```bash
# 启动 Daemon，自动启动 Mock Agent
./bin/daemon -config configs/daemon.yaml

# 观察日志，验证：
# 1. Agent 启动成功
# 2. 收到 Agent 心跳
# 3. 健康检查正常

# 杀死 Agent 进程，验证自动重启
kill -9 <agent_pid>

# 观察日志，验证重启成功

# 停止 Daemon，验证 Agent 继续运行
kill <daemon_pid>
# 检查 Agent 进程仍在运行
```

### 4.4 版本更新模块 (可选，Phase 1 暂不实现)

> **注意**：版本更新模块依赖 Manager，可在 Phase 3 完成 Manager 后再实现。
> Phase 1 重点是资源采集和 Agent 管理。

### 4.5 Daemon 自测试方案

#### 4.5.1 单元测试

```bash
# 运行所有单元测试
make test

# 运行指定包的测试
go test -v ./internal/collector/...

# 生成覆盖率报告
make coverage
```

#### 4.5.2 集成测试

创建 `test/integration/daemon_test.go`：

```go
// 测试 Daemon 启动和退出
func TestDaemonStartStop(t *testing.T) {
    // 启动 Daemon
    daemon := NewDaemon(config)
    go daemon.Start()

    time.Sleep(2 * time.Second)

    // 验证 Daemon 运行中
    assert.True(t, daemon.IsRunning())

    // 停止 Daemon
    daemon.Stop()

    // 验证 Daemon 已停止
    assert.False(t, daemon.IsRunning())
}

// 测试资源采集
func TestResourceCollection(t *testing.T) {
    daemon := NewDaemon(config)
    go daemon.Start()
    defer daemon.Stop()

    // 等待采集完成
    time.Sleep(2 * time.Second)

    // 获取采集结果
    metrics := daemon.GetLatestMetrics()

    // 验证采集数据
    assert.NotNil(t, metrics)
    assert.True(t, metrics.CPU > 0)
    assert.True(t, metrics.Memory > 0)
}

// 测试 Agent 管理
func TestAgentManagement(t *testing.T) {
    daemon := NewDaemon(config)
    go daemon.Start()
    defer daemon.Stop()

    // 等待 Agent 启动
    time.Sleep(2 * time.Second)

    // 验证 Agent 运行中
    agentStatus := daemon.GetAgentStatus()
    assert.Equal(t, "running", agentStatus.Status)

    // 模拟 Agent 崩溃
    daemon.KillAgent()

    // 等待自动重启
    time.Sleep(3 * time.Second)

    // 验证 Agent 已重启
    agentStatus = daemon.GetAgentStatus()
    assert.Equal(t, "running", agentStatus.Status)
}
```

#### 4.5.3 手动测试

```bash
# 1. 启动 Daemon
./bin/daemon -config configs/daemon.yaml

# 2. 查看日志
tail -f /var/log/daemon/daemon.log

# 3. 验证资源采集
# 观察日志输出的采集数据

# 4. 验证 Agent 管理
# 查看 Agent 进程
ps aux | grep agent

# 杀死 Agent
kill -9 <agent_pid>

# 观察 Daemon 日志，验证自动重启

# 5. 验证优雅退出
kill <daemon_pid>

# 验证 Agent 仍在运行
ps aux | grep agent
```

### 4.6 Phase 1 验收清单

**功能验收**：
- [ ] Daemon 可正常启动和退出
- [ ] 配置文件可正确加载
- [ ] 日志可正常输出和轮转
- [ ] CPU 采集功能正常，数据准确
- [ ] 内存采集功能正常，数据准确
- [ ] 磁盘采集功能正常，数据准确
- [ ] 网络采集功能正常，数据准确
- [ ] 采集间隔可配置（60 秒）
- [ ] Agent 可自动启动
- [ ] Agent 崩溃后可自动重启
- [ ] Agent 资源超限可自动重启
- [ ] 重启退避策略生效
- [ ] Daemon 退出后 Agent 继续运行

**性能验收**：
- [ ] Daemon CPU 占用 < 1% (空闲时)
- [ ] Daemon 内存占用 < 30MB
- [ ] 单次资源采集耗时 < 500ms

**代码质量验收**：
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] golangci-lint 检查通过
- [ ] 代码注释完整
- [ ] README 文档完整

---

## 5. 第二阶段：Agent 模块开发

### 5.1 模块概述

**功能定位**：运行在被管主机的任务执行进程，提供 HTTP/HTTPS API 接口。

**关键指标**：
- CPU 占用 < 1% (空闲时)
- 内存占用 < 50MB
- API 响应延迟 < 100ms
- 支持 10 并发任务

### 5.2 目录结构

```
agent/
├── cmd/
│   └── agent/
│       └── main.go                    # 入口文件
├── internal/
│   ├── config/
│   │   ├── config.go                  # 配置结构定义
│   │   └── loader.go                  # 配置加载
│   ├── server/
│   │   ├── server.go                  # HTTP 服务器
│   │   ├── router.go                  # 路由注册
│   │   ├── middleware.go              # 中间件
│   │   └── handler/
│   │       ├── health.go              # 健康检查 Handler
│   │       ├── status.go              # 状态查询 Handler
│   │       ├── task.go                # 任务执行 Handler
│   │       └── file.go                # 文件操作 Handler
│   ├── task/
│   │   ├── queue.go                   # 任务队列
│   │   ├── worker.go                  # Worker Pool
│   │   └── result.go                  # 结果存储
│   ├── executor/
│   │   ├── executor.go                # 执行器接口
│   │   ├── script.go                  # 脚本执行器
│   │   ├── file.go                    # 文件执行器
│   │   └── service.go                 # 服务执行器
│   ├── heartbeat/
│   │   └── sender.go                  # 心跳发送器
│   └── agent/
│       ├── agent.go                   # Agent 主逻辑
│       └── signal.go                  # 信号处理
├── pkg/
│   └── types/
│       └── types.go                   # 公共类型定义
├── configs/
│   ├── agent.yaml                     # 配置文件模板
│   └── agent.example.yaml             # 配置文件示例
├── test/
│   ├── integration/                   # 集成测试
│   └── testdata/                      # 测试数据
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

### 5.3 开发任务分解

#### 5.3.1 Week 1: HTTP 服务与任务引擎

**任务列表**：

1. **项目初始化** (Day 1)
   - [ ] 创建目录结构
   - [ ] 初始化 Go Module
   - [ ] 编写 Makefile
   - [ ] 配置 golangci-lint
   - [ ] 编写 README.md

2. **配置与日志** (Day 1)
   - [ ] 实现配置管理
   - [ ] 实现日志系统
   - [ ] 编写单元测试

3. **HTTP 服务器** (Day 2)
   - [ ] 使用 Gin 框架搭建 HTTP 服务
   - [ ] 实现路由注册
   - [ ] 实现认证中间件 (签名验证)
   - [ ] 实现限流中间件
   - [ ] 编写单元测试

4. **任务队列** (Day 3)
   - [ ] 实现任务队列管理
   - [ ] 支持优先级队列
   - [ ] 支持任务入队/出队
   - [ ] 编写单元测试

5. **Worker Pool** (Day 4)
   - [ ] 实现 Worker Pool
   - [ ] 支持并发控制
   - [ ] 实现任务分发
   - [ ] 实现任务超时控制
   - [ ] 编写单元测试

6. **结果存储** (Day 5)
   - [ ] 实现任务结果缓存
   - [ ] 支持结果查询
   - [ ] 支持结果过期清理
   - [ ] 编写单元测试

**验收标准**：
```bash
# 启动 Agent
./bin/agent -config configs/agent.yaml

# 测试健康检查
curl http://localhost:8080/api/v1/health

# 测试任务提交
curl -X POST http://localhost:8080/api/v1/task/execute \
  -H "Content-Type: application/json" \
  -d '{"type":"script","action":"execute","params":{"script":"echo hello"}}'

# 单元测试通过
make test
```

#### 5.3.2 Week 2: 执行器实现

**任务列表**：

1. **脚本执行器** (Day 1-2)
   - [ ] 实现 Shell 脚本执行
   - [ ] 实现 Python 脚本执行
   - [ ] 支持脚本参数
   - [ ] 支持环境变量
   - [ ] 支持超时控制
   - [ ] 捕获输出和错误
   - [ ] 编写单元测试

2. **文件执行器** (Day 3)
   - [ ] 实现文件上传
   - [ ] 实现文件下载
   - [ ] 实现文件复制
   - [ ] 实现文件删除
   - [ ] 支持路径安全检查
   - [ ] 编写单元测试

3. **服务执行器** (Day 4)
   - [ ] 实现 systemd 服务管理
   - [ ] 支持启动/停止/重启服务
   - [ ] 支持查询服务状态
   - [ ] 编写单元测试

4. **心跳发送器** (Day 4)
   - [ ] 实现 Unix Socket 客户端
   - [ ] 实现心跳数据发送
   - [ ] 实现定时发送 (30 秒)
   - [ ] 编写单元测试

5. **集成测试** (Day 5)
   - [ ] 测试各种任务执行
   - [ ] 测试并发任务执行
   - [ ] 测试任务超时
   - [ ] 测试任务取消
   - [ ] 性能测试

**验收标准**：
```bash
# 执行 Shell 脚本
curl -X POST http://localhost:8080/api/v1/task/execute \
  -H "Content-Type: application/json" \
  -d '{
    "type":"script",
    "action":"execute",
    "params":{
      "script":"#!/bin/bash\necho Hello World",
      "script_type":"shell"
    }
  }'

# 上传文件
curl -X POST http://localhost:8080/api/v1/file/upload \
  -H "Content-Type: application/json" \
  -d '{
    "path":"/tmp/test.txt",
    "content":"SGVsbG8gV29ybGQ=",
    "mode":420
  }'

# 查询任务状态
curl http://localhost:8080/api/v1/task/{id}/status

# 单元测试通过
make test
```

### 5.4 Agent 自测试方案

#### 5.4.1 单元测试

```bash
# 运行所有单元测试
make test

# 运行指定包的测试
go test -v ./internal/executor/...

# 生成覆盖率报告
make coverage
```

#### 5.4.2 集成测试

创建 `test/integration/agent_test.go`：

```go
// 测试 HTTP API
func TestHealthAPI(t *testing.T) {
    resp, err := http.Get("http://localhost:8080/api/v1/health")
    assert.NoError(t, err)
    assert.Equal(t, 200, resp.StatusCode)
}

// 测试脚本执行
func TestScriptExecution(t *testing.T) {
    task := TaskRequest{
        Type: "script",
        Action: "execute",
        Params: map[string]interface{}{
            "script": "echo 'Hello World'",
            "script_type": "shell",
        },
    }

    result := executeTask(task)
    assert.True(t, result.Success)
    assert.Contains(t, result.Output, "Hello World")
}

// 测试并发执行
func TestConcurrentExecution(t *testing.T) {
    var wg sync.WaitGroup
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            task := TaskRequest{...}
            result := executeTask(task)
            assert.True(t, result.Success)
        }()
    }
    wg.Wait()
}
```

#### 5.4.3 Mock Daemon 测试

创建 `test/mock_daemon.go` 用于测试心跳功能：

```go
// Mock Daemon 接收 Agent 心跳
func TestHeartbeat(t *testing.T) {
    // 启动 Mock Daemon
    listener := startMockDaemon(t)
    defer listener.Close()

    // 启动 Agent
    agent := NewAgent(config)
    go agent.Start()
    defer agent.Stop()

    // 等待接收心跳
    heartbeat := waitForHeartbeat(listener, 5*time.Second)

    // 验证心跳数据
    assert.NotNil(t, heartbeat)
    assert.Equal(t, agent.PID, heartbeat.PID)
}
```

### 5.5 Phase 2 验收清单

**功能验收**：
- [ ] Agent 可正常启动和退出
- [ ] HTTP API 可正常访问
- [ ] 健康检查接口可用
- [ ] 状态查询接口可用
- [ ] Shell 脚本执行正常
- [ ] Python 脚本执行正常
- [ ] 文件上传/下载正常
- [ ] 服务管理功能正常
- [ ] 任务队列功能正常
- [ ] 并发任务执行正常
- [ ] 任务超时控制正常
- [ ] 任务取消功能正常
- [ ] 心跳发送正常

**性能验收**：
- [ ] Agent CPU 占用 < 1% (空闲时)
- [ ] Agent 内存占用 < 50MB
- [ ] API 响应延迟 < 100ms
- [ ] 支持 10 并发任务

**代码质量验收**：
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] golangci-lint 检查通过
- [ ] API 文档完整

---

## 6. 第三阶段：Manager 后端模块开发

### 6.1 模块概述

**功能定位**：中心管理节点后端服务，提供 RESTful API 和 gRPC 服务。

**关键指标**：
- API 响应 < 200ms (P95)
- 支持管理 1000+ 节点
- gRPC 服务稳定可靠

### 6.2 目录结构

```
manager/
├── cmd/
│   └── manager/
│       └── main.go                    # 入口文件
├── internal/
│   ├── config/
│   │   ├── config.go                  # 配置结构
│   │   └── loader.go                  # 配置加载
│   ├── server/
│   │   ├── http.go                    # HTTP 服务器
│   │   └── grpc.go                    # gRPC 服务器
│   ├── router/
│   │   ├── router.go                  # 路由注册
│   │   └── middleware/
│   │       ├── auth.go                # JWT 认证中间件
│   │       ├── ratelimit.go           # 限流中间件
│   │       ├── cors.go                # CORS 中间件
│   │       └── audit.go               # 审计日志中间件
│   ├── handler/
│   │   ├── node_handler.go            # 节点管理 Handler
│   │   ├── version_handler.go         # 版本管理 Handler
│   │   ├── task_handler.go            # 任务管理 Handler
│   │   ├── auth_handler.go            # 认证 Handler
│   │   └── system_handler.go          # 系统管理 Handler
│   ├── service/
│   │   ├── node_service.go            # 节点业务逻辑
│   │   ├── version_service.go         # 版本业务逻辑
│   │   ├── task_service.go            # 任务业务逻辑
│   │   ├── auth_service.go            # 认证业务逻辑
│   │   └── metric_service.go          # 监控业务逻辑
│   ├── repository/
│   │   ├── node_repo.go               # 节点数据访问
│   │   ├── version_repo.go            # 版本数据访问
│   │   ├── task_repo.go               # 任务数据访问
│   │   └── user_repo.go               # 用户数据访问
│   ├── model/
│   │   ├── node.go                    # 节点模型
│   │   ├── version.go                 # 版本模型
│   │   ├── task.go                    # 任务模型
│   │   └── user.go                    # 用户模型
│   ├── grpc/
│   │   ├── server.go                  # gRPC 服务实现
│   │   └── proto/
│   │       └── daemon.proto           # Protobuf 定义
│   └── scheduler/
│       └── scheduler.go               # 定时任务调度器
├── pkg/
│   ├── jwt/                            # JWT 工具
│   ├── errors/                         # 错误定义
│   ├── response/                       # 响应结构
│   ├── proto/                          # Protobuf 生成代码
│   └── database/                       # 数据库工具
├── configs/
│   ├── config.yaml                    # 配置文件模板
│   └── config.example.yaml
├── migrations/
│   └── init.sql                       # 数据库初始化
├── scripts/
│   └── init_db.sh                     # 数据库初始化脚本
├── test/
│   ├── integration/                   # 集成测试
│   └── testdata/                      # 测试数据
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

### 6.3 开发任务分解

#### 6.3.1 Week 1: 数据库与后端基础

**任务列表**：

1. **项目初始化** (Day 1)
   - [ ] 创建目录结构
   - [ ] 初始化 Go Module
   - [ ] 编写 Makefile
   - [ ] 配置 golangci-lint

2. **数据库设计** (Day 1-2)
   - [ ] 编写数据库建表 SQL
   - [ ] 创建 12 张核心表
   - [ ] 设置索引和外键
   - [ ] 编写数据库初始化脚本

3. **GORM 模型** (Day 2)
   - [ ] 定义所有数据模型
   - [ ] 配置表关联
   - [ ] 实现自动迁移
   - [ ] 编写单元测试

4. **Repository 层** (Day 3)
   - [ ] 实现 NodeRepository
   - [ ] 实现 VersionRepository
   - [ ] 实现 TaskRepository
   - [ ] 实现 UserRepository
   - [ ] 编写单元测试

5. **配置与基础设施** (Day 4-5)
   - [ ] 实现配置管理
   - [ ] 集成 MySQL 连接池
   - [ ] 集成 Redis 客户端
   - [ ] 实现日志系统
   - [ ] 编写单元测试

**验收标准**：
```bash
# 初始化数据库
./scripts/init_db.sh

# 运行单元测试
make test

# 验证数据库连接
mysql -u root -p ops_scaffold -e "SHOW TABLES;"
```

#### 6.3.2 Week 2: 核心业务服务

**任务列表**：

1. **节点服务** (Day 1-2)
   - [ ] 实现节点注册逻辑
   - [ ] 实现节点列表查询
   - [ ] 实现节点详情查询
   - [ ] 实现心跳处理
   - [ ] 实现离线检测
   - [ ] 编写单元测试

2. **指标服务** (Day 2)
   - [ ] 实现指标数据保存
   - [ ] 实现实时指标查询
   - [ ] 实现历史指标查询
   - [ ] 实现数据聚合
   - [ ] 编写单元测试

3. **版本服务** (Day 3)
   - [ ] 实现版本上传
   - [ ] 实现版本签名
   - [ ] 实现版本列表查询
   - [ ] 实现版本部署
   - [ ] 编写单元测试

4. **任务服务** (Day 4)
   - [ ] 实现任务创建
   - [ ] 实现任务执行
   - [ ] 实现任务调度
   - [ ] 实现执行历史查询
   - [ ] 编写单元测试

5. **认证服务** (Day 5)
   - [ ] 实现用户登录
   - [ ] 实现 JWT Token 生成
   - [ ] 实现 Token 刷新
   - [ ] 实现权限检查
   - [ ] 编写单元测试

**验收标准**：
```bash
# 运行单元测试
make test-service

# 测试覆盖率 > 80%
make coverage
```

#### 6.3.3 Week 3: API、gRPC 服务与集成测试

**任务列表**：

1. **RESTful API** (Day 1-2)
   - [ ] 实现节点管理 API
   - [ ] 实现版本管理 API
   - [ ] 实现任务管理 API
   - [ ] 实现认证 API
   - [ ] 实现系统管理 API
   - [ ] 编写 API 文档

2. **中间件** (Day 2)
   - [ ] 实现 JWT 认证中间件
   - [ ] 实现 RBAC 权限中间件
   - [ ] 实现限流中间件
   - [ ] 实现 CORS 中间件
   - [ ] 实现审计日志中间件

3. **gRPC 服务** (Day 3)
   - [ ] 编写 Protobuf 定义
   - [ ] 生成 Go 代码
   - [ ] 实现节点注册接口
   - [ ] 实现心跳接收接口
   - [ ] 实现指标上报接口
   - [ ] 实现更新推送接口

4. **集成 Daemon** (Day 4)
   - [ ] 修改 Daemon，连接 Manager gRPC
   - [ ] 测试节点注册
   - [ ] 测试心跳上报
   - [ ] 测试指标上报

5. **集成 Agent** (Day 5)
   - [ ] Manager 调用 Agent API
   - [ ] 测试任务执行
   - [ ] 测试文件操作

**验收标准**：
```bash
# 启动 Manager
./bin/manager -config configs/config.yaml

# 测试登录
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 测试节点列表（需要 Token）
curl http://localhost:8080/api/v1/nodes \
  -H "Authorization: Bearer <token>"

# 启动 Daemon，验证自动注册
./bin/daemon -config configs/daemon.yaml

# 查看 Manager 日志，验证节点注册成功
```

### 6.4 Manager 自测试方案

#### 6.4.1 后端单元测试

```bash
# 运行所有单元测试
make test

# 运行指定包的测试
go test -v ./internal/service/...

# 生成覆盖率报告
make coverage
```

#### 6.4.2 API 集成测试

```bash
# 使用 Postman/Newman 测试 API
newman run api_tests.json

# 或编写 Go 集成测试
go test -v ./test/integration/...
```

#### 6.4.3 端到端测试

```bash
# 1. 启动 MySQL 和 Redis
docker-compose up -d mysql redis

# 2. 初始化数据库
./scripts/init_db.sh

# 3. 启动 Manager
./bin/manager -config configs/config.yaml

# 4. 启动 Daemon
./bin/daemon -config configs/daemon.yaml

# 5. 验证节点注册
# 查看 Manager 日志
tail -f /var/log/manager/manager.log

# 6. 测试 HTTP API
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 7. 验证数据持久化
# 停止并重启 Manager，验证数据完整性
```

### 6.5 Phase 3 验收清单

**后端功能验收**：
- [ ] MySQL 数据库连接正常
- [ ] Redis 缓存连接正常
- [ ] gRPC 服务可用
- [ ] 节点注册功能正常
- [ ] 心跳接收功能正常
- [ ] 指标存储功能正常
- [ ] 用户登录功能正常
- [ ] Token 认证功能正常
- [ ] RBAC 权限功能正常
- [ ] 节点管理 API 正常
- [ ] 版本管理 API 正常
- [ ] 任务管理 API 正常
- [ ] 审计日志功能正常

**集成验收**：
- [ ] Daemon 可注册到 Manager
- [ ] Daemon 心跳正常上报
- [ ] Daemon 指标正常上报
- [ ] Manager 可查询节点列表
- [ ] Manager 可查询节点指标
- [ ] Manager 可下发任务到 Agent
- [ ] Manager 可部署版本到 Daemon

**性能验收**：
- [ ] API 响应 < 200ms (P95)
- [ ] 支持管理 100+ 节点 (测试环境)
- [ ] gRPC 连接稳定

**代码质量验收**：
- [ ] 单元测试覆盖率 > 70%
- [ ] 集成测试通过
- [ ] golangci-lint 检查通过
- [ ] API 文档完整

---

## 7. 第四阶段：Web 前端模块开发

### 7.1 模块概述

**功能定位**：运维管理平台的 Web 前端界面，提供可视化的运维管理能力。

**关键指标**：
- 首屏加载时间 < 3s
- 交互响应延迟 < 100ms
- 支持 1000+ 节点数据展示
- 移动端自适应

### 7.2 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18+ | 前端框架 |
| TypeScript | 5+ | 类型系统 |
| Vite | 5+ | 构建工具 |
| Material-UI | 5+ | UI 组件库 |
| React Router | 6+ | 路由管理 |
| Zustand | 4+ | 状态管理 |
| Axios | 1.6+ | HTTP 客户端 |
| ECharts | 5+ | 数据可视化 |
| React Query | 5+ | 数据获取和缓存 |

### 7.3 目录结构

```
web/
├── public/                             # 静态资源
│   ├── favicon.ico
│   └── logo.png
├── src/
│   ├── api/                            # API 接口层
│   │   ├── client.ts                   # Axios 实例配置
│   │   ├── auth.ts                     # 认证 API
│   │   ├── nodes.ts                    # 节点 API
│   │   ├── metrics.ts                  # 监控 API
│   │   ├── tasks.ts                    # 任务 API
│   │   ├── versions.ts                 # 版本 API
│   │   └── users.ts                    # 用户 API
│   ├── components/                     # 通用组件
│   │   ├── Layout/                     # 布局组件
│   │   │   ├── MainLayout.tsx          # 主布局
│   │   │   ├── Sidebar.tsx             # 侧边栏
│   │   │   ├── Header.tsx              # 顶部导航
│   │   │   └── Breadcrumb.tsx          # 面包屑
│   │   ├── Charts/                     # 图表组件
│   │   │   ├── LineChart.tsx           # 折线图
│   │   │   ├── PieChart.tsx            # 饼图
│   │   │   └── BarChart.tsx            # 柱状图
│   │   ├── Table/                      # 表格组件
│   │   │   ├── DataTable.tsx           # 数据表格
│   │   │   └── Pagination.tsx          # 分页器
│   │   └── Common/                     # 通用组件
│   │       ├── Loading.tsx             # 加载状态
│   │       ├── ErrorBoundary.tsx       # 错误边界
│   │       └── ConfirmDialog.tsx       # 确认对话框
│   ├── pages/                          # 页面组件
│   │   ├── Login/                      # 登录页
│   │   │   └── index.tsx
│   │   ├── Dashboard/                  # 仪表盘
│   │   │   ├── index.tsx
│   │   │   ├── StatCards.tsx           # 统计卡片
│   │   │   ├── NodeStatusChart.tsx     # 节点状态图
│   │   │   └── MetricsTrend.tsx        # 指标趋势图
│   │   ├── Nodes/                      # 节点管理
│   │   │   ├── List.tsx                # 节点列表
│   │   │   ├── Detail.tsx              # 节点详情
│   │   │   └── Metrics.tsx             # 节点监控
│   │   ├── Tasks/                      # 任务管理
│   │   │   ├── List.tsx                # 任务列表
│   │   │   ├── Create.tsx              # 创建任务
│   │   │   └── History.tsx             # 执行历史
│   │   ├── Versions/                   # 版本管理
│   │   │   ├── List.tsx                # 版本列表
│   │   │   ├── Upload.tsx              # 上传版本
│   │   │   └── Deploy.tsx              # 部署管理
│   │   └── System/                     # 系统管理
│   │       ├── Users.tsx               # 用户管理
│   │       ├── AuditLogs.tsx           # 审计日志
│   │       └── Settings.tsx            # 系统设置
│   ├── stores/                         # 状态管理
│   │   ├── authStore.ts                # 认证状态
│   │   ├── userStore.ts                # 用户状态
│   │   └── configStore.ts              # 配置状态
│   ├── hooks/                          # 自定义 Hooks
│   │   ├── useAuth.ts                  # 认证 Hook
│   │   ├── useNodes.ts                 # 节点数据 Hook
│   │   └── useTasks.ts                 # 任务数据 Hook
│   ├── types/                          # TypeScript 类型定义
│   │   ├── api.ts                      # API 类型
│   │   ├── node.ts                     # 节点类型
│   │   ├── task.ts                     # 任务类型
│   │   └── user.ts                     # 用户类型
│   ├── utils/                          # 工具函数
│   │   ├── format.ts                   # 格式化工具
│   │   ├── validation.ts               # 验证工具
│   │   └── storage.ts                  # 本地存储工具
│   ├── config/                         # 配置文件
│   │   └── constants.ts                # 常量配置
│   ├── styles/                         # 样式文件
│   │   ├── theme.ts                    # MUI 主题配置
│   │   └── global.css                  # 全局样式
│   ├── router/                         # 路由配置
│   │   ├── index.tsx                   # 路由入口
│   │   └── guards.tsx                  # 路由守卫
│   ├── App.tsx                         # 根组件
│   ├── main.tsx                        # 入口文件
│   └── vite-env.d.ts                   # Vite 类型声明
├── .env.development                    # 开发环境变量
├── .env.production                     # 生产环境变量
├── .eslintrc.cjs                       # ESLint 配置
├── .prettierrc                         # Prettier 配置
├── tsconfig.json                       # TypeScript 配置
├── vite.config.ts                      # Vite 配置
├── package.json                        # 依赖配置
└── README.md                           # 说明文档
```

### 7.4 开发任务分解

#### 7.4.1 Week 1: 项目初始化与基础框架

**任务列表**：

1. **项目初始化** (Day 1)
   - [ ] 创建 Vite + React + TypeScript 项目
   - [ ] 配置 ESLint 和 Prettier
   - [ ] 配置 TypeScript
   - [ ] 安装核心依赖
   - [ ] 配置环境变量

2. **基础设施搭建** (Day 1-2)
   - [ ] 配置 MUI 主题
   - [ ] 创建 Axios 实例和拦截器
   - [ ] 实现 Token 管理工具
   - [ ] 实现本地存储工具
   - [ ] 创建通用类型定义

3. **路由系统** (Day 2)
   - [ ] 配置 React Router
   - [ ] 实现路由守卫
   - [ ] 配置路由懒加载
   - [ ] 实现 404 页面

4. **状态管理** (Day 3)
   - [ ] 配置 Zustand
   - [ ] 实现 authStore (认证状态)
   - [ ] 实现 userStore (用户状态)
   - [ ] 实现 configStore (配置状态)

5. **布局组件** (Day 4)
   - [ ] 实现 MainLayout
   - [ ] 实现 Sidebar (侧边栏导航)
   - [ ] 实现 Header (顶部栏、用户菜单)
   - [ ] 实现 Breadcrumb (面包屑)

6. **通用组件** (Day 5)
   - [ ] 实现 Loading 组件
   - [ ] 实现 ErrorBoundary
   - [ ] 实现 ConfirmDialog
   - [ ] 实现 DataTable 组件
   - [ ] 实现 Pagination 组件

**验收标准**：
```bash
# 启动开发服务器
cd web
npm run dev

# 访问 http://localhost:5173
# 验证：
# - 路由跳转正常
# - 侧边栏导航正常
# - 通用组件可用

# 代码检查
npm run lint

# 类型检查
npm run type-check
```

#### 7.4.2 Week 2: 核心页面开发

**任务列表**：

1. **登录模块** (Day 1)
   - [ ] 实现登录页面 UI
   - [ ] 实现登录表单验证
   - [ ] 集成登录 API
   - [ ] 实现 Token 持久化
   - [ ] 实现自动登录

2. **Dashboard 页面** (Day 2)
   - [ ] 实现统计卡片 (在线节点、离线节点、任务数、告警数)
   - [ ] 实现节点状态饼图
   - [ ] 实现资源趋势折线图 (CPU、内存)
   - [ ] 实现最新告警列表
   - [ ] 集成 Dashboard API

3. **节点列表页面** (Day 3)
   - [ ] 实现节点列表表格
   - [ ] 实现搜索和筛选 (状态、标签、分组)
   - [ ] 实现分页
   - [ ] 实现节点操作 (查看详情、删除)
   - [ ] 集成节点列表 API

4. **节点详情页面** (Day 4)
   - [ ] 实现节点基本信息展示
   - [ ] 实现实时指标展示 (CPU、内存、磁盘、网络)
   - [ ] 实现历史指标查询
   - [ ] 实现指标图表展示 (ECharts)
   - [ ] 集成节点详情和指标 API

5. **错误处理** (Day 5)
   - [ ] 实现 API 错误处理
   - [ ] 实现错误提示 (Toast)
   - [ ] 实现页面错误状态
   - [ ] 实现网络异常处理

**验收标准**：
```bash
# 启动前端和后端
npm run dev
cd ../manager && ./bin/manager

# 测试功能：
# 1. 登录功能正常
# 2. Dashboard 数据展示正常
# 3. 节点列表展示正常
# 4. 节点详情和监控图表正常
# 5. 错误提示正常
```

#### 7.4.3 Week 3: 任务与版本管理

**任务列表**：

1. **任务列表页面** (Day 1)
   - [ ] 实现任务列表表格
   - [ ] 实现任务状态展示
   - [ ] 实现任务搜索和筛选
   - [ ] 实现任务操作 (执行、查看详情)
   - [ ] 集成任务列表 API

2. **任务创建页面** (Day 2)
   - [ ] 实现任务表单
   - [ ] 实现任务类型选择 (脚本、文件、服务)
   - [ ] 实现目标节点选择
   - [ ] 实现任务参数配置
   - [ ] 实现表单验证
   - [ ] 集成任务创建 API

3. **任务执行历史** (Day 3)
   - [ ] 实现执行历史列表
   - [ ] 实现执行结果展示
   - [ ] 实现日志查看
   - [ ] 实现结果导出
   - [ ] 集成执行历史 API

4. **版本管理页面** (Day 4)
   - [ ] 实现版本列表
   - [ ] 实现版本上传
   - [ ] 实现版本部署
   - [ ] 实现部署进度展示
   - [ ] 实现版本回滚
   - [ ] 集成版本管理 API

5. **系统管理页面** (Day 5)
   - [ ] 实现用户管理 (列表、新增、禁用)
   - [ ] 实现审计日志查询
   - [ ] 实现系统设置
   - [ ] 集成系统管理 API

**验收标准**：
```bash
# 测试任务管理：
# 1. 创建任务正常
# 2. 执行任务正常
# 3. 查看执行历史正常

# 测试版本管理：
# 1. 上传版本正常
# 2. 部署版本正常
# 3. 查看部署进度正常

# 测试系统管理：
# 1. 用户管理功能正常
# 2. 审计日志查询正常
```

#### 7.4.4 Week 4: 优化与测试

**任务列表**：

1. **性能优化** (Day 1-2)
   - [ ] 实现组件懒加载
   - [ ] 实现列表虚拟滚动 (大数据量)
   - [ ] 优化打包体积
   - [ ] 实现代码分割
   - [ ] 优化图片资源

2. **用户体验优化** (Day 2-3)
   - [ ] 实现加载状态优化
   - [ ] 实现骨架屏
   - [ ] 实现空状态展示
   - [ ] 实现操作反馈 (Toast、Snackbar)
   - [ ] 实现快捷键支持

3. **响应式适配** (Day 3)
   - [ ] 实现移动端适配
   - [ ] 实现平板适配
   - [ ] 优化小屏幕显示

4. **测试** (Day 4)
   - [ ] 编写单元测试 (核心 Hooks)
   - [ ] 编写组件测试
   - [ ] 进行浏览器兼容性测试
   - [ ] 进行性能测试

5. **文档与部署** (Day 5)
   - [ ] 编写 README
   - [ ] 编写组件文档
   - [ ] 配置生产环境构建
   - [ ] 配置 Nginx 部署
   - [ ] 验收测试

**验收标准**：
```bash
# 性能测试
npm run build
npm run preview

# 验证指标：
# - 首屏加载 < 3s
# - 构建体积 < 2MB (gzip)
# - Lighthouse 得分 > 90

# 兼容性测试
# - Chrome 最新版 ✓
# - Firefox 最新版 ✓
# - Safari 最新版 ✓
# - Edge 最新版 ✓

# 功能测试
# - 所有页面功能正常 ✓
# - 移动端显示正常 ✓
```

### 7.5 API 接口设计

#### 7.5.1 认证接口

```typescript
// 登录
POST /api/v1/auth/login
Request: { username: string, password: string }
Response: { token: string, user: User }

// 获取当前用户信息
GET /api/v1/auth/profile
Response: { user: User }

// 修改密码
POST /api/v1/auth/change-password
Request: { old_password: string, new_password: string }
```

#### 7.5.2 节点接口

```typescript
// 获取节点列表
GET /api/v1/nodes?page=1&page_size=20&status=online&search=keyword
Response: { list: Node[], page_info: PageInfo }

// 获取节点详情
GET /api/v1/nodes/:id
Response: { node: Node }

// 获取节点统计
GET /api/v1/nodes/statistics
Response: { total: number, online: number, offline: number }

// 获取节点指标
GET /api/v1/nodes/:id/metrics?type=cpu&start_time=xxx&end_time=xxx
Response: { metrics: Metric[] }
```

#### 7.5.3 任务接口

```typescript
// 创建任务
POST /api/v1/tasks
Request: { name, type, content, target_nodes }
Response: { task: Task }

// 执行任务
POST /api/v1/tasks/:id/execute
Response: { execution_id: string }

// 获取任务列表
GET /api/v1/tasks?page=1&page_size=20
Response: { list: Task[], page_info: PageInfo }

// 获取执行历史
GET /api/v1/tasks/:id/executions
Response: { list: Execution[] }
```

### 7.6 前端自测试方案

#### 7.6.1 单元测试

```bash
# 使用 Vitest 进行单元测试
npm run test

# 测试覆盖率
npm run test:coverage
```

**测试内容**：
- Hooks 测试 (useAuth, useNodes, useTasks)
- 工具函数测试 (format, validation)
- Store 测试 (authStore, userStore)

#### 7.6.2 组件测试

```bash
# 使用 React Testing Library
npm run test:components
```

**测试内容**：
- 登录表单测试
- 数据表格测试
- 图表组件测试

#### 7.6.3 E2E 测试 (可选)

```bash
# 使用 Playwright
npm run test:e2e
```

**测试场景**：
- 登录流程
- 节点查看流程
- 任务创建和执行流程

### 7.7 Phase 4 验收清单

**功能验收**：
- [ ] 登录功能正常
- [ ] Dashboard 页面正常
- [ ] 节点列表功能正常
- [ ] 节点详情功能正常
- [ ] 节点监控图表正常
- [ ] 任务列表功能正常
- [ ] 任务创建功能正常
- [ ] 任务执行功能正常
- [ ] 执行历史查询正常
- [ ] 版本列表功能正常
- [ ] 版本上传功能正常
- [ ] 版本部署功能正常
- [ ] 用户管理功能正常
- [ ] 审计日志查询正常
- [ ] 系统设置功能正常

**用户体验验收**：
- [ ] 页面响应流畅
- [ ] 加载状态友好
- [ ] 错误提示清晰
- [ ] 操作反馈及时
- [ ] 移动端适配良好

**性能验收**：
- [ ] 首屏加载 < 3s
- [ ] 交互响应 < 100ms
- [ ] 构建体积 < 2MB (gzip)
- [ ] Lighthouse 得分 > 90

**兼容性验收**：
- [ ] Chrome 浏览器正常
- [ ] Firefox 浏览器正常
- [ ] Safari 浏览器正常
- [ ] Edge 浏览器正常

**代码质量验收**：
- [ ] ESLint 检查通过
- [ ] 类型检查通过
- [ ] 单元测试覆盖率 > 60%
- [ ] 代码注释完整

---

## 8. 第五阶段：集成测试

### 8.1 测试目标

验证四个模块(Daemon、Agent、Manager 后端、Web 前端)集成后的完整功能和性能。

### 8.2 测试环境

```yaml
# docker-compose.test.yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: ops_scaffold
    ports:
      - "3306:3306"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  manager:
    build: ./manager
    depends_on:
      - mysql
      - redis
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      DB_HOST: mysql
      REDIS_HOST: redis

  daemon-1:
    build: ./daemon
    environment:
      MANAGER_HOST: manager
      MANAGER_PORT: 9090

  daemon-2:
    build: ./daemon
    environment:
      MANAGER_HOST: manager
      MANAGER_PORT: 9090

  agent-1:
    build: ./agent
    network_mode: "service:daemon-1"

  agent-2:
    build: ./agent
    network_mode: "service:daemon-2"
```

### 8.3 测试场景

#### 8.3.1 功能测试

**场景 1：节点注册与监控**
```bash
# 1. 启动 Manager
docker-compose -f docker-compose.test.yaml up -d manager

# 2. 启动 Daemon
docker-compose -f docker-compose.test.yaml up -d daemon-1 daemon-2

# 3. 验证节点注册
curl http://localhost:8080/api/v1/nodes | jq

# 4. 验证指标上报
curl http://localhost:8080/api/v1/nodes/1/metrics | jq

# 5. 验证节点状态
# 停止 daemon-1
docker-compose -f docker-compose.test.yaml stop daemon-1

# 等待 3 分钟，验证节点状态变为 offline
curl http://localhost:8080/api/v1/nodes/1 | jq .status
```

**场景 2：任务执行**
```bash
# 1. 创建任务
curl -X POST http://localhost:8080/api/v1/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试任务",
    "type": "script",
    "content": {
      "script": "echo Hello World",
      "script_type": "shell"
    },
    "target_type": "all"
  }'

# 2. 执行任务
curl -X POST http://localhost:8080/api/v1/tasks/1/execute

# 3. 查询执行结果
curl http://localhost:8080/api/v1/tasks/1/executions | jq
```

**场景 3：版本部署**
```bash
# 1. 上传版本
curl -X POST http://localhost:8080/api/v1/versions \
  -F "component=agent" \
  -F "version=1.0.1" \
  -F "file=@agent-1.0.1.tar.gz"

# 2. 部署版本
curl -X POST http://localhost:8080/api/v1/updates/deploy \
  -H "Content-Type: application/json" \
  -d '{
    "component": "agent",
    "version_id": 1,
    "target_type": "all",
    "strategy": "rolling"
  }'

# 3. 查询部署状态
curl http://localhost:8080/api/v1/updates/{batch_id}/status | jq
```

#### 8.3.2 性能测试

**测试 1：节点管理容量**
```bash
# 启动 100 个 Daemon 实例
for i in {1..100}; do
  docker-compose -f docker-compose.test.yaml up -d daemon-$i
done

# 验证 Manager 可正常管理
curl http://localhost:8080/api/v1/nodes?page_size=100 | jq .total

# 监控 Manager 资源占用
docker stats manager
```

**测试 2：API 性能**
```bash
# 使用 Apache Bench 测试 API 性能
ab -n 1000 -c 10 http://localhost:8080/api/v1/nodes

# 验证 P95 响应时间 < 200ms
```

**测试 3：并发任务执行**
```bash
# 并发执行 50 个任务
for i in {1..50}; do
  curl -X POST http://localhost:8080/api/v1/tasks/1/execute &
done
wait

# 验证所有任务执行成功
curl http://localhost:8080/api/v1/tasks/1/executions | jq '.[] | select(.status=="success") | .id' | wc -l
```

#### 8.3.3 稳定性测试

**测试 1：长时间运行**
```bash
# 启动所有服务
docker-compose -f docker-compose.test.yaml up -d

# 运行 24 小时
# 每小时执行一次任务
while true; do
  curl -X POST http://localhost:8080/api/v1/tasks/1/execute
  sleep 3600
done

# 验证：
# 1. 无内存泄漏
# 2. 无进程崩溃
# 3. 数据正常记录
```

**测试 2：异常恢复**
```bash
# 1. 模拟 Daemon 崩溃
docker kill daemon-1

# 验证：
# - Agent 继续运行
# - Manager 检测到节点离线

# 2. 重启 Daemon
docker start daemon-1

# 验证：
# - Daemon 重新注册
# - Agent 重新连接
# - 指标恢复上报

# 3. 模拟 Manager 崩溃
docker kill manager

# 等待 30 秒，重启 Manager
docker start manager

# 验证：
# - Daemon 重新连接
# - 数据未丢失
```

### 8.4 Phase 5 验收清单

**功能验收**：
- [ ] 节点注册流程正常
- [ ] 心跳和指标上报正常
- [ ] 节点状态更新正常
- [ ] 任务创建和执行正常
- [ ] 版本上传和部署正常
- [ ] 前端功能完整可用

**性能验收**：
- [ ] Manager 可管理 100+ 节点
- [ ] API P95 响应时间 < 200ms
- [ ] 并发任务执行正常
- [ ] 前端响应流畅

**稳定性验收**：
- [ ] 7x24 小时运行无崩溃
- [ ] 无内存泄漏
- [ ] 异常场景可恢复
- [ ] 数据完整性保证

---

## 9. 验收标准

### 9.1 最终验收清单

#### 9.1.1 功能完整性

**Daemon 模块**：
- [ ] 资源采集功能完整
- [ ] Agent 进程管理正常
- [ ] 版本更新功能正常
- [ ] 与 Manager 通信正常

**Agent 模块**：
- [ ] HTTP API 完整可用
- [ ] 任务执行功能正常
- [ ] 文件操作功能正常
- [ ] 服务管理功能正常
- [ ] 心跳上报正常

**Manager 后端模块**：
- [ ] 节点管理功能完整
- [ ] 监控功能完整
- [ ] 版本管理功能完整
- [ ] 任务调度功能完整
- [ ] 用户认证功能正常
- [ ] gRPC 服务完整

**Web 前端模块**：
- [ ] 登录功能正常
- [ ] Dashboard 完整
- [ ] 节点管理界面完整
- [ ] 任务管理界面完整
- [ ] 版本管理界面完整
- [ ] 系统管理界面完整

#### 9.1.2 性能指标

| 指标 | 目标值 | 实际值 | 状态 |
|------|--------|--------|------|
| Daemon CPU 占用 | < 1% | - | [ ] |
| Daemon 内存占用 | < 30MB | - | [ ] |
| Agent CPU 占用 | < 1% | - | [ ] |
| Agent 内存占用 | < 50MB | - | [ ] |
| Manager API 响应 | < 200ms (P95) | - | [ ] |
| 节点管理容量 | > 100 | - | [ ] |
| 任务执行延迟 | < 100ms | - | [ ] |
| 前端首屏加载 | < 3s | - | [ ] |
| 前端交互响应 | < 100ms | - | [ ] |

#### 9.1.3 代码质量

| 指标 | 目标值 | 实际值 | 状态 |
|------|--------|--------|------|
| 单元测试覆盖率 | > 70% | - | [ ] |
| 集成测试通过率 | 100% | - | [ ] |
| golangci-lint | 0 错误 | - | [ ] |
| 代码注释完整性 | > 80% | - | [ ] |

#### 9.1.4 文档完整性

- [ ] README 文档完整
- [ ] API 文档完整
- [ ] 部署文档完整
- [ ] 运维文档完整
- [ ] 开发文档完整

### 9.2 交付物清单

**代码交付**：
- [ ] daemon 源代码
- [ ] agent 源代码
- [ ] manager 源代码
- [ ] 前端源代码
- [ ] 单元测试代码
- [ ] 集成测试代码

**可执行文件**：
- [ ] daemon 二进制文件
- [ ] agent 二进制文件
- [ ] manager 二进制文件
- [ ] 前端构建产物

**配置文件**：
- [ ] daemon.yaml 示例
- [ ] agent.yaml 示例
- [ ] manager/config.yaml 示例
- [ ] systemd 服务文件
- [ ] Docker 配置文件

**文档**：
- [ ] README.md
- [ ] API 文档
- [ ] 部署文档
- [ ] 运维文档
- [ ] 开发文档

**脚本**：
- [ ] 安装脚本
- [ ] 构建脚本
- [ ] 数据库初始化脚本
- [ ] 测试脚本

---

## 附录 A：开发规范

### A.1 代码规范

- 遵循 Go 官方编码规范
- 使用 gofmt 格式化代码
- 使用 golangci-lint 检查代码
- 函数复杂度 < 15
- 文件长度 < 500 行

### A.2 Git 提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- feat: 新功能
- fix: 修复 bug
- docs: 文档更新
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

**示例**:
```
feat(daemon): 实现 CPU 采集器

- 使用 gopsutil 库采集 CPU 信息
- 支持多核心采集
- 实现单元测试

Closes #123
```

### A.3 分支管理

```
main              # 主分支，稳定版本
├── develop       # 开发分支
    ├── feature/daemon-collector    # 功能分支
    ├── feature/agent-executor      # 功能分支
    └── feature/manager-api         # 功能分支
```

### A.4 版本管理

遵循语义化版本 (SemVer)：`MAJOR.MINOR.PATCH`

- MAJOR: 不兼容的 API 变更
- MINOR: 向后兼容的功能新增
- PATCH: 向后兼容的问题修复

---

## 附录 B：常见问题

### B.1 Daemon 无法连接 Manager

**问题**：Daemon 启动后无法连接到 Manager

**排查步骤**：
1. 检查 Manager gRPC 服务是否启动
2. 检查网络连通性
3. 检查 TLS 证书配置
4. 检查防火墙规则

### B.2 Agent 频繁重启

**问题**：Agent 进程频繁被 Daemon 重启

**排查步骤**：
1. 检查 Agent 日志
2. 检查心跳配置
3. 检查资源限制配置
4. 检查 Agent 是否崩溃

### B.3 Manager 数据库连接失败

**问题**：Manager 无法连接 MySQL

**排查步骤**：
1. 检查 MySQL 服务状态
2. 检查连接配置
3. 检查用户权限
4. 检查网络连通性

---

*— 代码生成计划文档结束 —*
