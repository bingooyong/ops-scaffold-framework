import{bT as Se,bU as ct,bV as Ne,bW as dt,z as e,bX as ke,bY as ut,bZ as K,b_ as W,b$ as Oe,c0 as ee,B as x,c1 as ht,c2 as xt,az as V,c3 as Ue,c4 as mt,c5 as Ie,c6 as gt,c7 as ft,c8 as jt,c9 as pt,ca as E,cb as vt}from"./vendor-Bwteonwg.js";import{c as yt,B as j,C as A,T as ve,a as g,D as Z,L as re,b as ae,d as bt,e as Ae,f as xe,A as wt,I as O,M as Tt,g as Ct,P as _t,h as kt,i as ze,j as St,k as Be,l as Pt,S as R,m as Y,n as q,o as J,p as B,q as Le,r as z,s as $,t as We,u as Ee,v as He,w as fe,x as I,y as me,z as Mt,N as Dt,E as ye,F,G as qe,H as Ge,J as Ke,K as It,O as At,Q as $e,R as Ve,U as zt,V as ie,W as b,X as Bt,Y as Lt,Z as Ye,_ as Qe,$ as Xe,a0 as Q,a1 as y,a2 as Je,a3 as Pe,a4 as $t,a5 as Ft,a6 as Rt,a7 as Nt,a8 as Ot,a9 as ce,aa as ne,ab as Ut,ac as Wt,ad as Et,ae as Ht,af as qt,ag as Gt,ah as Kt}from"./mui-CQ7jBWIP.js";import{R as Vt,A as Yt,X as Qt,Y as Xt,T as Jt,a as Zt}from"./recharts-PTStdQVP.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const es=yt({palette:{primary:{main:"#1976d2",light:"#42a5f5",dark:"#1565c0"},secondary:{main:"#9c27b0",light:"#ba68c8",dark:"#7b1fa2"},success:{main:"#2e7d32",light:"#4caf50",dark:"#1b5e20"},error:{main:"#d32f2f",light:"#ef5350",dark:"#c62828"},warning:{main:"#ed6c02",light:"#ff9800",dark:"#e65100"},info:{main:"#0288d1",light:"#03a9f4",dark:"#01579b"}},typography:{fontFamily:["-apple-system","BlinkMacSystemFont",'"Segoe UI"',"Roboto",'"Helvetica Neue"',"Arial","sans-serif"].join(","),h1:{fontSize:"2.5rem",fontWeight:600},h2:{fontSize:"2rem",fontWeight:600},h3:{fontSize:"1.75rem",fontWeight:600},h4:{fontSize:"1.5rem",fontWeight:600},h5:{fontSize:"1.25rem",fontWeight:600},h6:{fontSize:"1rem",fontWeight:600}},components:{MuiButton:{styleOverrides:{root:{textTransform:"none",borderRadius:8}}},MuiCard:{styleOverrides:{root:{borderRadius:12,boxShadow:"0 2px 8px rgba(0,0,0,0.1)"}}},MuiTextField:{defaultProps:{variant:"outlined"}}}}),be="ops_token",we="ops_user",de={getToken(){return localStorage.getItem(be)},setToken(t){localStorage.setItem(be,t)},removeToken(){localStorage.removeItem(be)},getUser(){const t=localStorage.getItem(we);if(!t)return null;try{return JSON.parse(t)}catch{return null}},setUser(t){localStorage.setItem(we,JSON.stringify(t))},removeUser(){localStorage.removeItem(we)},clear(){this.removeToken(),this.removeUser()}};Se.extend(ct);Se.locale("zh-cn");function ts(t,s="YYYY-MM-DD HH:mm:ss"){return Se(t).format(s)}const oe=Ne()(dt(t=>({user:null,token:null,isAuthenticated:!1,_hasHydrated:!1,setAuth:(s,n)=>{de.setUser(s),de.setToken(n),t({user:s,token:n,isAuthenticated:!0})},clearAuth:()=>{de.clear(),t({user:null,token:null,isAuthenticated:!1})},updateUser:s=>{de.setUser(s),t({user:s})},setHasHydrated:s=>{t({_hasHydrated:s})}}),{name:"ops-auth-storage",partialize:t=>({user:t.user,token:t.token,isAuthenticated:t.user!==null&&t.token!==null}),onRehydrateStorage:()=>(t,s)=>{s&&console.error("Failed to rehydrate auth state:",s),t&&(t.isAuthenticated=t.user!==null&&t.token!==null,t.setHasHydrated(!0))}})),Me=Ne(t=>({timeRange:{startTime:new Date(Date.now()-36e5),endTime:new Date},refreshInterval:3e4,setTimeRange:s=>{t({timeRange:s})},setRefreshInterval:s=>{t({refreshInterval:s})}}));function ss({children:t}){const{isAuthenticated:s,_hasHydrated:n}=oe();return n?s?e.jsx(e.Fragment,{children:t}):e.jsx(ke,{to:"/login",replace:!0}):e.jsx(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(A,{})})}const S=ut.create({baseURL:"/api",timeout:3e4,headers:{"Content-Type":"application/json"}});var H=(t=>(t[t.Success=0]="Success",t[t.InvalidRequest=1001]="InvalidRequest",t[t.MissingParameter=1002]="MissingParameter",t[t.InvalidParameter=1003]="InvalidParameter",t[t.Unauthorized=1004]="Unauthorized",t[t.TokenExpired=1005]="TokenExpired",t[t.TokenInvalid=1006]="TokenInvalid",t[t.PermissionDenied=1007]="PermissionDenied",t[t.InvalidToken=1008]="InvalidToken",t[t.InvalidCredentials=1009]="InvalidCredentials",t[t.UserNotFound=2001]="UserNotFound",t[t.NodeNotFound=2002]="NodeNotFound",t[t.TaskNotFound=2003]="TaskNotFound",t[t.VersionNotFound=2004]="VersionNotFound",t[t.UserExists=2009]="UserExists",t[t.NodeOffline=2101]="NodeOffline",t[t.NodeBusy=2102]="NodeBusy",t[t.InternalError=5001]="InternalError",t[t.DatabaseError=5002]="DatabaseError",t))(H||{});S.interceptors.request.use(t=>{const s=oe.getState().token;return s&&t.headers&&(t.headers.Authorization=`Bearer ${s}`),t},t=>Promise.reject(t));S.interceptors.response.use(t=>{const{data:s}=t;return s.code!==H.Success?((s.code===H.Unauthorized||s.code===H.TokenExpired||s.code===H.TokenInvalid||s.code===H.InvalidToken)&&(oe.getState().clearAuth(),window.location.href="/login"),Promise.reject(new Error(s.message||"请求失败"))):t},t=>{if(t.response){const{status:s,data:n}=t.response;switch(s){case 401:return oe.getState().clearAuth(),window.location.href="/login",Promise.reject(new Error("未授权，请重新登录"));case 403:return Promise.reject(new Error("没有权限访问"));case 404:return Promise.reject(new Error("请求的资源不存在"));case 500:return Promise.reject(new Error("服务器内部错误"));default:return Promise.reject(new Error(n?.message||"请求失败"))}}else if(t.request){const s=t.config?.baseURL||"未知",n=t.config?.url||"未知",r=`网络连接失败，无法连接到服务器 ${s}${n}。请检查：
1. Manager 服务是否已启动（运行 make run-dev）
2. API 地址配置是否正确（检查 .env.development 文件）
3. 防火墙或网络设置`;return Promise.reject(new Error(r))}else return Promise.reject(new Error(t.message||"请求失败"))});function ns(t){return S.get(`/api/v1/nodes/${t}/agents`).then(s=>s.data)}function rs(t,s,n){return S.post(`/api/v1/nodes/${t}/agents/${s}/operate`,{operation:n}).then(r=>r.data)}function as(t,s,n){const r={lines:n};return S.get(`/api/v1/nodes/${t}/agents/${s}/logs`,{params:r}).then(a=>a.data)}function is(t){return S.post("/api/v1/auth/login",t).then(s=>s.data)}function os(t){return S.post("/api/v1/auth/register",t).then(s=>s.data)}function ls(){return S.get("/api/v1/auth/profile").then(t=>t.data)}function cs(t){return S.post("/api/v1/auth/change-password",t).then(s=>s.data)}function ds(t){return S.get("/api/v1/nodes",{params:t}).then(s=>s.data)}function us(t){return S.get(`/api/v1/nodes/${t}`).then(s=>s.data)}function hs(t){return S.delete(`/api/v1/nodes/${t}`).then(s=>s.data)}function xs(t){return S.get(`/api/v1/metrics/nodes/${t}/latest`).then(s=>s.data)}function ms(t,s,n){return S.get(`/api/v1/metrics/nodes/${t}/${s}/history`,{params:n}).then(r=>r.data)}function gs(){return S.get("/api/v1/metrics/cluster/overview").then(t=>t.data)}function Ze(){const{setAuth:t,clearAuth:s,updateUser:n,isAuthenticated:r,user:a}=oe(),o=K({mutationFn:l=>is(l),onSuccess:l=>{const{token:h,user:m}=l.data;t(m,h)}}),u=K({mutationFn:l=>os(l)}),d=K({mutationFn:l=>cs(l)}),c=K({mutationFn:()=>ls(),onSuccess:l=>{n(l.data.user)}}),i=()=>{s()};return{isAuthenticated:r,user:a,login:o.mutateAsync,register:u.mutateAsync,changePassword:d.mutateAsync,getProfile:c.mutateAsync,logout:i,isLoggingIn:o.isPending,isRegistering:u.isPending,isChangingPassword:d.isPending,isLoadingProfile:c.isPending,loginError:o.error,registerError:u.error,changePasswordError:d.error,profileError:c.error}}function fs(t){return W({queryKey:["nodes",t],queryFn:()=>ds(t)})}function js(t){return W({queryKey:["node",t],queryFn:()=>us(t),enabled:!!t})}function ps(){const t=Oe();return K({mutationFn:s=>hs(s),onSuccess:()=>{t.invalidateQueries({queryKey:["nodes"]}),t.invalidateQueries({queryKey:["node-statistics"]})}})}function le(t){return W({queryKey:["metrics","latest",t],queryFn:()=>xs(t),enabled:!!t,refetchInterval:3e4,staleTime:25e3,onError:s=>{console.error("获取最新指标失败:",s)}})}function ue(t,s,n){return W({queryKey:["metrics","history",t,s,n.startTime.getTime(),n.endTime.getTime()],queryFn:()=>ms(t,s,{start_time:n.startTime.toISOString(),end_time:n.endTime.toISOString()}),enabled:!!t&&!!s,refetchOnWindowFocus:!1,staleTime:300*1e3,onError:r=>{console.error("获取历史指标失败:",r)}})}function vs(){const t=ee(),{refreshInterval:s}=Me();return W({queryKey:["metrics","cluster","overview"],queryFn:()=>gs(),refetchInterval:s||!1,staleTime:25e3,onError:n=>{if(n&&typeof n=="object"&&"response"in n){const r=n;(r.response?.status===401||r.response?.data?.code===H.Unauthorized)&&t("/login")}console.error("获取集群概览失败:",n)}})}const G=240,ys=[{text:"仪表盘",path:"/dashboard",icon:e.jsx(Pt,{})},{text:"节点管理",path:"/nodes",icon:e.jsx(R,{})}];function bs(){const t=ee(),{user:s,logout:n}=Ze(),[r,a]=x.useState(!1),[o,u]=x.useState(null),d=()=>{a(!r)},c=p=>{t(p),a(!1)},i=p=>{u(p.currentTarget)},l=()=>{u(null)},h=()=>{n(),t("/login")},m=e.jsxs(j,{children:[e.jsx(ve,{children:e.jsx(g,{variant:"h6",noWrap:!0,component:"div",children:"Ops Scaffold"})}),e.jsx(Z,{}),e.jsx(re,{children:ys.map(p=>e.jsx(ae,{disablePadding:!0,children:e.jsxs(bt,{onClick:()=>c(p.path),children:[e.jsx(Ae,{children:p.icon}),e.jsx(xe,{primary:p.text})]})},p.text))})]});return e.jsxs(j,{sx:{display:"flex"},children:[e.jsx(wt,{position:"fixed",sx:{width:{sm:`calc(100% - ${G}px)`},ml:{sm:`${G}px`}},children:e.jsxs(ve,{children:[e.jsx(O,{color:"inherit",edge:"start",onClick:d,sx:{mr:2,display:{sm:"none"}},children:e.jsx(Tt,{})}),e.jsx(g,{variant:"h6",noWrap:!0,component:"div",sx:{flexGrow:1},children:"运维管理平台"}),e.jsx(O,{color:"inherit",onClick:i,children:e.jsx(Ct,{sx:{width:32,height:32},children:e.jsx(_t,{})})}),e.jsxs(kt,{anchorEl:o,open:!!o,onClose:l,children:[e.jsx(ze,{disabled:!0,children:e.jsx(g,{variant:"body2",children:s?.username})}),e.jsx(Z,{}),e.jsxs(ze,{onClick:h,children:[e.jsx(Ae,{children:e.jsx(St,{fontSize:"small"})}),e.jsx(xe,{children:"退出登录"})]})]})]})}),e.jsxs(j,{component:"nav",sx:{width:{sm:G},flexShrink:{sm:0}},children:[e.jsx(Be,{variant:"temporary",open:r,onClose:d,ModalProps:{keepMounted:!0},sx:{display:{xs:"block",sm:"none"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:G}},children:m}),e.jsx(Be,{variant:"permanent",sx:{display:{xs:"none",sm:"block"},"& .MuiDrawer-paper":{boxSizing:"border-box",width:G}},open:!0,children:m})]}),e.jsxs(j,{component:"main",sx:{flexGrow:1,p:3,width:{sm:`calc(100% - ${G}px)`}},children:[e.jsx(ve,{}),e.jsx(ht,{})]})]})}function ws(){const t=ee(),{login:s,isLoggingIn:n,loginError:r}=Ze(),[a,o]=x.useState(""),{register:u,handleSubmit:d,formState:{errors:c}}=xt(),i=async l=>{try{o(""),await s(l),t("/dashboard")}catch(h){const m=h instanceof Error?h.message:"登录失败，请重试";o(m)}};return e.jsx(Y,{maxWidth:"sm",children:e.jsx(j,{sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(q,{sx:{width:"100%",maxWidth:500},children:e.jsxs(J,{sx:{p:4},children:[e.jsx(g,{variant:"h4",component:"h1",gutterBottom:!0,align:"center",children:"Ops Scaffold Framework"}),e.jsx(g,{variant:"body2",color:"text.secondary",align:"center",mb:4,children:"分布式运维管理平台"}),(a||r)&&e.jsx(B,{severity:"error",sx:{mb:2},children:a||r?.message}),e.jsxs("form",{onSubmit:d(i),children:[e.jsx(Le,{fullWidth:!0,label:"用户名",margin:"normal",...u("username",{required:"请输入用户名"}),error:!!c.username,helperText:c.username?.message,disabled:n}),e.jsx(Le,{fullWidth:!0,label:"密码",type:"password",margin:"normal",...u("password",{required:"请输入密码"}),error:!!c.password,helperText:c.password?.message,disabled:n}),e.jsx(z,{fullWidth:!0,type:"submit",variant:"contained",size:"large",sx:{mt:3},disabled:n,children:n?"登录中...":"登录"})]})]})})})})}function Ts({title:t,value:s,unit:n,percentage:r,icon:a,color:o,loading:u,error:d,extraInfo:c}){return u?e.jsx(q,{elevation:2,children:e.jsxs(J,{children:[e.jsx($,{variant:"text",width:"60%",height:32}),e.jsx($,{variant:"text",width:"40%",height:48,sx:{mt:1}}),e.jsx($,{variant:"rectangular",height:8,sx:{mt:2,borderRadius:1}})]})}):d?e.jsx(q,{elevation:2,children:e.jsx(J,{children:e.jsx(B,{severity:"error",children:d})})}):e.jsx(q,{elevation:2,children:e.jsxs(J,{children:[e.jsxs(j,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(g,{variant:"h6",component:"div",children:t}),a&&e.jsx(j,{sx:{color:"text.secondary"},children:a})]}),e.jsx(j,{mb:r!==void 0?2:0,children:e.jsxs(g,{variant:"h4",component:"div",sx:{fontWeight:"bold"},children:[s,n&&e.jsx(g,{component:"span",variant:"body2",sx:{ml:.5,color:"text.secondary"},children:n})]})}),r!==void 0&&e.jsx(j,{sx:{mb:1},children:e.jsx(We,{variant:"determinate",value:Math.min(r,100),sx:{height:8,borderRadius:1,backgroundColor:"grey.200","& .MuiLinearProgress-bar":{backgroundColor:o||"primary.main"}}})}),c&&e.jsx(j,{sx:{mt:1},children:e.jsx(g,{variant:"caption",color:"text.secondary",children:c})})]})})}const k=x.memo(Ts);function je(t,s){return s?t<60?s.palette.success.main:t<80?s.palette.warning.main:s.palette.error.main:t<60?"success.main":t<80?"warning.main":"error.main"}function Cs(t,s){return t<85?"success.main":t<95?"warning.main":"error.main"}function ge(t){return Number((t/(1024*1024*1024)).toFixed(2))}function Te(t){return Number((t/(1024*1024)).toFixed(2))}function _s({nodes:t,loading:s=!1}){const n=Ee(),r=ee(),[a,o]=x.useState("cpu"),u=x.useMemo(()=>!t||t.length===0?[]:[...t].sort((l,h)=>a==="cpu"?h.cpu_usage-l.cpu_usage:h.memory_usage-l.memory_usage).slice(0,5),[t,a]),d=i=>{switch(i){case 1:return"#FFD700";case 2:return"#C0C0C0";case 3:return"#CD7F32";default:return n.palette.grey[500]}},c=(i,l)=>{l!==null&&o(l)};return e.jsxs(q,{elevation:2,children:[e.jsx(He,{title:"Top 5 资源使用节点",action:e.jsxs(fe,{value:a,exclusive:!0,onChange:c,size:"small","aria-label":"排序维度",children:[e.jsxs(I,{value:"cpu","aria-label":"按 CPU 排序",children:[e.jsx(me,{sx:{mr:.5},fontSize:"small"}),"CPU"]}),e.jsxs(I,{value:"memory","aria-label":"按内存排序",children:[e.jsx(R,{sx:{mr:.5},fontSize:"small"}),"内存"]})]})}),e.jsx(J,{children:s?e.jsx(re,{children:[1,2,3,4,5].map(i=>e.jsxs(j,{children:[e.jsxs(ae,{children:[e.jsx($,{variant:"circular",width:32,height:32,sx:{mr:2}}),e.jsx(xe,{primary:e.jsx($,{variant:"text",width:120}),secondary:e.jsx($,{variant:"text",width:80})}),e.jsx($,{variant:"text",width:60,sx:{ml:"auto"}})]}),i<5&&e.jsx(Z,{})]},i))}):u.length===0?e.jsx(g,{variant:"body2",color:"text.secondary",align:"center",sx:{py:4},children:"暂无节点数据"}):e.jsx(re,{children:u.map((i,l)=>{const h=l+1,m=a==="cpu"?i.cpu_usage:i.memory_usage,p=je(m,n);return e.jsxs(j,{children:[e.jsxs(ae,{button:!0,onClick:()=>r(`/nodes/${i.node_id}`),sx:{"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(j,{sx:{width:32,height:32,borderRadius:"50%",backgroundColor:d(h),color:"white",display:"flex",alignItems:"center",justifyContent:"center",mr:2,fontWeight:"bold"},children:e.jsx(g,{variant:"body2",fontWeight:"bold",children:h})}),e.jsx(xe,{primary:i.hostname,secondary:i.ip,sx:{flex:1}}),e.jsxs(j,{sx:{minWidth:120,ml:2},children:[e.jsxs(g,{variant:"body2",align:"right",sx:{mb:.5},children:[m.toFixed(1),"%"]}),e.jsx(We,{variant:"determinate",value:Math.min(m,100),sx:{height:6,borderRadius:3,backgroundColor:"grey.200","& .MuiLinearProgress-bar":{backgroundColor:p}}})]})]}),h<5&&e.jsx(Z,{})]},i.node_id)})})})]})}function Ce(t,s){return t==="cpu"||t==="memory"?s>90?{level:"critical",message:"资源使用严重"}:s>80?{level:"warning",message:"资源使用偏高"}:{level:"normal",message:"正常"}:t==="disk"?s>95?{level:"critical",message:"磁盘使用严重"}:s>85?{level:"warning",message:"磁盘使用偏高"}:{level:"normal",message:"正常"}:t==="network"?{level:"normal",message:"正常"}:{level:"normal",message:"正常"}}function ks(t){const s=[];if(t.cpu_usage!==void 0&&t.cpu_usage!==null){const{level:n,message:r}=Ce("cpu",t.cpu_usage);n!=="normal"&&s.push({node_id:t.node_id,hostname:t.hostname,metric_type:"CPU",current_value:t.cpu_usage,level:n,message:r})}if(t.memory_usage!==void 0&&t.memory_usage!==null){const{level:n,message:r}=Ce("memory",t.memory_usage);n!=="normal"&&s.push({node_id:t.node_id,hostname:t.hostname,metric_type:"内存",current_value:t.memory_usage,level:n,message:r})}if(t.disk_usage!==void 0&&t.disk_usage!==null){const{level:n,message:r}=Ce("disk",t.disk_usage);n!=="normal"&&s.push({node_id:t.node_id,hostname:t.hostname,metric_type:"磁盘",current_value:t.disk_usage,level:n,message:r})}return s}function Ss({nodes:t,loading:s=!1}){const n=ee(),r=x.useMemo(()=>{if(!t||t.length===0)return[];const i=t.flatMap(h=>ks(h)),l={critical:0,warning:1,normal:2};return i.sort((h,m)=>l[h.level]-l[m.level])},[t]),a=x.useMemo(()=>r.filter(i=>i.level!=="normal"),[r]),u=a.some(i=>i.level==="critical")?"error":a.length>0?"warning":"default",d=a.slice(0,10),c=a.length>10;return e.jsxs(q,{elevation:2,children:[e.jsx(He,{title:"告警信息",action:e.jsx(Mt,{badgeContent:a.length,color:u,children:e.jsx(Dt,{})})}),e.jsx(J,{children:s?e.jsx(re,{children:[1,2,3].map(i=>e.jsxs(j,{children:[e.jsx(ae,{children:e.jsx($,{variant:"rectangular",width:"100%",height:60})}),i<3&&e.jsx(Z,{})]},i))}):a.length===0?e.jsx(B,{severity:"success",children:"所有节点运行正常"}):e.jsxs(re,{children:[d.map((i,l)=>e.jsxs(j,{children:[e.jsx(ae,{button:!0,onClick:()=>n(`/nodes/${i.node_id}`),sx:{p:0,"&:hover":{backgroundColor:"action.hover"}},children:e.jsx(B,{severity:i.level==="critical"?"error":"warning",variant:"outlined",sx:{width:"100%",cursor:"pointer"},children:e.jsxs(g,{variant:"body2",component:"div",children:[e.jsx(g,{component:"span",fontWeight:"bold",children:i.hostname})," - ",e.jsxs(g,{component:"span",color:"text.secondary",children:[i.metric_type," 使用率 ",i.current_value.toFixed(1),"%"]})," - ",e.jsx(g,{component:"span",color:"text.secondary",children:i.message})]})})}),l<d.length-1&&e.jsx(Z,{sx:{my:1}})]},`${i.node_id}-${i.metric_type}-${l}`)),c&&e.jsxs(g,{variant:"body2",color:"text.secondary",align:"center",sx:{mt:2},children:["还有 ",a.length-10," 个告警..."]})]})})]})}function Ps({nodeId:t}){const{data:s,isLoading:n,error:r}=le(t),a=s?.data?.cpu,o=a?.values,{usagePercent:u,color:d,extraInfo:c}=x.useMemo(()=>{if(!n&&!r&&!a)return{usagePercent:0,color:void 0,extraInfo:void 0};const i=o?.usage_percent||0,l=o?.cores,h=o?.model,m=je(i),p=e.jsxs(e.Fragment,{children:[l&&`核心数: ${l}`,l&&h&&" • ",h&&`型号: ${h}`]});return{usagePercent:i,color:m,extraInfo:p}},[n,r,a,o]);return!n&&!r&&!a?e.jsx(k,{title:"CPU 使用率",value:"-",icon:e.jsx(me,{}),loading:!1}):e.jsx(k,{title:"CPU 使用率",value:u.toFixed(1),unit:"%",percentage:u,icon:e.jsx(me,{}),color:d,loading:n,error:r?.message,extraInfo:c||void 0})}function Ms({nodeId:t}){const{data:s,isLoading:n,error:r}=le(t),a=s?.data?.memory,o=a?.values,{usedGB:u,totalGB:d,usagePercent:c,color:i,hasData:l}=x.useMemo(()=>{if(!n&&!r&&!a)return{usedGB:0,totalGB:0,usagePercent:0,color:void 0,hasData:!1};const h=o?.used_bytes||0,m=o?.total_bytes||0,p=o?.usage_percent||0,w=m>0||h>0||p>0;return{usedGB:ge(h),totalGB:ge(m),usagePercent:p,color:je(p),hasData:w}},[n,r,a,o]);return!n&&!r&&!a?e.jsx(k,{title:"内存使用",value:"-",icon:e.jsx(R,{}),loading:!1}):!n&&!r&&!l?e.jsx(k,{title:"内存使用",value:"暂无数据",icon:e.jsx(R,{}),loading:!1}):e.jsx(k,{title:"内存使用",value:`${u} / ${d}`,unit:"GB",percentage:c,icon:e.jsx(R,{}),color:i,loading:n,error:r?.message})}function Ds({nodeId:t}){const{data:s,isLoading:n,error:r}=le(t),a=s?.data?.disk,o=a?.values,{usedGB:u,totalGB:d,usagePercent:c,color:i,hasData:l}=x.useMemo(()=>{if(!n&&!r&&!a)return{usedGB:0,totalGB:0,usagePercent:0,color:void 0,hasData:!1};const h=o?.used_bytes||0,m=o?.total_bytes||0,p=o?.usage_percent||0,w=m>0||h>0||p>0;return{usedGB:ge(h),totalGB:ge(m),usagePercent:p,color:Cs(p),hasData:w}},[n,r,a,o]);return!n&&!r&&!a?e.jsx(k,{title:"磁盘使用",value:"-",icon:e.jsx(R,{}),loading:!1}):!n&&!r&&!l?e.jsx(k,{title:"磁盘使用",value:"暂无数据",icon:e.jsx(R,{}),loading:!1}):e.jsx(k,{title:"磁盘使用",value:`${u} / ${d}`,unit:"GB",percentage:c,icon:e.jsx(R,{}),color:i,loading:n,error:r?.message})}function Is({nodeId:t}){const{data:s,isLoading:n,error:r}=le(t),a=s?.data?.network,o=a?.values,{totalMB:u,extraInfo:d,hasData:c}=x.useMemo(()=>{if(!n&&!r&&!a)return{totalMB:0,extraInfo:void 0,hasData:!1};const l=o?.rx_bytes||0,h=o?.tx_bytes||0,m=l+h,p=m>0||l>0||h>0,w=Te(l),P=Te(h);return{totalMB:Te(m),extraInfo:`接收: ${w} MB • 发送: ${P} MB`,hasData:p}},[n,r,a,o]);return!n&&!r&&!a?e.jsx(k,{title:"网络流量",value:"-",icon:e.jsx(ye,{}),loading:!1}):!n&&!r&&!c?e.jsx(k,{title:"网络流量",value:"暂无数据",icon:e.jsx(ye,{}),loading:!1}):e.jsx(k,{title:"网络流量",value:u.toFixed(2),unit:"MB",icon:e.jsx(ye,{}),color:"primary.main",loading:n,error:r?.message,extraInfo:d})}function As({active:t,payload:s,label:n}){if(t&&s&&s.length){const r=n,a=s[0].value,o=s[0].payload?.unit||"";return e.jsxs(F,{elevation:3,sx:{p:1.5,backgroundColor:"rgba(255, 255, 255, 0.95)"},children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:V(new Date(r),"yyyy-MM-dd HH:mm:ss")}),e.jsxs(g,{variant:"body1",sx:{fontWeight:"bold",mt:.5},children:[a.toFixed(2)," ",o]})]})}return null}function zs(t,s){const n=new Date(t);return s<=900*1e3?V(n,"HH:mm"):s<=1440*60*1e3?V(n,"HH:mm"):s<=10080*60*1e3?V(n,"MM-dd HH:mm"):V(n,"MM-dd")}function Bs(t){return s=>zs(s,t)}function Ls(t,s){return s==="%"?`${t}%`:`${t} ${s}`}function $s({data:t,title:s,unit:n,color:r,loading:a,height:o=300}){const u=x.useMemo(()=>{if(t.length<2)return 0;const c=t[0].timestamp;return t[t.length-1].timestamp-c},[t]);if(a)return e.jsxs(F,{elevation:2,sx:{p:2},children:[e.jsx($,{variant:"text",width:"40%",height:24,sx:{mb:2}}),e.jsx($,{variant:"rectangular",height:o})]});if(!t||t.length===0)return e.jsx(F,{elevation:2,sx:{p:2,textAlign:"center"},children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"暂无数据"})});const d=t.map(c=>({...c,unit:n}));return e.jsxs(F,{elevation:2,sx:{p:2,height:"100%"},children:[e.jsx(g,{variant:"h6",gutterBottom:!0,children:s}),e.jsx(Vt,{width:"100%",height:o,children:e.jsxs(Yt,{data:d,margin:{top:10,right:30,left:20,bottom:30},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:`gradient-${r}`,x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:r,stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:r,stopOpacity:.1})]})}),e.jsx(Qt,{dataKey:"timestamp",tickFormatter:Bs(u),style:{fontSize:"12px"}}),e.jsx(Xt,{tickFormatter:c=>Ls(c,n),style:{fontSize:"12px"}}),e.jsx(Jt,{content:e.jsx(As,{})}),e.jsx(Zt,{type:"monotone",dataKey:"value",stroke:r,fill:`url(#gradient-${r})`,fillOpacity:.6})]})})]})}const Fs=x.memo($s),Rs=Object.freeze(Object.defineProperty({__proto__:null,default:Fs},Symbol.toStringTag,{value:"Module"}));function Ns({value:t,onChange:s}){const[n,r]=x.useState(!1),[a,o]=x.useState(t.startTime),[u,d]=x.useState(t.endTime),[c,i]=x.useState(null),l=x.useMemo(()=>{const C=t.startTime.getTime(),T=t.endTime.getTime()-C;return Math.abs(T-900*1e3)<1e3?"15m":Math.abs(T-1800*1e3)<1e3?"30m":Math.abs(T-3600*1e3)<1e3?"1h":Math.abs(T-1440*60*1e3)<1e3?"1d":Math.abs(T-10080*60*1e3)<1e3?"7d":Math.abs(T-720*60*60*1e3)<1e3?"30d":null},[t.startTime,t.endTime]),[h,m]=x.useState(l);x.useEffect(()=>{m(l)},[l]);const p=(C,_)=>{if(_===null)return;m(_),i(null);const T=new Date;let M;switch(_){case"15m":M=new Date(T.getTime()-900*1e3);break;case"30m":M=new Date(T.getTime()-1800*1e3);break;case"1h":M=new Date(T.getTime()-3600*1e3);break;case"1d":M=new Date(T.getTime()-1440*60*1e3);break;case"7d":M=new Date(T.getTime()-10080*60*1e3);break;case"30d":M=new Date(T.getTime()-720*60*60*1e3);break;default:return}s({startTime:M,endTime:T})},w=()=>{o(t.startTime),d(t.endTime),i(null),r(!0)},P=()=>{r(!1),i(null)},v=()=>{if(!a||!u){i("请选择开始时间和结束时间");return}if(u<=a){i("结束时间必须晚于开始时间");return}if((u.getTime()-a.getTime())/(1e3*60*60*24)>30){i("时间范围不能超过 30 天");return}m(null),s({startTime:a,endTime:u}),P()};return e.jsxs(j,{children:[e.jsxs(fe,{value:h,exclusive:!0,onChange:p,"aria-label":"时间范围选择",size:"small",children:[e.jsx(I,{value:"15m","aria-label":"15分钟",children:"15分钟"}),e.jsx(I,{value:"30m","aria-label":"30分钟",children:"30分钟"}),e.jsx(I,{value:"1h","aria-label":"1小时",children:"1小时"}),e.jsx(I,{value:"1d","aria-label":"1天",children:"1天"}),e.jsx(I,{value:"7d","aria-label":"7天",children:"7天"}),e.jsx(I,{value:"30d","aria-label":"30天",children:"30天"})]}),e.jsx(z,{variant:"outlined",size:"small",onClick:w,sx:{ml:1},children:"自定义时间"}),e.jsxs(qe,{open:n,onClose:P,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ge,{children:"选择自定义时间范围"}),e.jsx(Ke,{children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:2,mt:2},children:[e.jsxs(It,{dateAdapter:At,adapterLocale:Ue,children:[e.jsx($e,{label:"开始时间",value:a,onChange:C=>{o(C),i(null)},slotProps:{textField:{fullWidth:!0}}}),e.jsx($e,{label:"结束时间",value:u,onChange:C=>{d(C),i(null)},slotProps:{textField:{fullWidth:!0}}})]}),c&&e.jsx(B,{severity:"error",sx:{mt:1},children:c})]})}),e.jsxs(Ve,{children:[e.jsx(z,{onClick:P,children:"取消"}),e.jsx(z,{onClick:v,variant:"contained",children:"确认"})]})]})]})}const Os=x.memo(Ns);function Us({value:t,onChange:s,onRefresh:n}){const r=x.useMemo(()=>t===null?null:Math.floor(t/1e3),[t]),[a,o]=x.useState(r);x.useEffect(()=>{o(r)},[r]),x.useEffect(()=>{if(t===null||a===null)return;const d=setInterval(()=>{o(c=>c===null||c<=1?(n&&n(),Math.floor(t/1e3)):c-1)},1e3);return()=>clearInterval(d)},[t,a,n]);const u=(d,c)=>{s(c)};return e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(fe,{value:t,exclusive:!0,onChange:u,"aria-label":"刷新间隔选择",size:"small",children:[e.jsxs(I,{value:null,"aria-label":"暂停",children:[e.jsx(zt,{sx:{mr:.5},fontSize:"small"}),"暂停"]}),e.jsxs(I,{value:3e4,"aria-label":"30秒",children:[e.jsx(ie,{sx:{mr:.5},fontSize:"small"}),"30秒"]}),e.jsxs(I,{value:6e4,"aria-label":"1分钟",children:[e.jsx(ie,{sx:{mr:.5},fontSize:"small"}),"1分钟"]})]}),a!==null&&a>0&&e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,ml:1},children:[e.jsx(A,{size:20,variant:"determinate",value:a/Math.floor((t||0)/1e3)*100}),e.jsxs(g,{variant:"caption",color:"text.secondary",children:[a,"s"]})]})]})}const et=x.memo(Us);function Ws(){const t=Ee(),{data:s,isLoading:n,error:r,refetch:a,dataUpdatedAt:o}=vs(),{refreshInterval:u,setRefreshInterval:d}=Me(),c=s?.data?.aggregate,i=s?.data?.nodes||[],l=c?.node_counts.total?c.node_counts.online/c.node_counts.total*100:0,h=l>90?t.palette.success.main:l>70?t.palette.warning.main:t.palette.error.main,m=()=>{a()},p=w=>w?V(new Date(w),"yyyy-MM-dd HH:mm:ss",{locale:Ue}):"-";return e.jsxs(Y,{maxWidth:!1,sx:{maxWidth:"1400px",px:3},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,flexWrap:"wrap",gap:2},children:[e.jsx(g,{variant:"h4",children:"集群监控 Dashboard"}),e.jsx(et,{value:u,onChange:d,onRefresh:m})]}),r&&e.jsxs(B,{severity:"error",action:e.jsx(z,{color:"inherit",size:"small",onClick:()=>a(),children:"重试"}),sx:{mb:3},children:["加载集群数据失败: ",r instanceof Error?r.message:"未知错误"]}),e.jsxs(b,{container:!0,spacing:2.5,sx:{mt:.5},children:[e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(k,{title:"集群平均 CPU",value:n?"-":c?.avg_cpu?.toFixed(1)||"0.0",unit:"%",percentage:c?.avg_cpu||0,icon:e.jsx(me,{fontSize:"large"}),color:c?.avg_cpu?je(c.avg_cpu,t):void 0,loading:n,error:r?.message})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(k,{title:"集群总内存",value:n?"-":c?.total_memory_gb?`${c.total_memory_gb.toFixed(2)}`:"0.00",unit:"GB",percentage:0,icon:e.jsx(R,{fontSize:"large"}),color:t.palette.info.main,loading:n,error:r?.message})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(k,{title:"集群总磁盘",value:n?"-":c?.total_disk_gb?`${c.total_disk_gb.toFixed(2)}`:"0.00",unit:"GB",percentage:0,icon:e.jsx(Bt,{fontSize:"large"}),color:t.palette.info.main,loading:n,error:r?.message})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(k,{title:"节点状态",value:n?"-":`${c?.node_counts.online||0} / ${c?.node_counts.total||0}`,unit:"",percentage:l,icon:e.jsx(Lt,{fontSize:"large"}),color:h,loading:n,error:r?.message,extraInfo:c?.node_counts.offline?e.jsxs(g,{variant:"caption",color:"text.secondary",children:["离线: ",c.node_counts.offline]}):void 0})})]}),e.jsxs(b,{container:!0,spacing:2.5,sx:{mt:.5},children:[e.jsx(b,{size:{xs:12,lg:6},children:e.jsx(_s,{nodes:i,loading:n})}),e.jsx(b,{size:{xs:12,lg:6},children:e.jsx(Ss,{nodes:i,loading:n})})]}),o&&!n&&e.jsx(j,{sx:{mt:3,textAlign:"right"},children:e.jsxs(g,{variant:"caption",color:"text.secondary",children:["最后更新: ",p(o)]})})]})}function Es(){const t=ee(),[s,n]=x.useState(0),[r,a]=x.useState(20),{data:o,isLoading:u,refetch:d}=fs({page:s+1,page_size:r}),{mutate:c}=ps(),i=o?.data?.list||[],l=o?.data?.page_info?.total||0,h=(v,C)=>{n(C)},m=v=>{a(parseInt(v.target.value,10)),n(0)},p=v=>{window.confirm("确定要删除这个节点吗？")&&c(v)},w=v=>{switch(v){case"online":return"success";case"offline":return"error";default:return"default"}},P=v=>{switch(v){case"online":return"在线";case"offline":return"离线";default:return"未知"}};return e.jsxs(j,{children:[e.jsxs(j,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(g,{variant:"h4",children:"节点管理"}),e.jsx(O,{onClick:()=>d(),children:e.jsx(ie,{})})]}),e.jsxs(q,{children:[e.jsx(Ye,{children:e.jsxs(Qe,{children:[e.jsx(Xe,{children:e.jsxs(Q,{children:[e.jsx(y,{children:"节点ID"}),e.jsx(y,{children:"主机名"}),e.jsx(y,{children:"IP地址"}),e.jsx(y,{children:"操作系统"}),e.jsx(y,{children:"架构"}),e.jsx(y,{children:"状态"}),e.jsx(y,{children:"最后心跳"}),e.jsx(y,{children:"操作"})]})}),e.jsx(Je,{children:u?e.jsx(Q,{children:e.jsx(y,{colSpan:8,align:"center",children:e.jsx(A,{})})}):i.length===0?e.jsx(Q,{children:e.jsx(y,{colSpan:8,align:"center",children:"暂无数据"})}):i.map(v=>e.jsxs(Q,{hover:!0,children:[e.jsx(y,{children:v.node_id}),e.jsx(y,{children:e.jsx(g,{component:"a",onClick:()=>t(`/nodes/${v.node_id}`),sx:{cursor:"pointer",color:"primary.main",textDecoration:"none","&:hover":{textDecoration:"underline"}},children:v.hostname})}),e.jsx(y,{children:v.ip}),e.jsx(y,{children:v.os}),e.jsx(y,{children:v.arch}),e.jsx(y,{children:e.jsx(Pe,{label:P(v.status),color:w(v.status),size:"small"})}),e.jsx(y,{children:v.last_heartbeat_at?ts(v.last_heartbeat_at):"-"}),e.jsx(y,{children:e.jsx(O,{size:"small",color:"error",onClick:()=>p(v.id),children:e.jsx($t,{})})})]},v.id))})]})}),e.jsx(Ft,{component:"div",count:l,page:s,onPageChange:h,rowsPerPage:r,onRowsPerPageChange:m,rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:"每页行数:",labelDisplayedRows:({from:v,to:C,count:_})=>`${v}-${C} / 共 ${_!==-1?_:`超过 ${C}`}`})]})]})}const Hs="modulepreload",qs=function(t){return"/"+t},Fe={},Gs=function(s,n,r){let a=Promise.resolve();if(n&&n.length>0){let c=function(i){return Promise.all(i.map(l=>Promise.resolve(l).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=u?.nonce||u?.getAttribute("nonce");a=c(n.map(i=>{if(i=qs(i),i in Fe)return;Fe[i]=!0;const l=i.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${h}`))return;const m=document.createElement("link");if(m.rel=l?"stylesheet":Hs,l||(m.as="script"),m.crossOrigin="",m.href=i,d&&m.setAttribute("nonce",d),document.head.appendChild(m),l)return new Promise((p,w)=>{m.addEventListener("load",p),m.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${i}`)))})}))}function o(u){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=u,window.dispatchEvent(d),!d.defaultPrevented)throw u}return a.then(u=>{for(const d of u||[])d.status==="rejected"&&o(d.reason);return s().catch(o)})};function Ks(t,s,n){const r=[],a=s.getTime()-t.getTime(),o=Math.max(6e4,a/60),u=n==="cpu"?30:40,d=n==="cpu"?20:25;for(let c=t.getTime();c<=s.getTime();c+=o){const i=(c-t.getTime())/a,l=Math.sin(i*Math.PI*2)*5,h=(Math.random()-.5)*d,m=Math.max(0,Math.min(100,u+l+h));r.push({timestamp:c,value:Number(m.toFixed(2))})}return r}function Re(t,s,n,r){return W({queryKey:["agent-metrics","history",t,s,r,n.startTime.getTime(),n.endTime.getTime()],queryFn:async()=>{await new Promise(o=>setTimeout(o,300));const a=Ks(n.startTime,n.endTime,r);return{data:{agent_id:s||"",type:r,data_points:a.map(o=>({timestamp:new Date(o.timestamp).toISOString(),values:{usage_percent:o.value}}))}}},enabled:!!t&&!!s,refetchOnWindowFocus:!1,staleTime:300*1e3,onError:a=>{console.error("获取 Agent 历史指标失败:",a)}})}function _e(t,s){return!t||t.length===0?[]:t.map(n=>{const r=new Date(n.timestamp).getTime(),a=n.values[s];return{timestamp:r,value:typeof a=="number"?a:0}})}const X=x.lazy(()=>Gs(()=>Promise.resolve().then(()=>Rs),void 0));function he(t){const{children:s,value:n,index:r,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==r,id:`node-tabpanel-${r}`,"aria-labelledby":`node-tab-${r}`,...a,children:n===r&&e.jsx(j,{sx:{pt:3},children:s})})}function Vs(){const{id:t}=mt(),[s,n]=x.useState(1),{data:r,isLoading:a,error:o}=js(t||"");x.useEffect(()=>{document.title="节点详情 | Ops Manager"},[]);const u=(l,h)=>{n(h)};if(o)return e.jsx(Y,{maxWidth:"lg",children:e.jsxs(j,{sx:{py:4,textAlign:"center"},children:[e.jsx(g,{variant:"h6",color:"error",children:"加载节点信息失败"}),e.jsx(g,{variant:"body2",color:"text.secondary",sx:{mt:2},children:o instanceof Error?o.message:"未知错误"})]})});if(a)return e.jsx(Y,{maxWidth:"lg",children:e.jsx(j,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(A,{})})});const d=r?.data?.node;if(!d)return e.jsx(Y,{maxWidth:"lg",children:e.jsx(j,{sx:{py:4,textAlign:"center"},children:e.jsx(g,{variant:"h6",children:"节点不存在"})})});const c=l=>{switch(l){case"online":return"success";case"offline":return"error";default:return"default"}},i=l=>{switch(l){case"online":return"在线";case"offline":return"离线";default:return"未知"}};return e.jsxs(Y,{maxWidth:"xl",children:[e.jsxs(Rt,{"aria-label":"breadcrumb",sx:{mb:3},children:[e.jsxs(Ie,{to:"/dashboard",style:{textDecoration:"none",color:"inherit",display:"flex",alignItems:"center"},children:[e.jsx(Nt,{sx:{mr:.5},fontSize:"inherit"}),"首页"]}),e.jsxs(Ie,{to:"/nodes",style:{textDecoration:"none",color:"inherit",display:"flex",alignItems:"center"},children:[e.jsx(R,{sx:{mr:.5},fontSize:"inherit"}),"节点列表"]}),e.jsx(g,{color:"text.primary",children:"节点详情"})]}),e.jsxs(F,{elevation:2,sx:{p:3,mb:3},children:[e.jsx(g,{variant:"h5",gutterBottom:!0,children:d.hostname||d.node_id}),e.jsxs(b,{container:!0,spacing:2,sx:{mt:1},children:[e.jsxs(b,{item:!0,xs:12,sm:6,children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"节点 ID"}),e.jsx(g,{variant:"body1",children:d.node_id})]}),e.jsxs(b,{item:!0,xs:12,sm:6,children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"IP 地址"}),e.jsx(g,{variant:"body1",children:d.ip})]}),e.jsxs(b,{item:!0,xs:12,sm:6,children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"状态"}),e.jsx(Pe,{label:i(d.status),color:c(d.status),size:"small",sx:{mt:.5}})]}),e.jsxs(b,{item:!0,xs:12,sm:6,children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"操作系统"}),e.jsxs(g,{variant:"body1",children:[d.os," / ",d.arch]})]}),e.jsxs(b,{item:!0,xs:12,sm:6,children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"Daemon 版本"}),e.jsx(g,{variant:"body1",children:"-"})]}),e.jsxs(b,{item:!0,xs:12,sm:6,children:[e.jsx(g,{variant:"body2",color:"text.secondary",children:"Agent 版本"}),e.jsx(g,{variant:"body1",children:"-"})]})]})]}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider",mb:3},children:e.jsxs(Ot,{value:s,onChange:u,"aria-label":"节点详情标签页",children:[e.jsx(ce,{label:"概览"}),e.jsx(ce,{label:"监控"}),e.jsx(ce,{label:"日志"}),e.jsx(ce,{label:"Agents"})]})}),e.jsx(he,{value:s,index:0,children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"功能开发中"})}),e.jsx(he,{value:s,index:1,children:e.jsx(Ys,{nodeId:d.node_id})}),e.jsx(he,{value:s,index:2,children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"功能开发中"})}),e.jsx(he,{value:s,index:3,children:e.jsx(Qs,{nodeId:d.node_id})})]})}function Ys({nodeId:t}){const{timeRange:s,refreshInterval:n,setTimeRange:r,setRefreshInterval:a}=Me(),{data:o,isLoading:u,error:d,refetch:c}=le(t),i=ue(t,"cpu",s),l=ue(t,"memory",s),h=ue(t,"disk",s),m=ue(t,"network",s);x.useEffect(()=>{i.refetch(),l.refetch(),h.refetch(),m.refetch()},[s.startTime.getTime(),s.endTime.getTime()]),x.useEffect(()=>{if(!n)return;const _=setInterval(()=>{c(),i.refetch(),l.refetch(),h.refetch(),m.refetch()},n);return()=>clearInterval(_)},[n]);const p=x.useMemo(()=>_e(i.data?.data||[],"usage_percent"),[i.data?.data]),w=x.useMemo(()=>_e(l.data?.data||[],"usage_percent"),[l.data?.data]),P=x.useMemo(()=>_e(h.data?.data||[],"usage_percent"),[h.data?.data]),v=x.useMemo(()=>(m.data?.data||[]).map(_=>{const T=_.values?.rx_bytes||0,M=_.values?.tx_bytes||0,L=T+M;return{timestamp:new Date(_.timestamp).getTime(),value:L/(1024*1024)}}),[m.data?.data]),C=x.useCallback(()=>{c(),i.refetch(),l.refetch(),h.refetch(),m.refetch()},[c,i,l,h,m]);return u&&!o?e.jsx(j,{display:"flex",justifyContent:"center",py:4,children:e.jsx(A,{})}):d?e.jsx(B,{severity:"error",action:e.jsx(z,{color:"inherit",size:"small",onClick:()=>c(),children:"重试"}),sx:{mb:3},children:d instanceof Error?d.message:"加载监控数据失败"}):e.jsxs(j,{children:[e.jsxs(F,{elevation:1,sx:{p:2,mb:3,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2},children:[e.jsx(Os,{value:s,onChange:r}),e.jsx(et,{value:n,onChange:a,onRefresh:C})]}),e.jsxs(b,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(Ps,{nodeId:t})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(Ms,{nodeId:t})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(Ds,{nodeId:t})}),e.jsx(b,{size:{xs:12,sm:6,md:3},children:e.jsx(Is,{nodeId:t})})]}),e.jsxs(b,{container:!0,spacing:2.5,children:[e.jsx(b,{size:{xs:12,lg:6},children:e.jsx(x.Suspense,{fallback:e.jsx(A,{}),children:e.jsx(X,{data:p,title:"CPU 使用率趋势",unit:"%",color:"#2196f3",loading:i.isLoading,height:350})})}),e.jsx(b,{size:{xs:12,lg:6},children:e.jsx(x.Suspense,{fallback:e.jsx(A,{}),children:e.jsx(X,{data:w,title:"内存使用率趋势",unit:"%",color:"#4caf50",loading:l.isLoading,height:350})})}),e.jsx(b,{size:{xs:12,lg:6},children:e.jsx(x.Suspense,{fallback:e.jsx(A,{}),children:e.jsx(X,{data:P,title:"磁盘使用率趋势",unit:"%",color:"#ff9800",loading:h.isLoading,height:350})})}),e.jsx(b,{size:{xs:12,lg:6},children:e.jsx(x.Suspense,{fallback:e.jsx(A,{}),children:e.jsx(X,{data:v,title:"网络流量趋势",unit:"MB",color:"#9c27b0",loading:m.isLoading,height:350})})})]})]})}function Qs({nodeId:t}){const s=Oe(),[n,r]=x.useState(null),[a,o]=x.useState(!1),[u,d]=x.useState(null),[c,i]=x.useState(!0),[l,h]=x.useState(null),[m,p]=x.useState("1h"),{data:w,isLoading:P,error:v,refetch:C,isRefetching:_}=W({queryKey:["agents",t],queryFn:()=>ns(t),refetchInterval:3e4}),T=x.useCallback(f=>{const D=new Date,se=f==="1h"?1:f==="6h"?6:24;return{startTime:new Date(D.getTime()-se*60*60*1e3),endTime:D}},[]),M=x.useMemo(()=>T(m),[m,T]),L=Re(t,l,M,"cpu"),N=Re(t,l,M,"memory"),tt=x.useMemo(()=>L.data?.data?.data_points?L.data.data.data_points.map(f=>({timestamp:new Date(f.timestamp).getTime(),value:f.values?.usage_percent||0})):[],[L.data?.data?.data_points]),st=x.useMemo(()=>N.data?.data?.data_points?N.data.data.data_points.map(f=>({timestamp:new Date(f.timestamp).getTime(),value:f.values?.usage_percent||0})):[],[N.data?.data?.data_points]);x.useEffect(()=>{w?.data?.agents&&w.data.agents.length>0&&!l&&h(w.data.agents[0].agent_id)},[w?.data?.agents,l]),x.useEffect(()=>{l&&(L.refetch(),N.refetch())},[M.startTime.getTime(),M.endTime.getTime()]);const U=K({mutationFn:({agentId:f,operation:D})=>rs(t,f,D),onSuccess:(f,D)=>{s.invalidateQueries({queryKey:["agents",t]});const se={start:"启动",stop:"停止",restart:"重启"}[D.operation];r(`Agent ${se}成功`),setTimeout(()=>r(null),3e3)},onError:f=>{console.error("操作 Agent 失败:",f)}}),pe=(f,D)=>{U.mutate({agentId:f,operation:D})},nt=f=>{d(f),o(!0)},rt=()=>{o(!1),d(null)},at=f=>{switch(f){case"running":return"success";case"stopped":return"default";case"error":case"failed":return"error";case"starting":case"stopping":case"restarting":return"warning";default:return"default"}},it=f=>{switch(f){case"running":return"运行中";case"stopped":return"已停止";case"error":case"failed":return"错误";case"starting":return"启动中";case"stopping":return"停止中";case"restarting":return"重启中";default:return f}},ot=f=>{if(!f)return"-";try{return new Date(f).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch{return f}};if(P&&!w)return e.jsx(j,{display:"flex",justifyContent:"center",py:4,children:e.jsx(A,{})});if(v)return e.jsx(B,{severity:"error",action:e.jsx(z,{color:"inherit",size:"small",onClick:()=>C(),children:"重试"}),sx:{mb:3},children:v instanceof Error?v.message:"加载 Agent 列表失败"});const te=w?.data?.agents||[];return e.jsxs(j,{children:[n&&e.jsx(B,{severity:"success",sx:{mb:2},onClose:()=>r(null),children:n}),U.error&&e.jsx(B,{severity:"error",sx:{mb:2},onClose:()=>U.reset(),children:U.error instanceof Error?U.error.message:"操作失败"}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(g,{variant:"h6",children:"Agent 列表"}),e.jsx(ne,{title:"刷新",children:e.jsx(O,{onClick:()=>C(),disabled:_,size:"small",children:e.jsx(ie,{})})})]}),te.length===0?e.jsx(F,{sx:{p:4,textAlign:"center"},children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"该节点下暂无 Agent"})}):e.jsx(Ye,{component:F,sx:{overflow:"auto"},children:e.jsxs(Qe,{children:[e.jsx(Xe,{children:e.jsxs(Q,{children:[e.jsx(y,{children:"Agent ID"}),e.jsx(y,{children:"类型"}),e.jsx(y,{children:"版本"}),e.jsx(y,{children:"状态"}),e.jsx(y,{children:"PID"}),e.jsx(y,{children:"最后心跳"}),e.jsx(y,{align:"right",children:"操作"})]})}),e.jsx(Je,{children:te.map(f=>{const D=f.status==="running"||U.isPending,se=f.status==="stopped"||U.isPending,De=f.status==="stopped"||U.isPending,lt=l===f.agent_id;return e.jsxs(Q,{hover:!0,selected:lt,onClick:()=>h(f.agent_id),sx:{cursor:"pointer"},children:[e.jsx(y,{children:f.agent_id}),e.jsx(y,{children:f.type}),e.jsx(y,{children:f.version||"-"}),e.jsx(y,{children:e.jsx(Pe,{label:it(f.status),color:at(f.status),size:"small"})}),e.jsx(y,{children:f.pid||"-"}),e.jsx(y,{children:ot(f.last_heartbeat)}),e.jsxs(y,{align:"right",children:[e.jsx(ne,{title:"启动",children:e.jsx("span",{children:e.jsx(O,{size:"small",color:"primary",disabled:D,onClick:()=>pe(f.agent_id,"start"),children:e.jsx(Ut,{})})})}),e.jsx(ne,{title:"停止",children:e.jsx("span",{children:e.jsx(O,{size:"small",color:"error",disabled:se,onClick:()=>pe(f.agent_id,"stop"),children:e.jsx(Wt,{})})})}),e.jsx(ne,{title:"重启",children:e.jsx("span",{children:e.jsx(O,{size:"small",color:"warning",disabled:De,onClick:()=>pe(f.agent_id,"restart"),children:e.jsx(Et,{})})})}),e.jsx(ne,{title:"查看日志",children:e.jsx(O,{size:"small",color:"default",onClick:()=>nt(f.agent_id),children:e.jsx(Ht,{})})})]})]},f.id)})})]})}),l&&te.length>0&&e.jsxs(j,{sx:{mt:4},children:[e.jsx(F,{elevation:2,sx:{p:2,mb:2},children:e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2},children:[e.jsxs(g,{variant:"h6",children:["Agent 监控 - ",te.find(f=>f.agent_id===l)?.agent_id]}),e.jsxs(fe,{value:m,exclusive:!0,onChange:(f,D)=>{D&&p(D)},"aria-label":"时间范围选择",size:"small",children:[e.jsx(I,{value:"1h","aria-label":"1小时",children:"1小时"}),e.jsx(I,{value:"6h","aria-label":"6小时",children:"6小时"}),e.jsx(I,{value:"24h","aria-label":"24小时",children:"24小时"})]})]})}),e.jsxs(b,{container:!0,spacing:2.5,children:[e.jsx(b,{size:{xs:12,md:6},children:e.jsx(x.Suspense,{fallback:e.jsx(A,{}),children:e.jsx(X,{data:tt,title:"CPU 使用率",unit:"%",color:"#1976d2",loading:L.isLoading,height:300})})}),e.jsx(b,{size:{xs:12,md:6},children:e.jsx(x.Suspense,{fallback:e.jsx(A,{}),children:e.jsx(X,{data:st,title:"内存使用率",unit:"%",color:"#d32f2f",loading:N.isLoading,height:300})})})]}),(L.error||N.error)&&e.jsx(B,{severity:"error",sx:{mt:2},action:e.jsx(z,{color:"inherit",size:"small",onClick:()=>{L.refetch(),N.refetch()},children:"重试"}),children:L.error instanceof Error?L.error.message:N.error instanceof Error?N.error.message:"加载监控数据失败"})]}),!l&&te.length>0&&e.jsx(F,{sx:{p:4,textAlign:"center",mt:4},children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"请选择一个 Agent 查看监控数据"})}),e.jsx(Xs,{open:a,onClose:rt,nodeId:t,agentId:u,autoRefresh:c,onAutoRefreshChange:i})]})}function Xs({open:t,onClose:s,nodeId:n,agentId:r,autoRefresh:a,onAutoRefreshChange:o}){const{data:u,isLoading:d,error:c,refetch:i,isRefetching:l}=W({queryKey:["agent-logs",n,r],queryFn:()=>as(n,r,100),enabled:t&&!!r,refetchInterval:a&&t?5e3:!1}),h=()=>{if(!u?.data?.logs)return;const p=u.data.logs.join(`
`),w=new Blob([p],{type:"text/plain;charset=utf-8"}),P=URL.createObjectURL(w),v=document.createElement("a");v.href=P,v.download=`agent-${r}-logs-${new Date().toISOString()}.txt`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(P)},m=()=>c?c instanceof Error?c.message.includes("501")||c.message.includes("Not Implemented")?"日志功能暂未实现，请稍后重试":c.message:"加载日志失败":null;return e.jsxs(qe,{open:t,onClose:s,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Ge,{children:["Agent 日志 - ",r,a&&e.jsx(g,{variant:"caption",color:"text.secondary",sx:{ml:1},children:"(自动刷新中...)"})]}),e.jsx(Ke,{children:d&&!u?e.jsx(j,{display:"flex",justifyContent:"center",py:4,children:e.jsx(A,{})}):c?e.jsx(B,{severity:"error",action:e.jsx(z,{color:"inherit",size:"small",onClick:()=>i(),children:"重试"}),sx:{mb:2},children:m()}):!u?.data?.logs||u.data.logs.length===0?e.jsx(j,{py:4,textAlign:"center",children:e.jsx(g,{variant:"body2",color:"text.secondary",children:"暂无日志"})}):e.jsxs(j,{sx:{maxHeight:"400px",overflow:"auto",bgcolor:"grey.900",color:"grey.100",p:2,borderRadius:1,fontFamily:"monospace",fontSize:"0.875rem",position:"relative"},children:[l&&e.jsxs(j,{sx:{position:"absolute",top:8,right:8,display:"flex",alignItems:"center",gap:1,bgcolor:"rgba(0, 0, 0, 0.7)",px:1,py:.5,borderRadius:1},children:[e.jsx(A,{size:16,sx:{color:"grey.100"}}),e.jsx(g,{variant:"caption",sx:{color:"grey.100"},children:"刷新中..."})]}),u.data.logs.map((p,w)=>e.jsx(g,{component:"pre",sx:{m:0,whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.5},children:p},w))]})}),e.jsxs(Ve,{children:[e.jsx(z,{onClick:()=>o(!a),variant:a?"outlined":"text",size:"small",children:a?"停止自动刷新":"开启自动刷新"}),e.jsx(z,{onClick:()=>i(),disabled:l||d,startIcon:e.jsx(ie,{}),size:"small",children:"刷新"}),e.jsx(z,{onClick:h,disabled:!u?.data?.logs||u.data.logs.length===0,startIcon:e.jsx(qt,{}),variant:"outlined",size:"small",children:"导出"}),e.jsx(z,{onClick:s,variant:"contained",size:"small",children:"关闭"})]})]})}const Js=new gt({defaultOptions:{queries:{refetchOnWindowFocus:!1,retry:1,staleTime:5e3}}});function Zs(){return e.jsx(ft,{client:Js,children:e.jsxs(Gt,{theme:es,children:[e.jsx(Kt,{}),e.jsx(jt,{children:e.jsxs(pt,{children:[e.jsx(E,{path:"/login",element:e.jsx(ws,{})}),e.jsxs(E,{path:"/",element:e.jsx(ss,{children:e.jsx(bs,{})}),children:[e.jsx(E,{index:!0,element:e.jsx(ke,{to:"/dashboard",replace:!0})}),e.jsx(E,{path:"dashboard",element:e.jsx(Ws,{})}),e.jsx(E,{path:"nodes",element:e.jsx(Es,{})}),e.jsx(E,{path:"nodes/:id",element:e.jsx(Vs,{})})]}),e.jsx(E,{path:"*",element:e.jsx(ke,{to:"/dashboard",replace:!0})})]})})]})})}vt.createRoot(document.getElementById("root")).render(e.jsx(x.StrictMode,{children:e.jsx(Zs,{})}));
