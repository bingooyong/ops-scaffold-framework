# APM 命令说明文档

本文档介绍 Agentic Project Management (APM) 系统中各个命令的作用和使用场景。

## 命令概览

APM 系统包含 8 个核心命令，按优先级和用途分为以下几类：

### 初始化命令（Initiate Commands）

#### 1. `apm-1-initiate-setup.md` - 项目设置代理初始化
**优先级**: 1  
**作用**: 初始化 Setup Agent，负责项目规划阶段的工作

**主要职责**:
- 作为高级规划者，收集用户需求并创建详细的实施计划
- **不执行**实施计划，仅负责规划
- 执行五个步骤的设置流程：
  1. **上下文综合** - 通过引导式问答收集项目需求
  2. **项目分解与计划创建** - 创建初始实施计划
  3. **实施计划审查与优化** - 系统性审查计划（可选）
  4. **实施计划增强与最终确定** - 完善计划细节
  5. **引导提示创建** - 生成 Manager Agent 的启动提示

**使用场景**: 
- 新项目开始时
- 需要创建或更新项目实施计划时

**输出**: 
- `.apm/Implementation_Plan.md` - 详细实施计划
- `.apm/Memory/Memory_Root.md` - 记忆系统根文件
- Manager Agent Bootstrap Prompt - 用于启动第一个 Manager Agent

---

#### 2. `apm-2-initiate-manager.md` - 管理代理初始化
**优先级**: 2  
**作用**: 初始化 Manager Agent，负责项目执行协调和任务分配

**主要职责**:
- **严格协调和编排**，不执行任何实施、编码或研究任务
- 接收会话上下文（从 Setup Agent 或前一个 Manager）
- 审查和改进实施计划（如需要）
- 执行任务分配/评估循环
- 在上下文窗口限制时执行交接程序

**工作流程**:
- **路径 A - Bootstrap Prompt**: 作为第一个 Manager Agent，从 Setup Agent 接收引导提示
- **路径 B - Handover Prompt**: 从前一个 Manager Agent 接收交接提示

**使用场景**:
- 项目执行阶段开始时
- Manager Agent 需要交接时

**关键规则**:
- 仅引用指南文件名，不引用或转述内容
- 严格遵循所有引用的指南
- 监控令牌使用并在上下文窗口溢出前请求交接

---

#### 3. `apm-3-initiate-implementation.md` - 实施代理初始化
**优先级**: 3  
**作用**: 初始化 Implementation Agent，负责具体任务的执行

**主要职责**:
- 接收 Manager Agent 分配的任务并执行
- 执行单步或多步任务模式
- 在需要时委托给 Ad-Hoc 代理
- 在记忆系统中记录所有完成情况、问题或阻塞

**任务执行模式**:
- **单步任务**: 在**一次响应**中完成所有子任务（无序列表格式）
- **多步任务**: 在**多次响应**中完成工作（有序列表格式），每步后等待用户确认

**错误处理协议**:
- **轻微问题**: ≤ 2 次调试尝试且简单错误 → 本地调试
- **重大问题**: > 2 次调试尝试或复杂/系统性问题 → **必须委托**

**使用场景**:
- 需要执行具体开发任务时
- 从 Manager Agent 接收任务分配时

**关键规则**:
- 遵循错误处理和调试委托协议
- 立即暂停并在任务分配模糊或不完整时请求澄清
- 仅在任务分配明确指示或认为必要时委托给 Ad-Hoc 代理

---

#### 4. `apm-4-initiate-adhoc.md` - 临时代理初始化
**优先级**: 4  
**作用**: 初始化临时 Ad-Hoc Agent，用于处理独立任务（如调试、研究）

**主要职责**:
- 作为临时专家处理 Implementation Agent 委托的专门工作
- 尊重委托边界，仅在分配的范围内工作
- 完全执行委托：收集所需信息或解决分配的问题
- 维护 APM 会话，实现与 Implementation Agent 工作流的无缝集成

**委托类型**:
- **信息收集**: 研究当前文档、最佳实践或技术规范
- **问题解决**: 实际调试问题、解决阻塞或完成技术工作

**工作流程**:
1. 接收委托提示并评估范围
2. 执行分配的工作 + 呈现发现 + 请求确认（一次响应）
3. 在用户确认后，以**单个 markdown 代码块**格式交付最终结果

**使用场景**:
- 需要专门的研究或调试工作时
- Implementation Agent 需要委托任务时

**关键规则**:
- 最终交付物必须在单个 markdown 代码块中提供
- 使用文本描述而非代码块内的代码块以保持正确的 markdown 结构
- 专注于清晰性和可操作性

---

### 交接命令（Handover Commands）

#### 5. `apm-5-handover-manager.md` - 管理代理交接
**优先级**: 5  
**作用**: 引导 Manager Agent 执行交接程序，将项目协调上下文转移给新的代理实例

**交接资格**:
- 仅在当前**完整任务执行周期**完成时才有资格
- 必须完成：任务分配已发出、实施代理执行完成、记忆日志已收到并审查、下一个行动决策已做出

**阻塞场景**:
- 等待任务完成
- 等待记忆日志返回
- 审查过程进行中
- 任何其他不完整的任务协调步骤

**交接产物**:
- **Handover Prompt**: 在聊天中作为 markdown 代码块呈现，用于复制粘贴到新会话
- **Handover File**: 作为物理 markdown 文件创建在专用目录结构中

**文件组织**:
- 存储在 `.apm/Memory/Handovers/Manager_Agent_Handovers/`
- 命名格式: `Manager_Agent_Handover_File_[Number].md`

**使用场景**:
- Manager Agent 接近上下文窗口限制时
- 需要将项目协调职责转移给新的 Manager Agent 时

---

#### 6. `apm-6-handover-implementation.md` - 实施代理交接
**优先级**: 6  
**作用**: 引导 Implementation Agent 执行交接程序，将任务执行上下文转移给新的代理实例

**交接资格**:
- 仅在当前**完整任务执行周期**完成时才有资格
- 必须完成：任务工作完全完成、Ad-Hoc 代理委托完成、记忆日志彻底完成、用户报告完成

**阻塞场景**:
- 任务执行进行中
- 等待用户确认
- 委托过程进行中
- 记忆日志不完整
- 报告不完整

**交接产物**:
- **Handover Prompt**: 在聊天中作为 markdown 代码块呈现
- **Handover File**: 作为物理 markdown 文件创建

**文件组织**:
- 存储在 `.apm/Memory/Handovers/[Agent_Name]_Handovers/`
- 命名格式: `[Agent_Name]_Handover_File_[Number].md`

**使用场景**:
- Implementation Agent 接近上下文窗口限制时
- 需要将任务执行职责转移给新的 Implementation Agent 时

---

### 委托命令（Delegate Commands）

#### 7. `apm-7-delegate-research.md` - 研究任务委托指南
**优先级**: 7  
**作用**: 提供将研究任务委托给 Ad-Hoc 代理的模板

**委托场景**:
- 遇到关于当前文档、API、SDK 或技术规范的知识缺口
- 需要最新信息以完成任务时

**委托工作流程**:
1. **创建提示**: 使用模板创建完整的研究上下文
2. **用户打开会话**: 用户启动新的 Ad-Hoc Research 聊天并粘贴提示
3. **研究者工作**: Ad-Hoc 代理调查来源并提供当前信息/发现
4. **用户返回**: 用户将发现带回 Implementation Agent 进行集成

**研究执行要求**:
- **强制工具使用**: 必须使用网络搜索和网络获取工具访问当前官方文档
- **当前信息标准**: 所有发现必须来自官方文档、GitHub 仓库或权威来源
- **验证协议**: 交叉引用多个当前来源以确保信息的准确性和时效性

**重新委托决策框架**:
- **信息充足**: 关闭委托会话，使用研究发现继续任务完成
- **信息不足**: 使用 Ad-Hoc 发现优化提示并重新委托
- **会话关闭标准**: 成功找到信息、资源限制（3-4 次尝试后）、升级到 Manager Agent

**使用场景**:
- 需要研究最新文档或 API 规范时
- 遇到知识缺口需要补充信息时

---

#### 8. `apm-8-delegate-debug.md` - 调试任务委托指南
**优先级**: 8  
**作用**: 提供将复杂调试任务委托给 Ad-Hoc 代理的模板

**委托场景**:
- 遇到重大错误（> 2 次交换或立即复杂/系统性问题）
- 在任务分配提示中明确定义时

**委托工作流程**:
1. **创建提示**: 使用模板创建完整的调试上下文和错误详情
2. **用户打开会话**: 用户启动新的 Ad-Hoc Debug 聊天并粘贴提示
3. **调试者工作**: Ad-Hoc 代理实际调试并解决问题，根据需要与用户协作
4. **用户返回**: 用户将工作解决方案带回 Implementation Agent 以继续任务

**调试执行要求**:
- **强制终端执行**: 使用终端访问执行提供的重现步骤
- **工具使用协议**: 使用终端和文件系统访问重现问题
- **主动调试**: 使用可用工具和命令主动调试
- **需要时协作**: 仅在重现尝试因环境限制失败时请求用户协助

**重新委托决策框架**:
- **错误已解决**: 关闭委托会话，使用提供的解决方案继续任务完成
- **错误部分解决**: 如果修复不完整，使用新发现优化提示并重新委托
- **错误无法解决**: 停止任务执行并升级到 Manager Agent

**升级协议**:
- 当 Ad-Hoc Debug 代理返回表明无法解决的错误时：
  - 立即停止任务执行
  - 保留调试上下文以供未来解决尝试
  - 在记忆日志中记录技术阻塞和上下文
  - 用户向 Manager Agent 报告以重新分配任务、修改计划或技术升级

**使用场景**:
- 遇到复杂或系统性问题需要专门调试时
- 本地调试尝试失败后需要外部帮助时

---

## 命令使用流程

### 典型项目生命周期

```
1. Setup Agent (apm-1-initiate-setup.md)
   ↓
   创建实施计划和记忆根文件
   ↓
2. Manager Agent (apm-2-initiate-manager.md)
   ↓
   分配任务给 Implementation Agent
   ↓
3. Implementation Agent (apm-3-initiate-implementation.md)
   ↓
   执行任务（可能需要委托）
   ↓
   ├─→ Ad-Hoc Research (apm-7-delegate-research.md)
   └─→ Ad-Hoc Debug (apm-8-delegate-debug.md)
   ↓
   完成任务并记录到记忆系统
   ↓
4. Manager Agent 审查并分配下一个任务
   ↓
   （重复步骤 2-4 直到项目完成）
   ↓
5. 当接近上下文限制时：
   ├─→ Manager Handover (apm-5-handover-manager.md)
   └─→ Implementation Handover (apm-6-handover-implementation.md)
```

## 注意事项

1. **命令优先级**: 数字越小，优先级越高
2. **上下文隔离**: Ad-Hoc 代理在独立会话中运行，无法访问 APM 工件
3. **交接时机**: 仅在完整任务周期完成后才能执行交接
4. **委托协议**: 遵循严格的错误处理和调试委托协议
5. **记忆系统**: 所有工作必须记录在指定的记忆日志中

## 相关文档

- APM 指南目录: `.apm/guides/`
- 实施计划: `.apm/Implementation_Plan.md`
- 记忆根文件: `.apm/Memory/Memory_Root.md`
- 记忆日志: `.apm/Memory/Phase_XX_<slug>/`

---

**版本**: APM 0.5.1  
**最后更新**: 2024
