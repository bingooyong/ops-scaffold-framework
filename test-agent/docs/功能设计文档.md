# 测试 Agent 功能设计文档

## 1. 设计目标

基于第三方 Agent 特征分析，设计测试 Agent 的最小功能集，确保能够：
- 演示 Daemon 的多 Agent 管理能力
- 模拟真实 Agent 的核心行为特征
- 保持轻量级，易于部署和测试

## 2. 核心功能清单（最小功能集）

### 2.1 必需功能（P0 - 必须实现）

#### 功能 1: 独立进程启动/停止
**描述**: 作为独立守护进程启动和运行，支持优雅退出。

**技术实现方案**:
- **启动**: 使用 `main.go` 作为入口，解析命令行参数（`-config` 配置文件路径）
- **优雅退出**: 监听 `SIGTERM`/`SIGINT` 信号，接收到信号后：
  1. 停止心跳上报 goroutine
  2. 发送最后一次心跳（status="stopping"）
  3. 关闭 HTTP 服务器
  4. 清理资源后退出
- **信号处理**: 使用 `os/signal` 包的 `signal.Notify()` 监听信号

**依赖关系**: 无（基础功能）

**实现优先级**: P0

---

#### 功能 2: 配置文件读取
**描述**: 支持 YAML 配置文件，读取 Agent 配置信息。

**技术实现方案**:
- **配置库**: 使用 `github.com/spf13/viper` 读取 YAML 配置
- **配置结构**: 定义 `Config` 结构体，包含以下字段：
  ```go
  type Config struct {
      AgentID          string        `mapstructure:"agent_id"`
      HeartbeatURL     string        `mapstructure:"heartbeat_url"`
      HeartbeatInterval time.Duration `mapstructure:"heartbeat_interval"`
      HTTPPort         int           `mapstructure:"http_port"`
      LogLevel         string        `mapstructure:"log_level"`
      LogFile          string        `mapstructure:"log_file"`
  }
  ```
- **配置验证**: 启动时验证必需字段（agent_id、heartbeat_url）
- **默认值**: 提供合理的默认值（如 heartbeat_interval=30s, http_port=8081）

**依赖关系**: 无（基础功能）

**实现优先级**: P0

---

#### 功能 3: 定时心跳上报
**描述**: 定期向 Daemon 发送心跳数据，包含 Agent 状态和资源使用情况。

**技术实现方案**:
- **定时器**: 使用 `time.Ticker` 实现定时心跳（默认 30 秒间隔）
- **HTTP 客户端**: 使用 `net/http` 包的 `http.Post()` 发送心跳
- **心跳数据**: 使用 `gopsutil/v3/process` 采集当前进程的 CPU、内存使用情况
- **心跳格式**: JSON 格式，包含以下字段：
  - `agent_id`: Agent 唯一标识
  - `pid`: 进程 PID
  - `status`: 运行状态（"running"/"stopping"/"error"）
  - `cpu`: CPU 使用率（%）
  - `memory`: 内存占用（字节）
  - `timestamp`: 心跳时间戳（ISO 8601 格式）
- **错误处理**: 心跳失败时记录日志，但不中断 Agent 运行
- **重试机制**: 心跳失败时，下次定时器触发时自动重试

**依赖关系**: 
- 依赖功能 2（配置读取，获取 heartbeat_url）
- 依赖功能 5（资源采集，获取 CPU/Memory）

**实现优先级**: P0

---

#### 功能 4: HTTP Health Check 接口
**描述**: 提供 HTTP API 端点用于健康检查。

**技术实现方案**:
- **HTTP 框架**: 使用 `github.com/gin-gonic/gin` 创建 HTTP 服务器
- **端点**: `GET /health`
- **响应格式**: JSON
  ```json
  {
    "status": "healthy",
    "uptime": 3600,
    "last_heartbeat": "2025-12-05T10:00:00Z",
    "agent_id": "test-agent-001"
  }
  ```
- **状态判断**: 
  - `status`: "healthy"（正常运行）或 "unhealthy"（心跳失败超过阈值）
  - `uptime`: 运行时长（秒）
  - `last_heartbeat`: 最后一次心跳时间

**依赖关系**: 
- 依赖功能 3（心跳上报，用于判断健康状态）

**实现优先级**: P0

---

#### 功能 5: 优雅退出
**描述**: 正确处理退出信号，清理资源后退出。

**技术实现方案**:
- **信号监听**: 使用 `os/signal` 监听 `SIGTERM`、`SIGINT`
- **退出流程**:
  1. 接收到信号后，设置退出标志
  2. 停止心跳上报 goroutine（通过 context 取消）
  3. 发送最后一次心跳（status="stopping"）
  4. 关闭 HTTP 服务器（使用 `context.WithTimeout` 设置超时）
  5. 清理资源（关闭日志文件、清理临时文件等）
  6. 退出进程
- **超时保护**: 如果清理过程超过 10 秒，强制退出

**依赖关系**: 
- 依赖功能 3（心跳上报，发送最后一次心跳）

**实现优先级**: P0

---

### 2.2 推荐功能（P1 - 建议实现）

#### 功能 6: 结构化日志输出
**描述**: 输出 JSON 格式日志，便于调试和监控。

**技术实现方案**:
- **日志库**: 使用 `go.uber.org/zap` 或 `github.com/sirupsen/logrus`
- **日志格式**: JSON 格式，包含以下字段：
  - `timestamp`: 时间戳
  - `level`: 日志级别（debug/info/warn/error）
  - `message`: 日志消息
  - `agent_id`: Agent ID
  - `fields`: 额外字段（如 pid、error 等）
- **日志输出**: 支持输出到文件（`log_file`）和 stdout
- **日志级别**: 可配置（debug/info/warn/error），默认 info

**依赖关系**: 无

**实现优先级**: P1

---

#### 功能 7: 配置热重载
**描述**: 提供 HTTP API 端点支持配置重载，无需重启进程。

**技术实现方案**:
- **端点**: `POST /reload`
- **实现逻辑**:
  1. 重新读取配置文件
  2. 验证配置有效性
  3. 更新运行时配置（如 heartbeat_interval）
  4. 重启心跳定时器（如果 interval 改变）
  5. 返回重载结果
- **响应格式**: JSON
  ```json
  {
    "success": true,
    "message": "config reloaded successfully",
    "reloaded_at": "2025-12-05T10:00:00Z"
  }
  ```
- **线程安全**: 使用 `sync.RWMutex` 保护配置访问

**依赖关系**: 
- 依赖功能 2（配置读取）

**实现优先级**: P1

---

#### 功能 8: 指标暴露
**描述**: 提供 HTTP API 端点暴露 Agent 自身指标数据。

**技术实现方案**:
- **端点**: `GET /metrics`
- **响应格式**: JSON（或 Prometheus 格式，可选）
  ```json
  {
    "agent_id": "test-agent-001",
    "uptime": 3600,
    "heartbeat_count": 120,
    "heartbeat_failures": 2,
    "last_heartbeat": "2025-12-05T10:00:00Z",
    "cpu_percent": 2.5,
    "memory_bytes": 10240000,
    "status": "running"
  }
  ```
- **指标采集**: 使用 `gopsutil` 采集当前进程资源使用情况
- **统计信息**: 记录心跳成功/失败次数、运行时长等

**依赖关系**: 
- 依赖功能 3（心跳上报，用于统计）

**实现优先级**: P1

---

### 2.3 可选功能（P2 - 可选实现）

#### 功能 9: 资源使用采集
**描述**: 使用 gopsutil 采集当前进程的 CPU、内存使用情况。

**技术实现方案**:
- **库**: `github.com/shirou/gopsutil/v3/process`
- **采集指标**:
  - CPU 使用率（%）：`process.CPUPercent()`
  - 内存占用（字节）：`process.MemoryInfo().RSS`
- **采集频率**: 与心跳间隔同步（每次心跳时采集）
- **错误处理**: 采集失败时使用默认值（0）或上次值

**依赖关系**: 无

**实现优先级**: P2（实际上已包含在功能 3 中）

---

#### 功能 10: 状态文件
**描述**: 可选的状态文件记录，用于故障恢复。

**技术实现方案**:
- **状态文件路径**: `{work_dir}/test-agent.state`
- **状态内容**: JSON 格式，包含 Agent ID、最后心跳时间、运行状态
- **更新频率**: 每次心跳成功后更新
- **用途**: 进程异常退出后，重启时读取状态文件恢复信息

**依赖关系**: 无

**实现优先级**: P2（可选）

---

## 3. 目录结构设计

```
test-agent/
├── cmd/
│   └── test-agent/
│       └── main.go              # 入口文件：解析命令行参数，初始化日志，启动主循环
├── internal/
│   ├── config/
│   │   ├── config.go            # 配置结构定义和加载逻辑
│   │   └── config_test.go       # 配置测试
│   ├── heartbeat/
│   │   ├── heartbeat.go         # 心跳上报逻辑：定时器、HTTP 客户端、数据采集
│   │   └── heartbeat_test.go    # 心跳测试
│   ├── api/
│   │   ├── server.go             # HTTP 服务器：Gin 路由、中间件
│   │   ├── handlers.go          # HTTP 处理器：/health, /reload, /metrics
│   │   └── handlers_test.go     # API 测试
│   └── logger/
│       └── logger.go             # 日志初始化：zap 配置
├── configs/
│   └── test-agent.yaml          # 示例配置文件
├── go.mod                        # Go 模块定义
├── go.sum                        # 依赖校验和
├── Makefile                      # 构建脚本：build, test, run, clean
├── README.md                     # 使用说明
└── docs/
    ├── 第三方Agent特征分析.md    # 步骤 1 输出
    ├── 功能设计文档.md            # 步骤 2 输出（本文档）
    └── DESIGN.md                 # 完整设计文档（步骤 4 整合）
```

### 目录说明

- **cmd/test-agent/**: 可执行程序入口，符合 Go 项目标准布局
- **internal/**: 内部包，不对外暴露
  - **config/**: 配置管理，使用 Viper
  - **heartbeat/**: 心跳机制，包含定时器和 HTTP 客户端
  - **api/**: HTTP API 服务器和处理器
  - **logger/**: 日志初始化
- **configs/**: 配置文件目录
- **docs/**: 文档目录

---

## 4. 功能实现优先级和依赖关系

### 4.1 实现优先级

| 优先级 | 功能 | 说明 |
|-------|------|------|
| **P0** | 功能 1-5 | 必需功能，必须全部实现才能演示 Daemon 管理能力 |
| **P1** | 功能 6-8 | 推荐功能，提升可用性和可观测性 |
| **P2** | 功能 9-10 | 可选功能，根据时间安排决定是否实现 |

### 4.2 依赖关系图

```
功能 1 (启动/停止)
  └─> 无依赖

功能 2 (配置读取)
  └─> 无依赖

功能 5 (优雅退出)
  └─> 功能 1 (启动/停止)
  └─> 功能 3 (心跳上报)

功能 3 (心跳上报)
  └─> 功能 2 (配置读取)
  └─> 功能 9 (资源采集) [可选]

功能 4 (HTTP Health Check)
  └─> 功能 3 (心跳上报)

功能 6 (结构化日志)
  └─> 无依赖（但被其他功能使用）

功能 7 (配置热重载)
  └─> 功能 2 (配置读取)

功能 8 (指标暴露)
  └─> 功能 3 (心跳上报)
  └─> 功能 9 (资源采集) [可选]
```

### 4.3 实现顺序建议

**第一阶段（P0 功能）**:
1. 功能 2: 配置读取（基础）
2. 功能 6: 结构化日志（基础，其他功能需要）
3. 功能 1: 启动/停止（基础）
4. 功能 9: 资源采集（心跳需要）
5. 功能 3: 心跳上报（核心功能）
6. 功能 4: HTTP Health Check（健康检查）
7. 功能 5: 优雅退出（完善）

**第二阶段（P1 功能）**:
8. 功能 7: 配置热重载
9. 功能 8: 指标暴露

**第三阶段（P2 功能，可选）**:
10. 功能 10: 状态文件

---

## 5. 技术选型总结

| 功能模块 | 技术选型 | 理由 |
|---------|---------|------|
| **配置管理** | Viper | Go 生态最流行的配置库，支持多种格式 |
| **HTTP 框架** | Gin | 轻量级、高性能，API 简洁 |
| **日志库** | zap | 高性能结构化日志，JSON 输出 |
| **资源采集** | gopsutil | 跨平台进程和系统信息采集 |
| **信号处理** | os/signal | Go 标准库，无需额外依赖 |

---

## 6. 配置文件示例

```yaml
# test-agent.yaml
agent_id: "test-agent-001"
heartbeat_url: "http://localhost:8080/heartbeat"  # Daemon 心跳接收端点
heartbeat_interval: 30s                           # 心跳间隔
http_port: 8081                                   # Agent HTTP API 端口
log_level: "info"                                # 日志级别: debug/info/warn/error
log_file: "/var/log/test-agent/test-agent.log"   # 日志文件路径（可选，留空输出到 stdout）
```

---

**文档完成时间**：2025-01-XX  
**下一步**：定义心跳数据格式和接口规范（步骤 3）
