# 测试 Agent 接口规范文档

## 1. 概述

本文档定义测试 Agent 与 Daemon 之间的通信协议，以及测试 Agent 自身提供的 HTTP API 规范。

## 2. 心跳数据格式

### 2.1 心跳数据结构（JSON）

测试 Agent 向 Daemon 发送的心跳数据采用 JSON 格式，结构如下：

```json
{
  "agent_id": "test-agent-001",
  "pid": 12345,
  "status": "running",
  "cpu": 5.0,
  "memory": 102400,
  "timestamp": "2025-12-05T10:00:00Z"
}
```

### 2.2 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| `agent_id` | string | 是 | Agent 唯一标识符，必须与配置文件中的 `agent_id` 一致 |
| `pid` | int | 是 | Agent 进程 PID（Process ID），用于 Daemon 验证进程存在性 |
| `status` | string | 是 | Agent 运行状态，枚举值：<br>- `"running"`: 正常运行<br>- `"stopping"`: 正在停止（优雅退出时发送）<br>- `"error"`: 错误状态（发生异常时发送） |
| `cpu` | float | 否 | CPU 使用率（百分比），范围 0-100，使用 `gopsutil` 采集当前进程 CPU 使用率 |
| `memory` | int | 否 | 内存占用（字节），使用 `gopsutil` 采集当前进程内存占用（RSS） |
| `timestamp` | string | 是 | 心跳时间戳，ISO 8601 格式（UTC 时区），例如：`"2025-12-05T10:00:00Z"` |

### 2.3 心跳数据示例

**正常运行状态**:
```json
{
  "agent_id": "test-agent-001",
  "pid": 12345,
  "status": "running",
  "cpu": 2.5,
  "memory": 10240000,
  "timestamp": "2025-12-05T10:00:00Z"
}
```

**优雅退出状态**:
```json
{
  "agent_id": "test-agent-001",
  "pid": 12345,
  "status": "stopping",
  "cpu": 0.1,
  "memory": 10240000,
  "timestamp": "2025-12-05T10:05:00Z"
}
```

**错误状态**:
```json
{
  "agent_id": "test-agent-001",
  "pid": 12345,
  "status": "error",
  "cpu": 0.0,
  "memory": 0,
  "timestamp": "2025-12-05T10:06:00Z"
}
```

---

## 3. 心跳 API 规范（测试 Agent → Daemon）

### 3.1 心跳上报端点

**端点**: `POST http://daemon-host:port/heartbeat`

**说明**: 测试 Agent 定期向 Daemon 发送心跳数据，用于 Daemon 监控 Agent 运行状态。

> **注意**: 当前 Daemon 实现使用 Unix Domain Socket 接收心跳。如果 Daemon 尚未提供 HTTP 心跳端点，测试 Agent 可以通过 Unix Socket 发送心跳（使用 JSON-RPC 2.0 格式），或等待 Daemon 添加 HTTP 端点支持。

### 3.2 请求规范

**请求方法**: `POST`

**请求头**:
```
Content-Type: application/json
```

**请求体**: 心跳数据 JSON（见 2.1 节）

**请求示例**:
```bash
curl -X POST http://localhost:8080/heartbeat \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "test-agent-001",
    "pid": 12345,
    "status": "running",
    "cpu": 2.5,
    "memory": 10240000,
    "timestamp": "2025-12-05T10:00:00Z"
  }'
```

### 3.3 响应规范

#### 成功响应

**HTTP 状态码**: `200 OK`

**响应体**:
```json
{
  "message": "heartbeat received"
}
```

**响应示例**:
```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "message": "heartbeat received"
}
```

#### 失败响应

**HTTP 状态码**: `400 Bad Request`（请求格式错误）

**响应体**:
```json
{
  "error": "invalid agent_id"
}
```

**常见错误码**:
- `400 Bad Request`: 请求格式错误（如缺少必需字段、字段类型错误）
- `404 Not Found`: 端点不存在（Daemon 未启用 HTTP 心跳接收）
- `500 Internal Server Error`: Daemon 内部错误

**错误响应示例**:
```json
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "error": "invalid agent_id: agent_id is required"
}
```

### 3.4 心跳发送频率

- **默认间隔**: 30 秒（可通过配置文件 `heartbeat_interval` 调整）
- **发送时机**: 使用 `time.Ticker` 定时触发
- **失败重试**: 心跳发送失败时，记录日志但不中断 Agent 运行，下次定时器触发时自动重试

---

## 4. 测试 Agent HTTP API 规范

测试 Agent 提供以下 HTTP API 端点，用于健康检查、配置重载和指标查询。

### 4.1 健康检查接口

#### 4.1.1 端点信息

**端点**: `GET /health`

**说明**: 返回 Agent 健康状态，用于 Daemon 或其他监控系统检查 Agent 是否正常运行。

#### 4.1.2 请求规范

**请求方法**: `GET`

**请求头**: 无特殊要求

**请求示例**:
```bash
curl http://localhost:8081/health
```

#### 4.1.3 响应规范

**HTTP 状态码**: 
- `200 OK`: Agent 正常运行
- `503 Service Unavailable`: Agent 不健康（心跳失败超过阈值）

**响应体**:
```json
{
  "status": "healthy",
  "uptime": 3600,
  "last_heartbeat": "2025-12-05T10:00:00Z",
  "agent_id": "test-agent-001"
}
```

**字段说明**:
- `status`: 健康状态，`"healthy"` 或 `"unhealthy"`
- `uptime`: Agent 运行时长（秒）
- `last_heartbeat`: 最后一次心跳时间（ISO 8601 格式）
- `agent_id`: Agent 唯一标识

**响应示例**:
```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "status": "healthy",
  "uptime": 3600,
  "last_heartbeat": "2025-12-05T10:00:00Z",
  "agent_id": "test-agent-001"
}
```

---

### 4.2 配置重载接口

#### 4.2.1 端点信息

**端点**: `POST /reload`

**说明**: 触发配置文件重新加载，无需重启 Agent 进程。适用于修改心跳间隔等配置项。

#### 4.2.2 请求规范

**请求方法**: `POST`

**请求头**: 无特殊要求（可选 `Content-Type: application/json`）

**请求体**: 空（或包含配置文件的 JSON，如果支持动态配置）

**请求示例**:
```bash
curl -X POST http://localhost:8081/reload
```

#### 4.2.3 响应规范

**HTTP 状态码**: 
- `200 OK`: 重载成功
- `400 Bad Request`: 配置文件无效
- `500 Internal Server Error`: 重载失败

**响应体**:
```json
{
  "success": true,
  "message": "config reloaded successfully",
  "reloaded_at": "2025-12-05T10:00:00Z"
}
```

**字段说明**:
- `success`: 重载是否成功
- `message`: 重载结果消息
- `reloaded_at`: 重载时间（ISO 8601 格式）

**成功响应示例**:
```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "message": "config reloaded successfully",
  "reloaded_at": "2025-12-05T10:00:00Z"
}
```

**失败响应示例**:
```json
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "success": false,
  "message": "invalid config: heartbeat_interval must be greater than 0",
  "reloaded_at": "2025-12-05T10:00:00Z"
}
```

---

### 4.3 指标暴露接口

#### 4.3.1 端点信息

**端点**: `GET /metrics`

**说明**: 返回 Agent 自身的指标数据，包括运行状态、资源使用、心跳统计等。

#### 4.3.2 请求规范

**请求方法**: `GET`

**请求头**: 无特殊要求

**请求示例**:
```bash
curl http://localhost:8081/metrics
```

#### 4.3.3 响应规范

**HTTP 状态码**: `200 OK`

**响应体**:
```json
{
  "agent_id": "test-agent-001",
  "uptime": 3600,
  "heartbeat_count": 120,
  "heartbeat_failures": 2,
  "last_heartbeat": "2025-12-05T10:00:00Z",
  "cpu_percent": 2.5,
  "memory_bytes": 10240000,
  "status": "running"
}
```

**字段说明**:
- `agent_id`: Agent 唯一标识
- `uptime`: Agent 运行时长（秒）
- `heartbeat_count`: 心跳成功次数
- `heartbeat_failures`: 心跳失败次数
- `last_heartbeat`: 最后一次心跳时间
- `cpu_percent`: 当前 CPU 使用率（%）
- `memory_bytes`: 当前内存占用（字节）
- `status`: Agent 运行状态（"running"/"stopping"/"error"）

**响应示例**:
```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "agent_id": "test-agent-001",
  "uptime": 3600,
  "heartbeat_count": 120,
  "heartbeat_failures": 2,
  "last_heartbeat": "2025-12-05T10:00:00Z",
  "cpu_percent": 2.5,
  "memory_bytes": 10240000,
  "status": "running"
}
```

---

## 5. 错误处理规范

### 5.1 通用错误响应格式

所有 API 错误响应采用统一的 JSON 格式：

```json
{
  "error": "error message",
  "code": "ERROR_CODE"
}
```

### 5.2 常见错误码

| 错误码 | HTTP 状态码 | 说明 |
|-------|------------|------|
| `INVALID_REQUEST` | 400 | 请求格式错误 |
| `INVALID_AGENT_ID` | 400 | Agent ID 无效或缺失 |
| `CONFIG_ERROR` | 400 | 配置文件错误 |
| `NOT_FOUND` | 404 | 端点不存在 |
| `INTERNAL_ERROR` | 500 | 服务器内部错误 |

---

## 6. 通信协议总结

### 6.1 测试 Agent → Daemon

| 协议 | 端点 | 方法 | 说明 |
|------|------|------|------|
| HTTP | `/heartbeat` | POST | 心跳上报（如果 Daemon 支持 HTTP） |
| Unix Socket | `socket_path` | JSON-RPC | 心跳上报（如果 Daemon 仅支持 Socket） |

### 6.2 外部 → 测试 Agent

| 端点 | 方法 | 说明 |
|------|------|------|
| `/health` | GET | 健康检查 |
| `/reload` | POST | 配置重载 |
| `/metrics` | GET | 指标查询 |

---

## 7. 实现注意事项

1. **心跳发送**: 使用 `time.Ticker` 实现定时心跳，确保心跳间隔可配置
2. **资源采集**: 使用 `gopsutil/v3/process` 采集当前进程的 CPU 和内存使用情况
3. **时间格式**: 所有时间戳使用 ISO 8601 格式（UTC 时区）
4. **错误处理**: 心跳失败不应中断 Agent 运行，仅记录日志
5. **线程安全**: 配置重载和指标查询需要保证线程安全（使用 `sync.RWMutex`）
6. **HTTP 服务器**: 使用 Gin 框架创建 HTTP 服务器，默认监听端口 8081

---

**文档完成时间**：2025-01-XX  
**下一步**：整合所有设计文档，编写完整的测试 Agent 架构设计文档（步骤 4）
